# 08. AI 비용 최적화 (AI Cost Optimization)

**작성일**: 2026-01-31
**버전**: 1.0
**목적**: OpenAI API 비용을 50-70% 절감하는 구체적 전략

---

## 목차

1. [현재 AI 비용 분석](#1-현재-ai-비용-분석)
2. [최적화 전략](#2-최적화-전략)
3. [구현 로드맵](#3-구현-로드맵)
4. [예상 절감액](#4-예상-절감액)

---

## 1. 현재 AI 비용 분석

### 1.1 비용 추정 (10,000 DAU 기준)

**가정**:
- 사용자당 일평균 2회 AI 요청
- 요청당 평균 3,000 입력 토큰 + 1,000 출력 토큰

**현재 비용 (GPT-4o)**:
```
입력: 10,000 × 2 × 3,000 = 60M 토큰/일
출력: 10,000 × 2 × 1,000 = 20M 토큰/일

GPT-4o 가격:
- 입력: $5/1M 토큰
- 출력: $15/1M 토큰

일일 비용: (60 × $5) + (20 × $15) = $600/일
월간 비용: $18,000/월
```

### 1.2 기능별 비용 분해

| 기능 | 월간 요청 | 평균 토큰 | 월 비용 | 비율 |
|------|----------|----------|--------|------|
| 사주 분석 | 200,000 | 4,000 | $7,200 | 40% |
| 점성술 분석 | 150,000 | 3,500 | $5,250 | 29% |
| 타로 리딩 | 100,000 | 3,000 | $3,000 | 17% |
| Destiny Match | 80,000 | 3,500 | $2,550 | 14% |
| **총계** | **530,000** | - | **$18,000** | 100% |

---

## 2. 최적화 전략

### 2.1 프롬프트 캐싱 (Prompt Caching)

**OpenAI Prompt Caching API 활용**

**원리**:
- 시스템 메시지 재사용 시 50% 비용 절감
- 캐시 유효 기간: 5분

**구현**:
```typescript
const response = await openai.chat.completions.create({
  model: "gpt-4o",
  messages: [
    {
      role: "system",
      content: SAJU_SYSTEM_PROMPT, // 캐시됨
    },
    {
      role: "user",
      content: userQuery,
    },
  ],
  // Prompt caching 활성화
  cache_control: {
    type: "ephemeral",
  },
});
```

**예상 절감**:
- 시스템 메시지: 평균 1,500 토큰
- 절감율: 50% (시스템 메시지 부분)
- **월간 절감: $4,500 (25%)**

---

### 2.2 응답 캐싱 (Response Caching)

**Redis 기반 응답 캐시**

**원리**:
- 동일 생년월일 + 날짜 → 동일 응답 재사용
- TTL: 7일

**구현**:
```typescript
async function getCachedAIResponse(
  birthDate: string,
  queryType: string,
  date: string
): Promise<string | null> {
  const cacheKey = `ai:${queryType}:${birthDate}:${date}`;
  const cached = await redis.get(cacheKey);

  if (cached) {
    return JSON.parse(cached);
  }

  // AI 호출
  const response = await callOpenAI(...);

  // 캐시 저장 (7일)
  await redis.set(cacheKey, JSON.stringify(response), {
    ex: 60 * 60 * 24 * 7,
  });

  return response;
}
```

**예상 절감**:
- 캐시 히트율: 30% (동일 생년월일 많음)
- **월간 절감: $5,400 (30%)**

---

### 2.3 모델 다운그레이드 (Model Mix Strategy)

**중요도 낮은 기능에 GPT-4o-mini 사용**

**비용 비교**:
```
GPT-4o:
- 입력: $5/1M 토큰
- 출력: $15/1M 토큰

GPT-4o-mini:
- 입력: $0.15/1M 토큰 (97% 저렴)
- 출력: $0.60/1M 토큰 (96% 저렴)
```

**적용 기능**:

| 기능 | 모델 | 이유 |
|------|------|------|
| 사주 분석 | GPT-4o | 높은 정확도 필요 |
| 점성술 분석 | GPT-4o | 복잡한 계산 |
| **타로 리딩** | **GPT-4o-mini** | 패턴 인식 중심 |
| **일일 운세** | **GPT-4o-mini** | 간단한 조언 |
| **Destiny Match** | **GPT-4o-mini** | 궁합 점수 계산 |

**예상 절감**:
- 다운그레이드 비율: 40%
- **월간 절감: $6,912 (38%)**

---

### 2.4 배치 처리 (Batch API)

**OpenAI Batch API 활용**

**원리**:
- 여러 요청을 배치로 묶어 처리
- 50% 비용 절감 (처리 시간 24시간 이내)

**적용 기능**:
- 주간/월간 운세 (시간 민감하지 않음)
- 백그라운드 분석 작업

**구현**:
```typescript
// 배치 작업 생성
const batch = await openai.batches.create({
  input_file_id: fileId,
  endpoint: "/v1/chat/completions",
  completion_window: "24h",
});
```

**예상 절감**:
- 배치 적용 비율: 20%
- **월간 절감: $1,800 (10%)**

---

### 2.5 프롬프트 최적화

**토큰 수 줄이기**

**Before** (3,000 토큰):
```
당신은 사주명리 전문가입니다. 사용자의 생년월일시를 바탕으로...
(500 단어 시스템 프롬프트)

사용자 사주:
- 년주: 甲子 (상세 설명 300자)
- 월주: 乙丑 (상세 설명 300자)
...
```

**After** (2,000 토큰):
```
사주 전문가. 간결하게 분석.

사주: 甲子 乙丑 丙寅 丁卯
대운: 30대 (현재)
질문: {query}
```

**예상 절감**:
- 토큰 감소: 33%
- **월간 절감: $2,970 (17%)**

---

## 3. 구현 로드맵

### 3.1 Phase 1: Quick Wins (1-2주)

**우선순위 높음, 구현 쉬움**

- [x] 응답 캐싱 (Redis) - 절감 30%
- [x] 모델 다운그레이드 (타로, 운세) - 절감 38%
- [x] 프롬프트 최적화 - 절감 17%

**예상 총 절감**: 약 50%

---

### 3.2 Phase 2: Advanced (1개월)

**우선순위 중간, 구현 복잡**

- [ ] 프롬프트 캐싱 API 통합 - 절감 25%
- [ ] 배치 처리 시스템 구축 - 절감 10%

**예상 총 절감**: 약 70%

---

### 3.3 Phase 3: Custom AI (Year 2-3)

**우선순위 낮음, 구현 매우 복잡**

- [ ] 점술 특화 LLM fine-tuning
  - 100만+ 리딩 데이터 학습
  - GPT-4o 대비 정확도 +15%
  - 비용 -70% (자체 호스팅)

**예상 총 절감**: 약 85-90%

---

## 4. 예상 절감액

### 4.1 단계별 절감액 (10k DAU 기준)

| Phase | 전략 | 월 비용 | 절감액 | 절감율 |
|-------|------|--------|-------|--------|
| **현재** | - | $18,000 | - | - |
| **Phase 1** | 캐싱 + 다운그레이드 + 최적화 | $9,000 | $9,000 | 50% |
| **Phase 2** | + 프롬프트 캐싱 + 배치 | $5,400 | $12,600 | 70% |
| **Phase 3** | + 독자 AI 모델 | $1,800 | $16,200 | 90% |

---

### 4.2 스케일별 비용 예측

| DAU | Phase 1 | Phase 2 | Phase 3 |
|-----|---------|---------|---------|
| 10k | $9,000 | $5,400 | $1,800 |
| 50k | $45,000 | $27,000 | $9,000 |
| 100k | $90,000 | $54,000 | $18,000 |
| 500k | $450,000 | $270,000 | $90,000 |
| 1M | $900,000 | $540,000 | $180,000 |

**인사이트**:
- Phase 1-2만으로도 70% 절감 가능
- 100k DAU 시 Phase 2 필수 (월 $54k)
- 500k DAU 이상 시 독자 AI 모델 개발 ROI 높음

---

## 5. 구현 체크리스트

### Phase 1 (Quick Wins)

**응답 캐싱**:
- [ ] Redis 캐시 키 설계
- [ ] TTL 설정 (7일)
- [ ] 캐시 무효화 로직
- [ ] 모니터링 대시보드

**모델 다운그레이드**:
- [ ] 기능별 모델 분류
- [ ] GPT-4o-mini 테스트
- [ ] 품질 검증 (A/B 테스트)
- [ ] 점진적 롤아웃

**프롬프트 최적화**:
- [ ] 현재 프롬프트 토큰 수 측정
- [ ] 불필요한 컨텍스트 제거
- [ ] 간결화 (500 → 300 단어)
- [ ] 정확도 테스트

---

### Phase 2 (Advanced)

**프롬프트 캐싱**:
- [ ] OpenAI Prompt Caching API 연동
- [ ] 캐시 전략 설계
- [ ] 성능 모니터링

**배치 처리**:
- [ ] 배치 작업 큐 구축 (BullMQ)
- [ ] 배치 API 통합
- [ ] 스케줄링 시스템

---

### Phase 3 (Custom AI)

**독자 AI 모델**:
- [ ] 리딩 데이터 수집 (100만+)
- [ ] 데이터 전처리 및 레이블링
- [ ] LLM fine-tuning (GPT-4o 또는 Llama)
- [ ] 성능 벤치마크
- [ ] 프로덕션 배포

---

## 6. 모니터링 및 최적화

### 6.1 핵심 지표

**일일 모니터링**:
```
📊 AI Cost Dashboard (2026-01-31)

총 요청: 20,000
총 토큰: 80M (입력 60M + 출력 20M)
총 비용: $600

캐시 히트율: 28%
평균 응답 시간: 2.3초

모델 분포:
- GPT-4o: 60% ($360)
- GPT-4o-mini: 40% ($24)
```

### 6.2 비용 알림

**슬랙 알림 설정**:
```typescript
// 일일 비용이 $700 초과 시 알림
if (dailyCost > 700) {
  await slack.send({
    channel: "#alerts",
    text: `⚠️ AI 비용 초과: $${dailyCost} (목표: $600)`,
  });
}
```

---

**관련 문서**:
- [06_FINANCIAL_MODEL.md](./06_FINANCIAL_MODEL.md)
- [09_SCALING_INFRASTRUCTURE.md](./09_SCALING_INFRASTRUCTURE.md)
- [10_TECHNICAL_ROADMAP.md](./10_TECHNICAL_ROADMAP.md)
