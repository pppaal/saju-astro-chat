import { buildAllDataPrompt } from "../base";
import { buildTonePrompt } from "../base/toneStyle";
import type { CombinedResult } from "@/lib/destiny-map/astrologyengine";

// Love/Relationship prompt v2.0 - 배우자 성향, 연령대, 만남장소까지 상세 분석
export function buildLovePrompt(lang: string, data: CombinedResult, _useStructured = true) {
  const theme = "love";
  const info = buildAllDataPrompt(lang, theme, data);
  const tone = buildTonePrompt(lang, theme);
  const dateText = data.analysisDate ?? new Date().toISOString().slice(0, 10);
  const tzInfo = data.userTimezone ? ` (${data.userTimezone})` : "";

  // 성별 추출 (배우자성 판단용)
  const gender = data.meta?.gender ?? "unknown";

  return [
    `Date: ${dateText}${tzInfo}`,
    `Locale: ${lang}`,
    `Gender: ${gender}`,
    "",
    "═══════════════════════════════════════════════════════════════",
    "[TASK] 동양+서양 융합 연애/배우자 심층 분석",
    "═══════════════════════════════════════════════════════════════",
    "",
    "당신은 동양 운명학과 서양 점성술을 융합한 최고 수준의 연애/결혼 전문 상담사입니다.",
    "아래 데이터를 교차 분석하여 구체적이고 실용적인 연애/배우자 인사이트를 제공하세요.",
    "",
    "═══════════════════════════════════════════════════════════════",
    "[필수 분석 항목 - 모든 섹션 반드시 포함]",
    "═══════════════════════════════════════════════════════════════",
    "",
    "## 1. 연상/동갑/연하 가능성 분석",
    "- 연상 확률이 높은 근거 (금성 사인, 토성 영향, 관계축 분석)",
    "- 동갑 가능성 (어떤 조건에서)",
    "- 연하 가능성 (어떤 조건에서)",
    "- 체감 연령 차이 범위 제시 (예: 연상 +2~7살 느낌)",
    "근거: 금성 사인(취향), 토성-달 각도(안정성), 7하우스 사인, 배우자 자리 오행",
    "",
    "## 2. 배우자 성향 (어떤 사람?)",
    "- 기본 캐릭터 (7하우스 사인 기반 - 외적 특성)",
    "- 내면 특성 (배우자 자리 오행, 파트너 에너지 기반)",
    "- 관계 포인트 (화성 위치, 어스팩트 기반 - 갈등/조화 패턴)",
    "- 디테일 특성 (Vertex, Juno 기반 - 운명적 특징)",
    "- 주의점 (충돌 가능성, 조율 필요한 부분)",
    "근거: 7하우스 사인+지배성, 금성/화성 사인, 배우자 자리, 파트너 에너지 분포",
    "",
    "## 3. 어디서 만나기 쉬운가",
    "- 가장 유력한 만남 채널 (금성 하우스 기반)",
    "- 보조 채널들",
    "- 상대의 특성과 연결 (예: 일/성과 중심 vs 취미/여가 중심)",
    "근거: 금성 하우스(11H=친구소개, 6H=직장, 9H=해외/학업, 5H=취미/앱)",
    "",
    "## 4. 결혼/연애 시기 분석 ⭐ 중요",
    "- 현재 연애운 흐름 (장기/연간 흐름 기반)",
    "- 구체적인 좋은 시기 (예: 2026년 3월~5월, 2027년 하반기 등)",
    "- 주의 시기 (피해야 할 기간)",
    "- 시기 판단 근거를 명확히 제시",
    "⚠️ 반드시 '미래 예측용 운세 데이터' 섹션의 연간/월간 데이터를 활용하여 구체적 연도/월 제시",
    "근거: 장기 흐름, 연간/월간 운세(향후 5년), 금성/목성 트랜짓, 연애 에너지 활성화 시기",
    "",
    "## 5. 현재 연애 조언",
    "- 한줄요약: 현재 분위기 + 핵심 기회/주의",
    "- 타이밍: 좋은 시간/요일, 피할 타이밍",
    "- 소통 팁: 2~3개",
    "- 행동 가이드: 이번주 할 일",
    "",
    "## 6. 교차 하이라이트",
    "동양+서양 교차 포인트 최소 3개:",
    "- 배우자 자리 오행 ↔ 7하우스 사인 연결",
    "- 파트너 에너지 ↔ 금성/화성 배치 연결",
    "- 장기/연간 흐름 ↔ 트랜짓 연결",
    "",
    "═══════════════════════════════════════════════════════════════",
    "[분석 규칙]",
    "═══════════════════════════════════════════════════════════════",
    "1. 모든 분석에 반드시 근거(동양 요소 또는 점성술 요소) 명시",
    "2. 추상적 표현 금지 - 구체적인 특성/확률/범위 제시",
    "3. 동양과 서양 분석을 별개로 나열하지 말고, 교차 융합하여 분석",
    "4. 과도한 운명론/확정적 예언 금지 - \"가능성이 높다\", \"경향이 있다\" 표현 사용",
    "5. 실용적이고 행동 가능한 조언 포함",
    "",
    "═══════════════════════════════════════════════════════════════",
    "[파트너 에너지 판단 기준]",
    "═══════════════════════════════════════════════════════════════",
    gender === "male" ? "남성: 안정 파트너 에너지, 자유 파트너 에너지 → 여성 배우자 특성" : "",
    gender === "female" ? "여성: 안정 파트너 에너지, 도전 파트너 에너지 → 남성 배우자 특성" : "",
    gender === "unknown" ? "성별 미상: 남성/여성 기준 파트너 에너지 모두 분석" : "",
    "",
    tone,
    "",
    "═══════════════════════════════════════════════════════════════",
    "[분석 데이터]",
    "═══════════════════════════════════════════════════════════════",
    info,
    "",
    `Respond in ${lang}. 반드시 위의 6개 섹션 모두 포함하여 답변하세요.`,
  ].filter(Boolean).join("\n");
}
