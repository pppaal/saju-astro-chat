import { PDFDocument, rgb, StandardFonts } from "pdf-lib";

/**
 * üé® pdfTemplate.js
 * - Ïò§Ìñâ Ïä§ÌéôÌä∏Îüº Í∏∞Î∞ò Ìè¨Ïä§ÌÑ∞Ìòï Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
 * - CombinedResult Í∏∞Î∞ò PDF Î∞îÏù¥Ìä∏ Î∞òÌôò
 */
export async function generateFortunePdf(result) {
  const pdf = await PDFDocument.create();
  const page = pdf.addPage([595, 842]); // A4 ÏÑ∏Î°ú
  const { saju, astrology, summary, interpretation } = result;
  const fiveElements = saju?.facts?.fiveElements ?? {};

  // Ï£ºÏöî Ïò§Ìñâ ÏÉâÏÉÅ Ï∂îÏ∂ú
  const dominantEntry = Object.entries(fiveElements).sort((a, b) => b[1] - a[1])[0];
  const dominant = dominantEntry?.[0] ?? "Earth";
  const elementColors = {
    Wood: rgb(0.4, 0.8, 0.4),
    Fire: rgb(1.0, 0.4, 0.3),
    Earth: rgb(0.98, 0.85, 0.2),
    Metal: rgb(0.7, 0.75, 0.8),
    Water: rgb(0.3, 0.5, 0.9),
  };

  const bgColor = elementColors[dominant];
  page.drawRectangle({ x: 0, y: 0, width: 595, height: 842, color: bgColor });

  const titleFont = await pdf.embedFont(StandardFonts.HelveticaBold);
  const bodyFont = await pdf.embedFont(StandardFonts.Helvetica);

  // Title
  const title = "Destiny Map Report";
  page.drawText(title, {
    x: 50,
    y: 800,
    size: 26,
    font: titleFont,
    color: rgb(1, 1, 1),
  });

  // Sub info
  const sub = `Dominant Element: ${dominant}\n${summary ?? ""}`;
  page.drawText(sub, {
    x: 50,
    y: 770,
    size: 12,
    font: bodyFont,
    color: rgb(1, 1, 1),
    lineHeight: 14,
  });

  // Decorative aura circle
  page.drawEllipse({
    x: 297.5,
    y: 480,
    xScale: 160,
    yScale: 160,
    color: rgb(1, 1, 1),
    opacity: 0.06,
  });

  const text =
    interpretation?.slice(0, 1500) ??
    "Ïö¥ÏÑ∏ Ìï¥ÏÑù ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§. computeDestinyMap() Í≤∞Í≥ºÏùò interpretationÏùÑ Ïó∞Í≤∞ÌïòÏÑ∏Ïöî.";

  // Body
  page.drawText(text, {
    x: 50,
    y: 720 - 180,
    size: 11,
    font: bodyFont,
    color: rgb(1, 1, 1),
    lineHeight: 13,
    maxWidth: 480,
  });

  // Footer
  const footer = `Generated by DestinyMap Unified Engine ‚Ä¢ ${new Date().toLocaleString()}`;
  page.drawText(footer, {
    x: 50,
    y: 30,
    size: 9,
    font: bodyFont,
    color: rgb(1, 1, 1),
    opacity: 0.7,
  });

  const pdfBytes = await pdf.save();
  return pdfBytes;
}