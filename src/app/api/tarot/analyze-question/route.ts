// src/app/api/tarot/analyze-question/route.ts
// GPT-4o-mini를 사용해서 사용자 질문을 분석하고 적절한 스프레드 추천

import { NextRequest, NextResponse } from "next/server";
import { tarotThemes } from "@/lib/Tarot/tarot-spreads-data";

// ============================================================
// OpenAI API 호출 헬퍼
// ============================================================
async function callOpenAI(messages: { role: string; content: string }[], maxTokens = 300) {
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages,
      max_tokens: maxTokens,
      temperature: 0.3,
      response_format: { type: 'json_object' },
    }),
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`OpenAI API error: ${error}`);
  }

  const data = await response.json();
  return data.choices[0]?.message?.content || '';
}

// 스프레드 정보를 GPT에게 전달할 형식으로 변환
function getSpreadOptions() {
  const options: { id: string; themeId: string; title: string; titleKo: string; description: string; cardCount: number }[] = [];

  for (const theme of tarotThemes) {
    for (const spread of theme.spreads) {
      options.push({
        id: spread.id,
        themeId: theme.id,
        title: spread.title,
        titleKo: spread.titleKo || spread.title,
        description: spread.descriptionKo || spread.description,
        cardCount: spread.cardCount,
      });
    }
  }

  return options;
}

// 위험한 질문 체크
const dangerousKeywords = [
  "자살", "죽고 싶", "죽을래", "살기 싫", "끝내고 싶", "죽어버릴",
  "자해", "목숨", "생을 마감", "세상 떠나",
  "suicide", "kill myself", "end my life", "want to die"
];

function checkDangerous(question: string): boolean {
  const normalized = question.toLowerCase();
  return dangerousKeywords.some(kw => normalized.includes(kw.toLowerCase()));
}

// Yes/No 결정 질문 패턴 감지 (GPT 호출 전 사전 체크)
function isYesNoQuestion(question: string): boolean {
  // 1. 어미 패턴 (문장 끝) - 확장
  const endingPatterns = [
    /할까\??$/,       // ~할까?
    /갈까\??$/,       // ~갈까?
    /볼까\??$/,       // ~볼까?
    /살까\??$/,       // ~살까?
    /먹을까\??$/,     // ~먹을까?
    /마실까\??$/,     // ~마실까?
    /할지\??$/,       // ~할지?
    /갈지\??$/,       // ~갈지?
    /해볼까\??$/,     // ~해볼까?
    /할까요\??$/,     // ~할까요?
    /갈까요\??$/,     // ~갈까요?
    /될까\??$/,       // ~될까?
    /을까\??$/,       // ~을까?
    /ㄹ까\??$/,       // ~ㄹ까?
    /나\??$/,         // ~하나? (해야 하나)
    /까요\??$/,       // ~까요?
    /줄까\??$/,       // ~줄까?
    /올까\??$/,       // ~올까?
    /탈까\??$/,       // ~탈까?
    /입을까\??$/,     // ~입을까?
    /신을까\??$/,     // ~신을까?
    /쓸까\??$/,       // ~쓸까?
    /빌릴까\??$/,     // ~빌릴까?
    /들을까\??$/,     // ~들을까?
    /배울까\??$/,     // ~배울까?
    /시킬까\??$/,     // ~시킬까?
    /바꿀까\??$/,     // ~바꿀까?
    /말할까\??$/,     // ~말할까?
    /던질까\??$/,     // ~던질까?
    /끊을까\??$/,     // ~끊을까?
    /참을까\??$/,     // ~참을까?
    /기다릴까\??$/,   // ~기다릴까?
    /뺄까\??$/,       // ~뺄까?
    /넣을까\??$/,     // ~넣을까?
    /보낼까\??$/,     // ~보낼까?
    /받을까\??$/,     // ~받을까?
    /할래\??$/,       // ~할래?
    /갈래\??$/,       // ~갈래?
    /먹을래\??$/,     // ~먹을래?
    /볼래\??$/,       // ~볼래?
    /할건지\??$/,     // ~할건지?
    /갈건지\??$/,     // ~갈건지?
  ];

  // 2. 중간 패턴 (문장 어디서든) - 확장
  const midPatterns = [
    /할까 말까/,      // ~할까 말까
    /해야 하나/,      // ~해야 하나
    /해도 될까/,      // ~해도 될까?
    /하면 될까/,      // ~하면 될까?
    /해야 할까/,      // ~해야 할까?
    /하는 게 좋을까/, // ~하는 게 좋을까?
    /하는게 좋을까/,  // 띄어쓰기 없는 버전
    /해야 되나/,      // ~해야 되나?
    /해야되나/,       // 띄어쓰기 없는 버전
    /해도 되나/,      // ~해도 되나?
    /해도되나/,       // 띄어쓰기 없는 버전
    /할 수 있을까/,   // ~할 수 있을까?
    /할수있을까/,     // 띄어쓰기 없는 버전
    /가야 하나/,      // ~가야 하나?
    /가야하나/,       // 띄어쓰기 없는 버전
    /사야 하나/,      // ~사야 하나?
    /사야하나/,       // 띄어쓰기 없는 버전
    /먹어야 하나/,    // ~먹어야 하나?
    /해 볼까/,        // ~해 볼까?
    /해볼까/,         // 띄어쓰기 없는 버전
    /가 볼까/,        // ~가 볼까?
    /가볼까/,         // 띄어쓰기 없는 버전
    /갈까 말까/,      // ~갈까 말까
    /살까 말까/,      // ~살까 말까
    /볼까 말까/,      // ~볼까 말까
    /먹을까 말까/,    // ~먹을까 말까
    /해야 할지/,      // ~해야 할지
    /가야 할지/,      // ~가야 할지
    /사야 할지/,      // ~사야 할지
    /하면 좋을까/,    // ~하면 좋을까
    /가면 좋을까/,    // ~가면 좋을까
    /해도 괜찮을까/,  // ~해도 괜찮을까
    /해도 괜찮나/,    // ~해도 괜찮나
    /괜찮을까/,       // ~괜찮을까
    /맞을까/,         // ~맞을까
    /좋을까/,         // ~좋을까 (문맥에 따라)
    /나쁠까/,         // ~나쁠까
    /괜찮나/,         // ~괜찮나
    /될지/,           // ~될지
    /안 될까/,        // ~안 될까
    /안될까/,         // 띄어쓰기 없는 버전
    /하지 말까/,      // ~하지 말까
    /가지 말까/,      // ~가지 말까
    /해 말까/,        // ~해 말까
    /어떨까/,         // ~어떨까
    /할 만할까/,      // ~할 만할까
    /가 만할까/,      // ~가 만할까
  ];

  // 3. 키워드 패턴 (특정 단어 포함) - 대폭 확장
  const keywordPatterns = [
    // ===== 운동/건강 =====
    /운동.*(갈까|할까|해야|하나|해볼까)/,   // 운동 갈까?
    /헬스.*(갈까|할까|가야|해볼까)/,        // 헬스 갈까?
    /헬스장.*(갈까|가야|가볼까)/,           // 헬스장 갈까?
    /필라테스.*(갈까|할까|해볼까|시작)/,    // 필라테스 할까?
    /요가.*(갈까|할까|해볼까|시작)/,        // 요가 할까?
    /수영.*(갈까|할까|해볼까|배울까)/,      // 수영 할까?
    /등산.*(갈까|할까|가야)/,               // 등산 갈까?
    /조깅.*(갈까|할까|해야)/,               // 조깅 할까?
    /런닝.*(갈까|할까|해야)/,               // 런닝 할까?
    /산책.*(갈까|할까|나갈까)/,             // 산책 갈까?
    /다이어트.*(할까|해야|시작|해볼까)/,    // 다이어트 할까?
    /단식.*(할까|해야|해볼까)/,             // 단식 할까?
    /병원.*(갈까|가야|가볼까)/,             // 병원 갈까?
    /치과.*(갈까|가야|가볼까)/,             // 치과 갈까?
    /한의원.*(갈까|가야|가볼까)/,           // 한의원 갈까?
    /검진.*(받을까|해야|할까)/,             // 검진 받을까?
    /수술.*(할까|해야|받을까)/,             // 수술 할까?
    /약.*(먹을까|먹어야|복용)/,             // 약 먹을까?
    /영양제.*(먹을까|먹어야|살까)/,         // 영양제 먹을까?
    /금연.*(할까|해야|해볼까)/,             // 금연 할까?
    /금주.*(할까|해야|해볼까)/,             // 금주 할까?
    /담배.*(끊을까|끊어야|줄일까)/,         // 담배 끊을까?

    // ===== 음식/식사 =====
    /술.*(마실까|먹을까|할까|한잔)/,        // 술 마실까?
    /밥.*(먹을까|먹어야|할까)/,             // 밥 먹을까?
    /야식.*(먹을까|시킬까|할까)/,           // 야식 먹을까?
    /치킨.*(먹을까|시킬까|살까)/,           // 치킨 먹을까?
    /피자.*(먹을까|시킬까|살까)/,           // 피자 먹을까?
    /라면.*(먹을까|끓일까|할까)/,           // 라면 먹을까?
    /커피.*(마실까|먹을까|살까)/,           // 커피 마실까?
    /디저트.*(먹을까|살까|시킬까)/,         // 디저트 먹을까?
    /케이크.*(먹을까|살까|시킬까)/,         // 케이크 먹을까?
    /배달.*(시킬까|할까|먹을까)/,           // 배달 시킬까?
    /외식.*(할까|갈까|해야)/,               // 외식 할까?
    /맛집.*(갈까|가볼까|찾아)/,             // 맛집 갈까?
    /카페.*(갈까|가볼까|갈지)/,             // 카페 갈까?
    /스타벅스.*(갈까|가볼까)/,              // 스타벅스 갈까?
    /아이스크림.*(먹을까|살까)/,            // 아이스크림 먹을까?
    /간식.*(먹을까|살까)/,                  // 간식 먹을까?

    // ===== 놀이/취미 =====
    /영화.*(볼까|볼지|보러|갈까)/,          // 영화 볼까?
    /게임.*(할까|할지|해야|해볼까)/,        // 게임 할까?
    /노래방.*(갈까|가볼까|갈지)/,           // 노래방 갈까?
    /PC방.*(갈까|가볼까|갈지)/,             // PC방 갈까?
    /피시방.*(갈까|가볼까|갈지)/,           // 피시방 갈까?
    /당구장.*(갈까|가볼까|칠까)/,           // 당구장 갈까?
    /볼링.*(갈까|할까|칠까)/,               // 볼링 갈까?
    /낚시.*(갈까|할까|가볼까)/,             // 낚시 갈까?
    /캠핑.*(갈까|할까|가볼까)/,             // 캠핑 갈까?
    /여행.*(갈까|갈지|가야|가볼까)/,        // 여행 갈까?
    /해외.*(갈까|가볼까|나갈까)/,           // 해외 갈까?
    /드라마.*(볼까|볼지|보러)/,             // 드라마 볼까?
    /넷플.*(볼까|할까|구독)/,               // 넷플 볼까?
    /유튜브.*(볼까|할까)/,                  // 유튜브 볼까?
    /콘서트.*(갈까|가볼까|예매)/,           // 콘서트 갈까?
    /뮤지컬.*(갈까|가볼까|볼까)/,           // 뮤지컬 갈까?
    /전시회.*(갈까|가볼까|볼까)/,           // 전시회 갈까?
    /축제.*(갈까|가볼까)/,                  // 축제 갈까?
    /놀이공원.*(갈까|가볼까)/,              // 놀이공원 갈까?
    /워터파크.*(갈까|가볼까)/,              // 워터파크 갈까?
    /스키.*(갈까|타러|가볼까)/,             // 스키 갈까?
    /보드.*(갈까|타러|가볼까)/,             // 보드 갈까?

    // ===== 학습/자기개발 =====
    /공부.*(할까|할지|해야|시작)/,          // 공부 할까?
    /학원.*(갈까|다닐까|등록)/,             // 학원 갈까?
    /영어.*(할까|공부|배울까)/,             // 영어 할까?
    /일본어.*(할까|공부|배울까)/,           // 일본어 할까?
    /중국어.*(할까|공부|배울까)/,           // 중국어 할까?
    /자격증.*(딸까|공부|준비)/,             // 자격증 딸까?
    /독서.*(할까|해야|해볼까)/,             // 독서 할까?
    /책.*(읽을까|볼까|살까)/,               // 책 읽을까?
    /강의.*(들을까|볼까|신청)/,             // 강의 들을까?
    /인강.*(들을까|볼까|신청)/,             // 인강 들을까?
    /코딩.*(배울까|할까|공부)/,             // 코딩 배울까?
    /프로그래밍.*(배울까|할까)/,            // 프로그래밍 배울까?

    // ===== 쇼핑/구매 =====
    /옷.*(살까|사야|입을까|바꿀까)/,        // 옷 살까?
    /신발.*(살까|사야|신을까)/,             // 신발 살까?
    /가방.*(살까|사야|바꿀까)/,             // 가방 살까?
    /폰.*(살까|사야|바꿀까)/,               // 폰 살까?
    /핸드폰.*(살까|사야|바꿀까)/,           // 핸드폰 살까?
    /아이폰.*(살까|사야|바꿀까)/,           // 아이폰 살까?
    /갤럭시.*(살까|사야|바꿀까)/,           // 갤럭시 살까?
    /노트북.*(살까|사야|바꿀까)/,           // 노트북 살까?
    /컴퓨터.*(살까|사야|바꿀까)/,           // 컴퓨터 살까?
    /차.*(살까|사야|바꿀까)/,               // 차 살까?
    /중고차.*(살까|사야)/,                  // 중고차 살까?
    /자전거.*(살까|사야|탈까)/,             // 자전거 살까?
    /전동킥보드.*(살까|사야|탈까)/,         // 전동킥보드 살까?
    /시계.*(살까|사야)/,                    // 시계 살까?
    /반지.*(살까|사야)/,                    // 반지 살까?
    /선물.*(살까|사야|줄까)/,               // 선물 살까?
    /가전.*(살까|사야|바꿀까)/,             // 가전 살까?
    /가구.*(살까|사야|바꿀까)/,             // 가구 살까?
    /쇼핑.*(할까|갈까|해야)/,               // 쇼핑 할까?
    /장.*(볼까|볼지|보러)/,                 // 장 볼까?

    // ===== 미용/뷰티 =====
    /머리.*(자를까|잘라야|할까|감을까|염색)/,  // 머리 자를까?
    /염색.*(할까|해야|해볼까)/,             // 염색 할까?
    /파마.*(할까|해야|해볼까)/,             // 파마 할까?
    /미용실.*(갈까|가야|가볼까)/,           // 미용실 갈까?
    /네일.*(할까|받을까|가볼까)/,           // 네일 할까?
    /피부과.*(갈까|가야|가볼까)/,           // 피부과 갈까?
    /마사지.*(받을까|갈까|가볼까)/,         // 마사지 받을까?
    /스파.*(갈까|가볼까)/,                  // 스파 갈까?
    /찜질방.*(갈까|가볼까)/,                // 찜질방 갈까?
    /사우나.*(갈까|가볼까)/,                // 사우나 갈까?
    /화장품.*(살까|사야)/,                  // 화장품 살까?
    /성형.*(할까|해야|해볼까)/,             // 성형 할까?
    /시술.*(받을까|할까)/,                  // 시술 받을까?
    /문신.*(할까|해야|새길까)/,             // 문신 할까?
    /타투.*(할까|해야|새길까)/,             // 타투 할까?
    /피어싱.*(할까|뚫을까)/,                // 피어싱 할까?

    // ===== 인간관계/소통 =====
    /연락.*(할까|해야|할지)/,               // 연락 할까?
    /고백.*(할까|해야|할지)/,               // 고백 할까?
    /데이트.*(할까|신청|갈까)/,             // 데이트 할까?
    /만나.*(야|볼까|할까|갈까)/,            // 만나야 할까?
    /전화.*(할까|해야|할지)/,               // 전화 할까?
    /문자.*(할까|보낼까|해야)/,             // 문자 할까?
    /카톡.*(할까|보낼까|해야)/,             // 카톡 할까?
    /DM.*(할까|보낼까|해야)/i,              // DM 할까?
    /답장.*(할까|해야|보낼까)/,             // 답장 할까?
    /사과.*(할까|해야|할지)/,               // 사과 할까?
    /화해.*(할까|해야|할지)/,               // 화해 할까?
    /결혼.*(할까|해야|할지)/,               // 결혼 할까?
    /프로포즈.*(할까|해야|할지)/,           // 프로포즈 할까?
    /선물.*(줄까|사야|할까)/,               // 선물 줄까?
    /축하.*(할까|해야|할지)/,               // 축하 할까?
    /약속.*(잡을까|할까|할지)/,             // 약속 잡을까?
    /파티.*(갈까|할까|열까)/,               // 파티 갈까?
    /모임.*(갈까|참석|나갈까)/,             // 모임 갈까?
    /번개.*(나갈까|갈까|참석)/,             // 번개 나갈까?

    // ===== 일상/생활 =====
    /외출.*(할까|해야|갈까)/,               // 외출 할까?
    /청소.*(할까|해야|할지)/,               // 청소 할까?
    /빨래.*(할까|돌릴까|해야)/,             // 빨래 할까?
    /설거지.*(할까|해야)/,                  // 설거지 할까?
    /요리.*(할까|해야|할지|해볼까)/,        // 요리 할까?
    /샤워.*(할까|해야)/,                    // 샤워 할까?
    /목욕.*(할까|갈까|해야)/,               // 목욕 할까?
    /낮잠.*(잘까|자야|잘지)/,               // 낮잠 잘까?
    /늦잠.*(잘까|자도|괜찮)/,               // 늦잠 잘까?
    /운전.*(할까|해야|할지)/,               // 운전 할까?
    /택시.*(탈까|타야|부를까)/,             // 택시 탈까?
    /버스.*(탈까|타야)/,                    // 버스 탈까?
    /지하철.*(탈까|타야)/,                  // 지하철 탈까?
    /걸어.*(갈까|가야)/,                    // 걸어 갈까?

    // ===== 주거/이사 =====
    /이사.*(할까|할지|해야|가야)/,          // 이사 할까?
    /전세.*(갈까|구할까|할까)/,             // 전세 갈까?
    /월세.*(갈까|구할까|할까)/,             // 월세 갈까?
    /집.*(살까|사야|구할까|옮길까)/,        // 집 살까?
    /인테리어.*(할까|해야|바꿀까)/,         // 인테리어 할까?
    /이불.*(빨까|빨래|세탁)/,               // 이불 빨까?

    // ===== 직장/일 =====
    /이직.*(할까|해야|할지)/,               // 이직 할까?
    /퇴사.*(할까|해야|할지)/,               // 퇴사 할까?
    /야근.*(할까|해야|할지)/,               // 야근 할까?
    /출근.*(할까|해야|할지)/,               // 출근 할까?
    /조퇴.*(할까|해야|할지)/,               // 조퇴 할까?
    /휴가.*(쓸까|낼까|갈까)/,               // 휴가 쓸까?
    /연차.*(쓸까|낼까)/,                    // 연차 쓸까?
    /반차.*(쓸까|낼까)/,                    // 반차 쓸까?
    /병가.*(낼까|쓸까)/,                    // 병가 낼까?
    /보고.*(할까|해야|드릴까)/,             // 보고 할까?
    /회의.*(할까|잡을까)/,                  // 회의 할까?

    // ===== 재정/투자 =====
    /투자.*(할까|해야|할지|해볼까)/,        // 투자 할까?
    /주식.*(살까|사야|할까|팔까)/,          // 주식 살까?
    /코인.*(살까|사야|할까|팔까)/,          // 코인 살까?
    /비트코인.*(살까|사야|팔까)/,           // 비트코인 살까?
    /펀드.*(들까|가입|할까)/,               // 펀드 들까?
    /적금.*(들까|가입|넣을까)/,             // 적금 들까?
    /예금.*(할까|넣을까)/,                  // 예금 할까?
    /대출.*(받을까|할까|해야|갚을까)/,      // 대출 받을까?
    /빚.*(갚을까|청산|할까)/,               // 빚 갚을까?
    /저축.*(할까|해야|해볼까)/,             // 저축 할까?
    /부동산.*(살까|투자|할까)/,             // 부동산 살까?
    /청약.*(넣을까|할까|신청)/,             // 청약 넣을까?
    /보험.*(들까|가입|해야)/,               // 보험 들까?
    /카드.*(만들까|발급|할까)/,             // 카드 만들까?
    /구독.*(할까|끊을까|해지)/,             // 구독 할까?
    /해지.*(할까|해야)/,                    // 해지 할까?
    /환불.*(받을까|할까|해야)/,             // 환불 받을까?

    // ===== 기타 =====
    /시작.*(할까|해야|할지|해볼까)/,        // 시작 할까?
    /그만.*(둘까|해야|할까)/,               // 그만 둘까?
    /포기.*(할까|해야|할지)/,               // 포기 할까?
    /계속.*(할까|해야|할지)/,               // 계속 할까?
    /도전.*(할까|해야|해볼까)/,             // 도전 할까?
    /신청.*(할까|해야|해볼까)/,             // 신청 할까?
    /지원.*(할까|해야|해볼까)/,             // 지원 할까?
    /참가.*(할까|해야|해볼까)/,             // 참가 할까?
    /참석.*(할까|해야|해볼까)/,             // 참석 할까?
    /예약.*(할까|해야|잡을까)/,             // 예약 할까?
    /취소.*(할까|해야|할지)/,               // 취소 할까?
    /변경.*(할까|해야|할지)/,               // 변경 할까?
    /반품.*(할까|해야|할지)/,               // 반품 할까?
    /교환.*(할까|해야|할지)/,               // 교환 할까?
    /신고.*(할까|해야|할지)/,               // 신고 할까?
    /고소.*(할까|해야|할지)/,               // 고소 할까?
    /이혼.*(할까|해야|할지)/,               // 이혼 할까?
    /입양.*(할까|해야|할지)/,               // 입양 할까?
    /애완동물.*(키울까|살까|데려올까)/,     // 애완동물 키울까?
    /강아지.*(키울까|살까|데려올까)/,       // 강아지 키울까?
    /고양이.*(키울까|살까|데려올까)/,       // 고양이 키울까?
    /반려동물.*(키울까|살까|데려올까)/,     // 반려동물 키울까?
  ];

  // 4. 영어 Yes/No 패턴 - 확장
  const englishPatterns = [
    /should i/i,
    /is it good to/i,
    /can i/i,
    /shall i/i,
    /do i need to/i,
    /should we/i,
    /would it be/i,
    /is it okay to/i,
    /is it worth/i,
    /do you think i should/i,
    /would you recommend/i,
    /is it a good idea to/i,
    /should i go/i,
    /should i buy/i,
    /should i eat/i,
    /should i drink/i,
    /should i start/i,
    /should i quit/i,
    /should i continue/i,
    /should i stop/i,
    /is it time to/i,
    /am i ready to/i,
    /is this the right/i,
    /will it be okay if/i,
    /is it safe to/i,
    /is it too late to/i,
    /is it too early to/i,
  ];

  return endingPatterns.some(p => p.test(question)) ||
         midPatterns.some(p => p.test(question)) ||
         keywordPatterns.some(p => p.test(question)) ||
         englishPatterns.some(p => p.test(question));
}

// 상대방 마음 질문 감지 - 확장
function isCrushQuestion(question: string): boolean {
  const patterns = [
    // 그 사람 관련
    /그 ?사람 ?(마음|생각|속마음|감정|심정)/,
    /그사람 ?(마음|생각|속마음|감정|심정)/,
    /그 ?사람이? ?날? ?(어떻게|좋아|생각)/,
    /그 ?사람은? ?나를? ?(어떻게|좋아|생각)/,

    // 걔/쟤 관련
    /걔가? ?날? ?(좋아|생각|어떻게)/,
    /쟤가? ?날? ?(좋아|생각|어떻게)/,
    /걔 ?마음/,
    /쟤 ?마음/,
    /걔가 ?나를/,
    /쟤가 ?나를/,

    // 나를 어떻게 생각 관련
    /나를? ?어떻게 ?(생각|봐|느끼|볼까)/,
    /날 ?어떻게 ?(생각|봐|느끼)/,
    /저를? ?어떻게 ?(생각|봐|느끼)/,
    /나한테 ?어떤 ?(감정|마음|생각)/,
    /나에게 ?어떤 ?(감정|마음|생각)/,

    // 마음 알까/있까 관련
    /내 ?마음 ?알까/,
    /제 ?마음 ?알까/,
    /마음이? ?있/,
    /관심이? ?있/,
    /호감이? ?있/,

    // 좋아해/좋아하나 관련
    /좋아해\??$/,
    /좋아하나/,
    /좋아할까/,
    /날 ?좋아/,
    /나를 ?좋아/,
    /저를? ?좋아/,
    /사랑해\??$/,
    /사랑하나/,
    /사랑할까/,

    // 상대/상대방 관련
    /상대 ?(마음|생각|감정|심정)/,
    /상대방 ?(마음|생각|감정|심정)/,
    /상대가 ?나를/,
    /상대방이 ?나를/,

    // 짝사랑/호감 관련
    /짝사랑/,
    /호감/,
    /썸남|썸녀/,
    /썸 ?타는/,
    /관심 ?있는 ?사람/,
    /좋아하는 ?사람/,

    // 그녀/그 관련
    /그녀가?.*(마음|생각|감정|나를)/,
    /그가?.*(마음|생각|감정|나를)/,

    // 속마음/진심 관련
    /속마음/,
    /진심/,
    /진짜 ?마음/,
    /솔직한 ?마음/,

    // 영어 패턴
    /does (he|she|they) like me/i,
    /what does (he|she|they) think/i,
    /how does (he|she|they) feel/i,
    /(his|her|their) feelings/i,
    /does (he|she|they) have feelings/i,
    /crush.*(feel|think|like)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 재회/이별 질문 감지 - 확장
function isReconciliationQuestion(question: string): boolean {
  const patterns = [
    // 재회 관련
    /재회/,
    /다시 ?만날/,
    /다시 ?만나/,
    /다시 ?사귈/,
    /다시 ?시작/,
    /다시 ?연락/,
    /복합/,

    // 돌아올/돌아오다 관련
    /돌아올/,
    /돌아오나/,
    /돌아올까/,
    /돌아와/,
    /돌아오고/,
    /되돌아/,

    // 연락 관련
    /연락 ?올까/,
    /연락올까/,
    /연락이 ?올까/,
    /먼저 ?연락/,
    /연락 ?오려나/,
    /연락 ?할까/,  // 이것도 재회 맥락일 수 있음

    // 헤어진 후 관련
    /헤어진.*(돌아|연락|만날|사귈|다시)/,
    /이별.*(후|뒤).*(다시|돌아|연락)/,
    /결별.*(후|뒤).*(다시|돌아|연락)/,
    /헤어지고.*(연락|만날|다시)/,

    // 전 애인 관련
    /전 ?남친|전남친/,
    /전 ?여친|전여친/,
    /전 ?남자친구/,
    /전 ?여자친구/,
    /전 ?애인/,
    /옛 ?남친|옛남친/,
    /옛 ?여친|옛여친/,
    /예전 ?남친/,
    /예전 ?여친/,
    /예전 ?애인/,

    // 잊지 못하는 관련
    /잊지 ?못/,
    /못 ?잊/,
    /아직도 ?날/,
    /여전히 ?좋아/,
    /여전히 ?사랑/,
    /그리워/,
    /보고싶어/,

    // 마음 남아있는지
    /아직 ?마음/,
    /마음이 ?남/,
    /미련/,

    // 영어 패턴
    /ex.*(back|return|contact|miss|think)/i,
    /get back together/i,
    /reconcil/i,
    /come back/i,
    /will (he|she|they) come back/i,
    /will (he|she|they) contact/i,
  ];
  return patterns.some(p => p.test(question));
}

// 면접/시험 결과 질문 감지 - 확장
function isExamInterviewQuestion(question: string): boolean {
  const patterns = [
    // 면접 관련
    /면접.*(결과|합격|붙을|될까|어떨까|잘|통과)/,
    /면접 ?보/,
    /면접 ?봤/,
    /면접 ?어떻/,
    /인터뷰.*(결과|합격|잘)/,

    // 시험 관련
    /시험.*(결과|합격|붙을|될까|어떨까|통과|잘)/,
    /시험 ?어떻/,
    /시험 ?봤/,
    /시험 ?보/,
    /필기.*(합격|통과|결과)/,
    /실기.*(합격|통과|결과)/,

    // 합격/불합격 관련
    /합격.*(할까|될까|가능|하나)/,
    /불합격/,
    /붙을까/,
    /붙을 ?수/,
    /떨어질까/,
    /떨어지나/,
    /통과.*(할까|될까|하나)/,

    // 자격증 관련
    /자격증.*(딸까|합격|될까|따다|통과)/,

    // 각종 시험
    /수능.*(결과|점수|합격|잘|어떻)/,
    /토익.*(결과|점수|잘)/,
    /토플.*(결과|점수|잘)/,
    /공시.*(합격|붙을|될까)/,
    /공무원.*(시험|합격|붙을|될까)/,
    /임용.*(고시|시험|합격|붙을)/,
    /행시.*(합격|붙을|될까)/,
    /사시.*(합격|붙을|될까)/,
    /고시.*(합격|붙을|될까)/,
    /편입.*(합격|붙을|될까)/,
    /대학.*(합격|붙을|될까|입학)/,
    /입시.*(결과|합격|붙을)/,
    /수시.*(합격|붙을|될까)/,
    /정시.*(합격|붙을|될까)/,
    /논술.*(합격|붙을|결과)/,

    // 오디션/테스트 관련
    /오디션.*(결과|합격|붙을|통과)/,
    /테스트.*(결과|합격|통과)/,

    // 영어 패턴
    /interview.*(result|pass|get|how)/i,
    /exam.*(result|pass|how)/i,
    /will i pass/i,
    /did i pass/i,
    /pass the (exam|test|interview)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 이직/퇴사 질문 감지 - 확장
function isJobChangeQuestion(question: string): boolean {
  // 단순 "이직할까?"는 Yes/No로 처리되므로 더 구체적인 이직 상담만 여기서 처리
  const patterns = [
    // 이직 관련
    /이직.*(해도|좋을까|타이밍|시기|어디로|방향|전망)/,
    /이직 ?전망/,
    /이직 ?운/,
    /이직처|이직할 ?곳/,
    /새 ?직장|새직장/,
    /새 ?회사/,

    // 퇴사 관련
    /퇴사.*(해도|좋을까|타이밍|시기|후|하고)/,
    /퇴사 ?후/,
    /퇴사 ?전망/,

    // 회사/직장 옮기기 관련
    /회사.*(옮길까|옮겨야|그만둘까|관둘까|바꿀까)/,
    /직장.*(옮길까|옮겨야|그만둘까|관둘까|바꿀까)/,
    /현 ?직장.*(계속|남을까|떠날까|미래)/,
    /지금 ?회사.*(계속|남을까|떠날까)/,

    // 직업 변경 관련
    /직업.*(바꿀까|바꿔야|전환|변경)/,
    /업종.*(바꿀까|바꿔야|전환|변경)/,
    /분야.*(바꿀까|바꿔야|전환|변경)/,
    /커리어.*(변경|전환|바꿀)/,

    // 진로 관련
    /진로.*(고민|방향|어떻게)/,
    /앞으로 ?직업/,
    /앞으로 ?커리어/,

    // 취업 관련
    /취업.*(운|어디|될까|전망)/,
    /취직.*(운|어디|될까|전망)/,
    /채용.*(될까|가능|어디)/,

    // 창업 관련 (이것도 직업 변화)
    /창업.*(해도|좋을까|어떨까|성공)/,
    /사업.*(시작|해도|좋을까)/,

    // 영어 패턴
    /job change/i,
    /career change/i,
    /should i quit/i,
    /new job/i,
    /leave (my|the) (job|company)/i,
    /change (job|career)/i,
  ];
  // Yes/No 패턴이면 Yes/No가 우선
  if (isYesNoQuestion(question)) return false;
  return patterns.some(p => p.test(question));
}

// A vs B 비교 질문 감지 - 확장
function isComparisonQuestion(question: string): boolean {
  const patterns = [
    // vs 관련
    /vs/i,
    /versus/i,
    /.+ ?(vs|versus) ?.+/i,

    // ~냐 ~냐 패턴
    /.+냐 .+냐/,           // A냐 B냐
    /.+이냐 .+이냐/,       // A이냐 B이냐
    /.+할까 .+할까/,       // A할까 B할까
    /.+갈까 .+갈까/,       // A갈까 B갈까

    // 아니면 패턴
    /.+ ?아니면 ?.+/,      // A 아니면 B
    /.+가 ?나을까.+/,      // A가 나을까 B가 나을까
    /.+ ?말고 ?.+/,        // A 말고 B

    // 둘 중에 패턴
    /둘 ?중|둘중/,          // 둘 중에
    /둘 ?중에/,
    /둘 ?다/,               // 둘 다?
    /셋 ?중/,               // 셋 중에
    /여러 ?개 ?중/,         // 여러 개 중

    // 비교 패턴
    /어디가 ?나을까/,       // 어디가 나을까
    /어느 ?게 ?나을까/,     // 어느 게 나을까
    /뭐가 ?나을까/,         // 뭐가 나을까
    /뭐가 ?좋을까/,         // 뭐가 좋을까
    /어떤 ?게 ?좋을까/,     // 어떤 게 좋을까
    /어느 ?쪽/,             // 어느 쪽
    /어디로 ?가야/,         // 어디로 가야 할까
    /뭘 ?선택/,             // 뭘 선택해야
    /선택.*(어려|고민|갈등)/,  // 선택이 어려워
    /고르기 ?힘들/,         // 고르기 힘들어
    /비교/,                 // 비교해서

    // 회사/직장 비교
    /회사.*(어디|어느)/,    // 회사 어디가
    /직장.*(어디|어느)/,    // 직장 어디가
    /삼성.*(LG|현대|SK)/i,  // 삼성 vs LG
    /네이버.*(카카오|쿠팡)/i, // 네이버 vs 카카오

    // 지역 비교
    /서울.*(부산|대전|대구|인천)/,
    /강남.*(강북|신촌|홍대)/,

    // 영어 패턴
    /which (one|is better)/i,
    /between .+ (and|or) .+/i,
    /choose between/i,
    /A or B/i,
    /option (A|1).*(option (B|2)|or)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 타이밍/시기 질문 감지 - 확장
function isTimingQuestion(question: string): boolean {
  const patterns = [
    // 언제 관련
    /언제.*(하면|해야|좋을까|시작|할까|가야)/,
    /언제쯤/,
    /언제가 ?좋/,
    /언제 ?시작/,
    /언제 ?해야/,
    /언제 ?가야/,
    /언제 ?만날/,
    /언제 ?될까/,

    // 시기/타이밍 관련
    /시기가/,
    /시기를/,
    /적절한 ?시기/,
    /좋은 ?시기|좋은시기/,
    /타이밍/,
    /적절한 ?때|적절한때/,
    /좋은 ?때/,
    /최적의 ?시기/,
    /적기/,

    // 몇 월/년/주 관련
    /몇 ?월|몇월/,
    /몇 ?년|몇년/,
    /몇 ?주/,
    /몇 ?일/,
    /며칠 ?후/,
    /얼마나 ?있다가/,
    /얼마나 ?지나면/,
    /얼마 ?후에/,

    // 올해/내년/다음 관련
    /올해.*(안에|내에|중에)/,
    /내년.*(에|쯤|까지)/,
    /다음 ?달/,
    /다음 ?주/,
    /이번 ?안에/,

    // 기다리다 관련
    /기다리면/,
    /기다려야/,
    /기다릴까/,

    // 시작 관련
    /시작.*(시기|언제|때)/,
    /개시.*(시기|언제|때)/,
    /착수.*(시기|언제|때)/,

    // 영어 패턴
    /when.*(should|good|best|right)/i,
    /when is the (best|right|good) time/i,
    /when to/i,
    /how long (until|before|should)/i,
    /timing/i,
  ];
  // Yes/No 패턴이면 제외
  if (isYesNoQuestion(question)) return false;
  return patterns.some(p => p.test(question));
}

// 인연/소개팅 질문 감지 - 확장
function isFindingPartnerQuestion(question: string): boolean {
  const patterns = [
    // 인연 관련
    /인연.*(언제|만날|찾을|있을까|올까)/,
    /인연이 ?있/,
    /인연을 ?만날/,
    /좋은 ?인연/,
    /운명의 ?사람/,
    /운명적 ?만남/,

    // 좋은 사람 관련
    /좋은 ?사람.*(만날|언제|찾을|있을까)/,
    /괜찮은 ?사람.*(만날|언제|찾을)/,
    /좋은 ?남자.*(만날|언제|찾을)/,
    /좋은 ?여자.*(만날|언제|찾을)/,

    // 소개팅/미팅 관련
    /소개팅/,
    /미팅/,
    /맞선/,
    /결혼정보회사/,
    /앱 ?만남|앱만남/,
    /소셜 ?데이팅/,
    /데이팅 ?앱/,

    // 연인/애인 관련
    /연인.*(만날|언제|있을까|생길까)/,
    /연인이 ?생길/,
    /애인.*(생길까|만날까|언제|있을까)/,
    /애인이 ?생길/,
    /남자친구.*(생길|만날|있을까)/,
    /여자친구.*(생길|만날|있을까)/,
    /남친.*(생길|만날|있을까)/,
    /여친.*(생길|만날|있을까)/,

    // 짝/파트너 관련
    /짝이? ?(생길까|만날까|언제|있을까)/,
    /반쪽/,
    /파트너.*(만날|찾을|언제)/,

    // 결혼 상대 관련
    /결혼 ?상대|결혼상대/,
    /결혼할 ?사람/,
    /평생 ?동반자/,
    /배우자.*(만날|찾을)/,

    // 연애/사랑 시작 관련
    /연애.*(시작|할 ?수|언제)/,
    /사랑.*(찾을|만날|시작)/,
    /연애 ?운/,
    /사랑 ?운/,

    // 솔로 탈출 관련
    /솔로 ?탈출/,
    /솔로 ?끝/,
    /혼자.*(끝|벗어|언제)/,

    // 영어 패턴
    /find (love|partner|soulmate)/i,
    /meet (someone|the one)/i,
    /soulmate/i,
    /when will i find/i,
    /dating/i,
    /single.*(forever|end)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 오늘 운세 질문 감지 (단, "오늘 ~할까?"는 제외) - 확장
function isTodayFortuneQuestion(question: string): boolean {
  if (isYesNoQuestion(question)) return false;
  const patterns = [
    // 오늘 관련
    /오늘 ?(운세|운|어때|하루|기운|에너지)/,
    /오늘의 ?(운세|운|메시지|조언|카드)/,
    /오늘 ?하루/,
    /^오늘$/,  // 그냥 "오늘"만
    /오늘 ?어떤 ?날/,
    /오늘 ?뽑아/,

    // 데일리 관련
    /일일 ?운세/,
    /하루 ?운세/,
    /오늘 ?점/,
    /일일 ?타로/,
    /데일리 ?타로/,
    /데일리 ?카드/,

    // 영어 패턴
    /today.*(fortune|luck|energy|reading|card)/i,
    /daily (reading|card|fortune)/i,
    /today's (fortune|reading|card)/i,
    /how.*(today|my day)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 주간/월간 운세 질문 감지 - 확장
function isWeeklyMonthlyQuestion(question: string): boolean {
  const patterns = [
    // 이번 주/달 관련
    /이번 ?주|이번주/,
    /이번 ?달|이번달/,
    /금주/,
    /금월/,
    /이번 ?한 ?주/,

    // 주간/월간 관련
    /주간 ?운세|주간운세/,
    /월간 ?운세|월간운세/,
    /한 ?주|한주/,
    /한 ?달|한달/,
    /일주일/,

    // 다음 주/달 관련
    /다음 ?주/,
    /다음 ?달/,
    /내주/,
    /다음주/,

    // 연간 관련
    /올해 ?운세/,
    /연간 ?운세/,
    /내년 ?운세/,
    /올해 ?어떨까/,
    /이번 ?해/,

    // 영어 패턴
    /weekly/i,
    /monthly/i,
    /this week/i,
    /this month/i,
    /next week/i,
    /next month/i,
    /yearly/i,
    /this year/i,
  ];
  return patterns.some(p => p.test(question));
}

// 금전/재물 운세 질문 감지
function isMoneyFortuneQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "주식 살까?", "투자할까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 돈/재물 운세 관련
    /돈 ?운|돈운/,
    /금전 ?운|금전운/,
    /재물 ?운|재물운/,
    /재정 ?운|재정운/,
    /금전 ?운세/,
    /재물 ?운세/,
    /돈이? ?들어올/,
    /돈이? ?생길/,
    /돈 ?벌/,
    /수입이? ?있을/,
    /수입 ?운/,

    // 재정 상태 관련
    /재정 ?상태/,
    /재정 ?상황/,
    /경제 ?상황/,
    /경제적.*(어떻|상황|상태)/,
    /금전적.*(어떻|상황|상태)/,
    /돈 ?문제/,
    /돈 ?걱정/,

    // 횡재/복권 관련
    /횡재/,
    /복권.*(될까|당첨|운|살까)/,
    /로또.*(될까|당첨|운)/,
    /대박/,
    /잭팟/,
    /한탕/,
    /돈방석/,

    // 투자 운 관련 (투자할까? 제외)
    /투자 ?운/,
    /주식 ?운/,
    /코인 ?운/,
    /부동산 ?운/,
    /투자.*(운세|전망|흐름)/,
    /재테크.*(운|어떻|전망)/,

    // 빚/부채 관련
    /빚.*(갚을|청산|어떻|운)/,
    /부채.*(어떻|상황)/,
    /대출.*(갚을|어떻|상황)/,
    /빚이? ?늘/,
    /빚이? ?줄/,

    // 월급/수입 관련
    /월급.*(오를|어떻|인상)/,
    /연봉.*(오를|어떻|인상|협상)/,
    /수입.*(늘|줄|어떻)/,
    /소득.*(어떻|늘|줄)/,
    /보너스.*(받을|어떻|나올)/,
    /인센.*(받을|어떻|나올)/,

    // 사업 수익 관련
    /매출.*(어떻|오를|늘)/,
    /수익.*(어떻|늘|날)/,
    /이익.*(어떻|날)/,
    /흑자/,
    /적자/,

    // 저축/자산 관련
    /저축.*(어떻|늘|해야)/,
    /자산.*(어떻|늘|불어)/,
    /재산.*(어떻|늘|불어)/,
    /모을 ?수 ?있/,
    /부자.*(될|되나|가능)/,

    // 영어 패턴
    /money.*(luck|fortune|come|flow)/i,
    /financial.*(situation|luck|fortune)/i,
    /wealth/i,
    /lottery/i,
    /will i get rich/i,
    /income/i,
    /salary.*(increase|raise)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 건강 운세 질문 감지
function isHealthFortuneQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "병원 갈까?", "수술할까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 건강 운세 관련
    /건강 ?운|건강운/,
    /건강 ?운세/,
    /몸 ?상태/,
    /건강 ?상태/,
    /건강.*(어떻|어떨까|괜찮)/,
    /몸이? ?어떻/,
    /체력.*(어떻|좋아질)/,

    // 병/질병 관련
    /병.*(나을|치료|어떻|좋아질)/,
    /질병.*(나을|치료|어떻)/,
    /아픈.*(나을|좋아질|어떻)/,
    /아프.*(언제|어떻|나을)/,
    /회복.*(될까|어떻|가능)/,
    /완치.*(될까|가능|어떻)/,
    /치료.*(잘|어떻|될까)/,
    /병원.*(결과|어떻)/,

    // 수술 관련 (수술할까? 제외)
    /수술.*(결과|잘|어떻|성공)/,
    /수술 ?후/,
    /수술 ?예후/,
    /수술 ?결과/,

    // 특정 건강 문제
    /암.*(완치|나을|어떻|치료)/,
    /당뇨.*(어떻|좋아질|관리)/,
    /혈압.*(어떻|좋아질|관리)/,
    /심장.*(어떻|좋아질|괜찮)/,
    /간.*(어떻|좋아질|괜찮)/,
    /신장.*(어떻|좋아질|괜찮)/,
    /허리.*(어떻|좋아질|나을)/,
    /무릎.*(어떻|좋아질|나을)/,
    /관절.*(어떻|좋아질|나을)/,
    /피부.*(어떻|좋아질|나을)/,
    /위장.*(어떻|좋아질|나을)/,
    /소화.*(어떻|좋아질)/,
    /불면.*(어떻|좋아질|나을)/,
    /수면.*(어떻|좋아질)/,
    /우울.*(어떻|좋아질|나을)/,
    /스트레스.*(어떻|해소|줄)/,
    /정신.*(건강|어떻|좋아질)/,
    /멘탈.*(어떻|좋아질)/,

    // 임신/출산 관련
    /임신.*(될까|가능|어떻|운)/,
    /임신 ?운/,
    /출산.*(잘|어떻|순조)/,
    /아이.*(생길|가질|어떻)/,
    /아기.*(생길|가질|어떻)/,

    // 체중/다이어트 관련 (다이어트 할까? 제외)
    /체중.*(빠질|줄|어떻)/,
    /살.*(빠질|어떻)/,
    /다이어트.*(성공|어떻|결과)/,

    // 영어 패턴
    /health.*(fortune|luck|how|condition)/i,
    /will i recover/i,
    /surgery.*(result|success|how)/i,
    /get better/i,
    /heal/i,
    /pregnancy/i,
    /fertility/i,
  ];
  return patterns.some(p => p.test(question));
}

// 가족 관계 질문 감지
function isFamilyRelationQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 부모님 관련
    /부모님.*(관계|사이|어떻|갈등|화해)/,
    /엄마.*(관계|사이|어떻|갈등)/,
    /아빠.*(관계|사이|어떻|갈등)/,
    /어머니.*(관계|사이|어떻|갈등)/,
    /아버지.*(관계|사이|어떻|갈등)/,
    /부모.*(관계|갈등|어떻)/,
    /효도/,

    // 형제자매 관련
    /형제.*(관계|사이|어떻|갈등)/,
    /자매.*(관계|사이|어떻|갈등)/,
    /언니.*(관계|사이|어떻)/,
    /오빠.*(관계|사이|어떻)/,
    /누나.*(관계|사이|어떻)/,
    /형.*(관계|사이|어떻)/,
    /동생.*(관계|사이|어떻)/,

    // 자녀 관련
    /자녀.*(관계|문제|어떻|교육|진로)/,
    /아이.*(관계|문제|어떻|교육|진로)/,
    /아들.*(관계|문제|어떻|진로)/,
    /딸.*(관계|문제|어떻|진로)/,
    /애.*(관계|문제|어떻|진로)/,
    /자식.*(관계|문제|어떻)/,
    /육아.*(어떻|힘들|괜찮)/,

    // 배우자/시댁/처가 관련
    /시댁.*(관계|문제|어떻|갈등)/,
    /시어머니.*(관계|어떻|갈등)/,
    /시아버지.*(관계|어떻|갈등)/,
    /처가.*(관계|문제|어떻|갈등)/,
    /장인.*(관계|어떻)/,
    /장모.*(관계|어떻)/,
    /배우자.*(관계|어떻|갈등)/,
    /남편.*(관계|어떻|갈등|사이)/,
    /아내.*(관계|어떻|갈등|사이)/,
    /와이프.*(관계|어떻|갈등|사이)/,
    /부부.*(관계|갈등|사이|어떻)/,

    // 가족 전체 관련
    /가족.*(관계|갈등|어떻|화목|사이)/,
    /가정.*(화목|평화|어떻|문제)/,
    /집안.*(어떻|분위기|화목)/,
    /가정사/,
    /가족 ?문제/,
    /가족 ?갈등/,

    // 친척 관련
    /친척.*(관계|갈등|어떻)/,
    /사촌.*(관계|어떻)/,
    /삼촌.*(관계|어떻)/,
    /이모.*(관계|어떻)/,
    /고모.*(관계|어떻)/,

    // 영어 패턴
    /family.*(relationship|issue|problem|how)/i,
    /parent.*(relationship|issue)/i,
    /sibling.*(relationship|issue)/i,
    /child.*(relationship|issue|problem)/i,
    /spouse.*(relationship|issue)/i,
    /marriage.*(issue|problem|how)/i,
    /in-law/i,
  ];
  return patterns.some(p => p.test(question));
}

// 사업/창업 질문 감지
function isBusinessQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "창업할까?", "사업 시작할까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 창업 관련
    /창업.*(운|전망|어떻|성공|방향|아이템)/,
    /창업 ?운/,
    /사업 ?시작.*(전망|어떻|성공)/,
    /사업.*(운|전망|어떻|성공|방향)/,
    /사업 ?운/,
    /장사.*(운|전망|어떻|잘)/,
    /장사 ?운/,
    /가게.*(운|전망|어떻|잘)/,

    // 사업 운영 관련
    /사업.*(확장|축소|유지|방향)/,
    /사업체.*(어떻|전망)/,
    /회사.*(운영|전망|어떻)/,
    /자영업.*(어떻|전망|운)/,
    /프리랜서.*(어떻|전망|운)/,

    // 사업 파트너 관련
    /동업.*(어떻|괜찮|좋을까)/,
    /파트너.*(사업|동업|어떻)/,
    /사업 ?파트너/,
    /동업자.*(어떻|믿을|괜찮)/,
    /투자자.*(구할|만날|어떻)/,

    // 사업 아이템 관련
    /사업 ?아이템/,
    /아이템.*(괜찮|될까|어떻)/,
    /업종.*(바꿀|어떻|괜찮)/,
    /분야.*(사업|창업|어떻)/,

    // 프랜차이즈/가맹점 관련
    /프랜차이즈.*(어떻|괜찮|할까)/,
    /가맹점.*(어떻|괜찮)/,
    /체인점.*(어떻|괜찮)/,

    // 사업 확장/투자 관련
    /사업.*(투자|확장|확대)/,
    /지점.*(늘릴|열까|확장)/,
    /규모.*(키울|확장|늘릴)/,

    // 거래처/고객 관련
    /거래처.*(어떻|늘|괜찮)/,
    /고객.*(늘|어떻|모을)/,
    /매출.*(늘|오를|어떻)/,
    /수익.*(어떻|늘|날)/,

    // 사업 위기/어려움 관련
    /사업.*(위기|어려움|힘들|망할)/,
    /폐업.*(해야|어떻|고민)/,
    /사업.*(접을|그만|철수)/,
    /망하.*(나|까|지)/,

    // 영어 패턴
    /business.*(fortune|luck|how|start|success)/i,
    /startup.*(how|success|should)/i,
    /entrepreneur/i,
    /franchise/i,
    /company.*(start|run|success)/i,
    /self-employed/i,
  ];
  return patterns.some(p => p.test(question));
}

// 일반 운세/인생 질문 감지
function isGeneralFortuneQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 다른 구체적인 카테고리면 제외
  if (isTodayFortuneQuestion(question)) return false;
  if (isWeeklyMonthlyQuestion(question)) return false;

  const patterns = [
    // 앞으로/미래 관련
    /앞으로.*(어떻|어떨|될까|흐름)/,
    /앞날.*(어떻|어떨)/,
    /미래.*(어떻|어떨|될까)/,
    /미래가.*(어떻|궁금)/,
    /내 ?미래/,
    /나의 ?미래/,

    // 인생/삶 관련
    /인생.*(어떻|어떨|될까|흐름)/,
    /내 ?인생/,
    /나의 ?인생/,
    /삶.*(어떻|어떨|될까)/,
    /내 ?삶/,
    /나의 ?삶/,
    /인생 ?운세/,
    /인생 ?방향/,

    // 운/운세 일반
    /^운세$/,
    /내 ?운세/,
    /나의 ?운세/,
    /운이? ?어떻/,
    /운세 ?어떻/,
    /전반적인? ?운/,
    /전체 ?운/,
    /총운/,
    /종합 ?운세/,
    /종합운/,

    // 요즘/현재 관련
    /요즘.*(어떻|왜|힘들|좋지|안좋)/,
    /요새.*(어떻|왜|힘들)/,
    /현재.*(상황|상태|어떻)/,
    /지금.*(상황|상태|어떻|왜)/,
    /근황/,

    // 흐름/방향 관련
    /흐름.*(어떻|알고싶|궁금)/,
    /방향.*(어떻|알고싶|잡아)/,
    /기운.*(어떻|좋은|나쁜)/,
    /에너지.*(어떻|좋은|나쁜)/,

    // 좋아질/나아질 관련
    /좋아질까/,
    /나아질까/,
    /괜찮아질까/,
    /풀릴까/,
    /해결될까/,
    /잘 ?될까/,
    /잘될까/,

    // 조언/메시지 관련
    /조언.*(해줘|부탁|구해|얻고)/,
    /메시지.*(있|줘|알려)/,
    /카드.*(뽑아|봐줘|한장)/,
    /한장 ?뽑아/,
    /카드 ?한장/,
    /뭘 ?알려/,
    /뭐라고 ?해/,

    // 왜 이런지 관련
    /왜 ?이렇/,
    /왜 ?이런/,
    /왜 ?안 ?풀/,
    /왜 ?안풀/,
    /뭐가 ?문제/,
    /무엇이 ?문제/,
    /원인이? ?뭘까/,
    /이유가? ?뭘까/,

    // 어떻게 해야 관련
    /어떻게 ?해야/,
    /어떻게 ?하면/,
    /어떻게 ?살아야/,
    /어떻게 ?해/,
    /뭘 ?해야/,
    /무엇을 ?해야/,

    // 영어 패턴
    /my (life|future|fortune)/i,
    /what.*(future|ahead|store)/i,
    /how.*(my life|things|everything)/i,
    /general reading/i,
    /overall.*(fortune|luck|reading)/i,
    /advice/i,
    /guidance/i,
    /what should i (do|know)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 학업/공부 운세 질문 감지
function isStudyFortuneQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "공부할까?")
  if (isYesNoQuestion(question)) return false;
  // 면접/시험 결과는 별도 처리
  if (isExamInterviewQuestion(question)) return false;

  const patterns = [
    // 학업 운세 관련
    /학업 ?운|학업운/,
    /공부 ?운|공부운/,
    /학습 ?운/,
    /성적.*(오를|어떻|좋아질|나올)/,
    /성적이? ?어떻/,
    /성적 ?전망/,
    /학점.*(어떻|오를|나올)/,

    // 공부 관련
    /공부.*(잘|어떻|될까|방향)/,
    /공부가? ?잘/,
    /공부 ?방법/,
    /학습.*(어떻|잘|될까)/,
    /집중.*(잘|어떻|될까)/,
    /집중력.*(어떻|좋아질)/,

    // 학교/대학 관련
    /학교.*(어떻|잘|적응)/,
    /대학.*(어떻|적응|생활)/,
    /대학교.*(어떻|적응)/,
    /학교생활.*(어떻|잘)/,
    /캠퍼스.*(어떻|적응)/,

    // 전공/진학 관련
    /전공.*(어떻|맞을까|바꿀까|선택)/,
    /진학.*(어떻|방향|해야)/,
    /유학.*(어떻|갈까|좋을까|가야)/,
    /편입.*(어떻|될까|성공)/,
    /복학.*(어떻|해야)/,
    /휴학.*(어떻|해야)/,

    // 졸업/학위 관련
    /졸업.*(어떻|할 수|가능)/,
    /학위.*(어떻|받을)/,
    /논문.*(어떻|잘|통과)/,

    // 수능/입시 관련 (결과가 아닌 준비)
    /수능.*(준비|공부|어떻게)/,
    /입시.*(준비|전략|어떻게)/,
    /내신.*(어떻|올릴|관리)/,

    // 영어 패턴
    /study.*(fortune|luck|how|well)/i,
    /grades/i,
    /academic.*(performance|fortune)/i,
    /school.*(life|how)/i,
    /college.*(life|how)/i,
    /major/i,
  ];
  return patterns.some(p => p.test(question));
}

// 이사/주거 운세 질문 감지
function isMovingQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "이사할까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 이사 운세 관련
    /이사 ?운|이사운/,
    /이사.*(어떻|좋을까|시기|방향|언제)/,
    /이사 ?시기/,
    /이사 ?방향/,
    /이사 ?방위/,
    /이사 ?날짜/,
    /이사철/,
    /이삿날/,

    // 집/주거 관련
    /집.*(구할|찾을|어떻|운|언제)/,
    /집 ?구하기/,
    /집 ?운/,
    /주거.*(운|어떻|안정)/,
    /거주.*(어떻|안정)/,
    /살 ?곳/,
    /살 ?집/,

    // 전세/월세/매매 관련
    /전세.*(어떻|구할|찾을|운)/,
    /월세.*(어떻|구할|찾을|운)/,
    /매매.*(어떻|성사|될까)/,
    /부동산.*(어떻|운|거래)/,
    /계약.*(성사|어떻|잘)/,

    // 방향/위치 관련
    /어느 ?방향/,
    /어느 ?동네/,
    /어느 ?지역/,
    /어디로 ?이사/,
    /어디가 ?좋을까/,
    /남향|북향|동향|서향/,

    // 신축/리모델링 관련
    /신축.*(어떻|입주)/,
    /입주.*(어떻|시기|언제)/,
    /리모델링.*(어떻|해야)/,
    /인테리어.*(어떻|운)/,

    // 영어 패턴
    /moving.*(fortune|luck|when|where)/i,
    /relocation/i,
    /new home/i,
    /apartment.*(hunt|search|find)/i,
    /house.*(hunt|search|find)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 여행 운세 질문 감지
function isTravelQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "여행 갈까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 여행 운세 관련
    /여행 ?운|여행운/,
    /여행.*(어떻|좋을까|언제|어디로)/,
    /여행 ?시기/,
    /여행 ?계획/,
    /여행지.*(어디|추천|어떻)/,

    // 해외/국내 여행
    /해외.*(여행|어떻|좋을까|언제)/,
    /해외여행.*(어떻|좋을까)/,
    /국내.*(여행|어떻)/,
    /국내여행.*(어떻)/,

    // 출장 관련
    /출장.*(어떻|잘|될까|운)/,
    /출장 ?운/,
    /해외출장.*(어떻|잘)/,

    // 휴가 관련
    /휴가.*(어떻|언제|어디)/,
    /휴가 ?계획/,
    /바캉스.*(어떻|언제|어디)/,

    // 비행/교통 관련
    /비행기.*(어떻|안전|괜찮)/,
    /비행.*(안전|어떻)/,
    /장거리.*(어떻|괜찮)/,

    // 특정 여행지
    /일본.*(여행|어떻)/,
    /유럽.*(여행|어떻)/,
    /미국.*(여행|어떻)/,
    /동남아.*(여행|어떻)/,
    /제주.*(여행|어떻)/,

    // 영어 패턴
    /travel.*(fortune|luck|when|where|how)/i,
    /trip.*(fortune|luck|when|where)/i,
    /vacation.*(fortune|luck|when|where)/i,
    /flight.*(safe|how)/i,
    /abroad/i,
  ];
  return patterns.some(p => p.test(question));
}

// 직장 내 관계 질문 감지
function isWorkRelationQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 상사 관련
    /상사.*(관계|사이|어떻|갈등|마음)/,
    /사장.*(관계|사이|어떻|마음)/,
    /사장님.*(관계|어떻|마음)/,
    /팀장.*(관계|사이|어떻|마음)/,
    /부장.*(관계|사이|어떻)/,
    /과장.*(관계|사이|어떻)/,
    /대표.*(관계|사이|어떻|마음)/,
    /윗사람.*(관계|사이|어떻)/,
    /상급자.*(관계|사이|어떻)/,

    // 동료 관련
    /동료.*(관계|사이|어떻|갈등)/,
    /직장동료.*(관계|사이|어떻)/,
    /회사동료.*(관계|사이|어떻)/,
    /팀원.*(관계|사이|어떻)/,
    /같이 ?일하는.*(사람|분)/,

    // 부하직원 관련
    /부하.*(관계|사이|어떻)/,
    /부하직원.*(관계|사이|어떻)/,
    /후배.*(직장|회사).*(관계|사이|어떻)/,
    /팀원.*(관리|어떻)/,

    // 직장 분위기 관련
    /직장.*(분위기|인간관계|관계)/,
    /회사.*(분위기|인간관계|관계)/,
    /사내.*(관계|분위기|정치)/,
    /팀.*(분위기|관계|갈등)/,

    // 갈등/문제 관련
    /직장.*(갈등|스트레스|힘들)/,
    /회사.*(갈등|스트레스|힘들)/,
    /상사.*(갈등|스트레스)/,
    /동료.*(갈등|문제)/,

    // 영어 패턴
    /boss.*(relationship|how|think)/i,
    /coworker.*(relationship|how)/i,
    /colleague.*(relationship|how)/i,
    /office.*(politics|relationship)/i,
    /workplace.*(relationship|atmosphere)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 법적/계약 문제 질문 감지
function isLegalQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 소송/법적 분쟁 관련
    /소송.*(어떻|이길|질까|결과|승소)/,
    /재판.*(어떻|이길|결과)/,
    /법적.*(분쟁|문제|어떻)/,
    /법정.*(어떻|결과)/,
    /고소.*(어떻|결과|해야)/,
    /고발.*(어떻|결과)/,
    /형사.*(사건|어떻|결과)/,
    /민사.*(사건|어떻|결과)/,

    // 승소/패소 관련
    /승소.*(할까|가능|어떻)/,
    /패소.*(할까|어떻)/,
    /이길.*(수|까)/,
    /질까/,
    /판결.*(어떻|나올)/,

    // 합의/해결 관련
    /합의.*(될까|어떻|가능|해야)/,
    /합의금.*(어떻|받을)/,
    /협의.*(될까|어떻)/,
    /조정.*(어떻|될까)/,
    /중재.*(어떻|될까)/,

    // 계약 분쟁 관련
    /계약.*(분쟁|문제|해지|위반)/,
    /계약서.*(문제|어떻)/,
    /위약금.*(어떻|내야)/,
    /손해배상.*(받을|어떻)/,

    // 이혼/양육권 관련
    /이혼.*(소송|재판|어떻|합의)/,
    /양육권.*(어떻|받을|가질)/,
    /위자료.*(어떻|받을)/,
    /재산분할.*(어떻)/,

    // 상속 관련
    /상속.*(분쟁|문제|어떻|받을)/,
    /유산.*(분쟁|문제|어떻)/,

    // 변호사/법률 관련
    /변호사.*(선임|필요|어떻)/,
    /법률.*(상담|문제|어떻)/,

    // 영어 패턴
    /lawsuit.*(win|lose|result|how)/i,
    /legal.*(dispute|issue|problem)/i,
    /court.*(case|result|how)/i,
    /settlement/i,
    /sue|suing/i,
    /divorce.*(court|lawsuit)/i,
    /custody/i,
  ];
  return patterns.some(p => p.test(question));
}

// 운전/교통 질문 감지
function isDrivingQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "차 살까?", "면허 딸까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 면허 관련
    /면허.*(따다|어떻|합격|시험|운)/,
    /면허 ?시험/,
    /운전면허.*(어떻|따다|합격)/,
    /도로주행.*(어떻|합격)/,
    /필기.*(면허|운전)/,
    /학원.*(운전|자동차)/,

    // 차량 구매 관련 (운세)
    /차.*(운|어떻|좋을까|언제|구매)/,
    /자동차.*(운|어떻|언제|구매)/,
    /중고차.*(어떻|괜찮|운)/,
    /신차.*(어떻|언제|운)/,
    /차량.*(구매|선택|어떻)/,

    // 운전 관련
    /운전.*(어떻|조심|안전|운)/,
    /운전 ?운/,
    /장거리 ?운전/,
    /야간 ?운전/,
    /초보 ?운전/,

    // 교통/이동 관련
    /교통.*(안전|사고|어떻)/,
    /사고.*(날까|조심|어떻)/,
    /교통사고/,
    /접촉사고/,
    /차량사고/,

    // 정비/수리 관련
    /정비.*(어떻|해야)/,
    /수리.*(어떻|해야)/,
    /고장.*(날까|어떻)/,

    // 영어 패턴
    /driving.*(license|test|how)/i,
    /car.*(buy|purchase|fortune)/i,
    /vehicle/i,
    /traffic.*(safe|accident)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 반려동물 질문 감지
function isPetQuestion(question: string): boolean {
  // Yes/No 질문이면 제외 (예: "강아지 키울까?")
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 강아지 관련
    /강아지.*(건강|어떻|상태|병원|아파)/,
    /강아지 ?건강/,
    /개.*(건강|어떻|상태|아파)/,
    /우리 ?강아지/,
    /반려견.*(건강|어떻|상태)/,

    // 고양이 관련
    /고양이.*(건강|어떻|상태|병원|아파)/,
    /고양이 ?건강/,
    /냥이.*(건강|어떻|아파)/,
    /우리 ?고양이/,
    /반려묘.*(건강|어떻|상태)/,

    // 반려동물 일반
    /반려동물.*(건강|어떻|상태|병원)/,
    /반려동물 ?건강/,
    /애완동물.*(건강|어떻|상태)/,
    /펫.*(건강|어떻|상태)/,

    // 특정 동물
    /햄스터.*(건강|어떻|상태)/,
    /토끼.*(건강|어떻|상태)/,
    /새.*(건강|어떻|상태)/,
    /앵무새.*(건강|어떻|상태)/,
    /물고기.*(건강|어떻|상태)/,
    /파충류.*(건강|어떻|상태)/,

    // 동물병원/치료 관련
    /동물병원.*(가야|어떻|결과)/,
    /수술.*(강아지|고양이|반려)/,
    /치료.*(강아지|고양이|반려)/,

    // 입양/분양 관련 (운세)
    /입양.*(강아지|고양이|반려|어떻|언제)/,
    /분양.*(강아지|고양이|반려|어떻|언제)/,
    /데려오.*(어떻|언제)/,

    // 실종/무지개다리 관련
    /실종.*(강아지|고양이|찾을)/,
    /찾을.*(수|까).*(강아지|고양이)/,
    /무지개다리/,
    /하늘나라/,

    // 영어 패턴
    /pet.*(health|how|condition)/i,
    /dog.*(health|how|sick)/i,
    /cat.*(health|how|sick)/i,
    /puppy/i,
    /kitten/i,
    /adopt.*(pet|dog|cat)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 취미/자기계발 질문 감지
function isHobbyQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 취미 관련
    /취미.*(어떻|찾을|맞을|추천|시작)/,
    /취미 ?생활/,
    /취미 ?활동/,
    /새로운 ?취미/,

    // 운동/스포츠 관련
    /운동.*(어떻|맞을|시작|효과)/,
    /헬스.*(어떻|효과|맞을)/,
    /필라테스.*(어떻|효과|맞을)/,
    /요가.*(어떻|효과|맞을)/,
    /수영.*(어떻|효과|맞을)/,
    /골프.*(어떻|효과|맞을|실력)/,
    /테니스.*(어떻|효과|맞을)/,
    /등산.*(어떻|효과|맞을)/,
    /러닝.*(어떻|효과|맞을)/,
    /마라톤.*(어떻|도전|완주)/,

    // 예술/창작 관련
    /그림.*(어떻|배울|실력|재능)/,
    /그리기.*(어떻|배울|실력)/,
    /미술.*(어떻|배울|재능)/,
    /음악.*(어떻|배울|재능)/,
    /악기.*(어떻|배울|재능)/,
    /피아노.*(어떻|배울|실력)/,
    /기타.*(어떻|배울|실력)/,
    /노래.*(어떻|배울|실력)/,
    /보컬.*(어떻|배울|실력)/,
    /춤.*(어떻|배울|재능)/,
    /댄스.*(어떻|배울|재능)/,
    /글쓰기.*(어떻|재능|잘)/,
    /작가.*(될|어떻|재능)/,
    /사진.*(어떻|배울|재능)/,
    /영상.*(어떻|배울|재능)/,

    // 자기계발 관련
    /자기계발.*(어떻|방향|뭘)/,
    /성장.*(어떻|방향|할)/,
    /발전.*(어떻|방향|할)/,
    /실력.*(늘|오를|어떻)/,
    /능력.*(키울|개발|어떻)/,
    /재능.*(있을까|어떻|발견)/,
    /잠재력/,
    /역량.*(개발|키울)/,

    // 자격증/스킬 관련 (학업과 구분)
    /스킬.*(배울|어떻|추천)/,
    /기술.*(배울|어떻|추천)/,
    /언어.*(배울|어떻|맞을)/,
    /외국어.*(배울|어떻|맞을)/,

    // 영어 패턴
    /hobby.*(how|find|start)/i,
    /self.?improvement/i,
    /skill.*(learn|develop)/i,
    /talent/i,
    /creative/i,
    /art.*(learn|talent)/i,
    /music.*(learn|talent)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 우정/인간관계 질문 감지 (연애/가족 외)
function isFriendshipQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 가족 관계는 별도 처리
  if (isFamilyRelationQuestion(question)) return false;
  // 직장 관계는 별도 처리
  if (isWorkRelationQuestion(question)) return false;

  const patterns = [
    // 친구 관련
    /친구.*(관계|사이|어떻|갈등|화해|마음)/,
    /친구와.*(사이|관계|어떻)/,
    /우정.*(어떻|계속|끝날)/,
    /절친.*(관계|사이|어떻)/,
    /베프.*(관계|사이|어떻)/,
    /단짝.*(관계|사이|어떻)/,

    // 지인/선후배 관련
    /선배.*(관계|사이|어떻|마음)/,
    /후배.*(관계|사이|어떻|마음)/,
    /지인.*(관계|사이|어떻)/,
    /아는 ?사람.*(관계|어떻)/,

    // 모임/커뮤니티 관련
    /모임.*(사람들|관계|어떻)/,
    /동호회.*(사람들|관계|어떻)/,
    /커뮤니티.*(관계|어떻)/,
    /동창.*(관계|사이|어떻)/,
    /동문.*(관계|사이|어떻)/,

    // 인간관계 일반
    /인간관계.*(어떻|개선|좋아질)/,
    /대인관계.*(어떻|개선|좋아질)/,
    /사람들.*(관계|어떻|사이)/,
    /주변 ?사람/,
    /사회생활.*(어떻|잘)/,

    // 갈등/화해 관련
    /오해.*(풀릴|어떻|해소)/,
    /갈등.*(해결|어떻|풀릴)/,
    /싸운.*(후|뒤|화해)/,
    /다툼.*(후|뒤|화해)/,
    /연락.*(끊긴|두절|다시)/,

    // 새 인연 관련
    /새 ?친구/,
    /새로운 ?인연/,
    /좋은 ?사람.*(만날|언제)/,
    /인맥.*(넓힐|어떻)/,

    // 영어 패턴
    /friend.*(relationship|how|feel)/i,
    /friendship/i,
    /social.*(life|relationship)/i,
    /people.*(around|how)/i,
    /reconnect/i,
  ];
  return patterns.some(p => p.test(question));
}

// 경쟁/시합/대회 질문 감지
function isCompetitionQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 면접/시험은 별도 처리
  if (isExamInterviewQuestion(question)) return false;

  const patterns = [
    // 대회/경연 관련
    /대회.*(결과|이길|어떻|나갈|참가)/,
    /경연.*(결과|이길|어떻|참가)/,
    /콘테스트.*(결과|어떻|참가)/,
    /공모전.*(결과|어떻|당선|입상)/,
    /오디션.*(결과|어떻|붙을)/,

    // 경쟁/경기 관련
    /경쟁.*(이길|어떻|결과)/,
    /경기.*(이길|어떻|결과|승패)/,
    /시합.*(이길|어떻|결과)/,
    /매치.*(이길|어떻|결과)/,
    /게임.*(이길|어떻|결과)/,
    /토너먼트.*(결과|어떻)/,

    // 승패 관련
    /이길.*(수|까|어떻)/,
    /승리.*(할|어떻|가능)/,
    /우승.*(할|어떻|가능)/,
    /입상.*(할|어떻|가능)/,
    /수상.*(할|어떻|가능)/,
    /메달.*(딸|어떻|가능)/,
    /상금.*(받을|어떻)/,

    // 스포츠 경기 관련
    /축구.*(경기|이길|결과)/,
    /야구.*(경기|이길|결과)/,
    /농구.*(경기|이길|결과)/,
    /배드민턴.*(경기|이길)/,
    /탁구.*(경기|이길)/,
    /골프.*(대회|경기|스코어)/,
    /마라톤.*(대회|완주|기록)/,

    // 입찰/수주 관련
    /입찰.*(결과|성공|어떻|될까)/,
    /수주.*(결과|성공|어떻|될까)/,
    /프로젝트.*(따낼|수주|입찰)/,

    // 선발/선정 관련
    /선발.*(될까|어떻|결과)/,
    /선정.*(될까|어떻|결과)/,
    /뽑힐.*(까|어떻)/,
    /당첨.*(될까|어떻|결과)/,

    // 영어 패턴
    /competition.*(win|result|how)/i,
    /contest.*(win|result|how)/i,
    /tournament/i,
    /match.*(win|result)/i,
    /championship/i,
    /win.*(competition|game|match)/i,
    /bid.*(win|result)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 감정/멘탈 관련 질문 감지 (우울, 불안, 스트레스 등)
function isEmotionalMentalQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 우울/슬픔 관련
    /우울.*(어떻|언제|나아|극복|해소)/,
    /우울증.*(어떻|나아|극복|치료)/,
    /슬퍼.*(어떻|왜|언제)/,
    /슬픔.*(어떻|극복|해소)/,
    /울적.*(어떻|왜|해소)/,
    /눈물.*(왜|나오|멈출)/,
    /외로.*(어떻|왜|해소|언제)/,
    /외로움.*(어떻|극복|해소)/,
    /공허.*(어떻|왜|채울)/,
    /허무.*(어떻|왜|극복)/,

    // 불안/걱정 관련
    /불안.*(어떻|왜|해소|극복)/,
    /불안감.*(어떻|해소|극복)/,
    /걱정.*(어떻|많아|해소|줄이)/,
    /초조.*(어떻|왜|해소)/,
    /긴장.*(어떻|왜|풀|해소)/,
    /두려.*(어떻|왜|극복)/,
    /무서.*(어떻|왜|극복)/,
    /공포.*(어떻|극복|해소)/,
    /트라우마.*(어떻|극복|치료|해소)/,
    /공황.*(어떻|극복|대처)/,

    // 스트레스 관련
    /스트레스.*(어떻|해소|풀|줄|심해)/,
    /지쳐.*(어떻|왜|언제)/,
    /지침.*(어떻|해소|벗어나)/,
    /피곤.*(어떻|왜|나아|해소)/,
    /번아웃.*(어떻|극복|벗어나)/,
    /탈진.*(어떻|극복|회복)/,

    // 화/분노 관련
    /화.*(나|가|어떻|참을|다스)/,
    /분노.*(어떻|다스|조절|해소)/,
    /짜증.*(어떻|왜|참을|해소)/,
    /열받.*(어떻|왜|참을)/,

    // 자존감/자신감 관련
    /자존감.*(어떻|낮|높|올리|회복)/,
    /자신감.*(어떻|없|생기|올리)/,
    /자괴감.*(어떻|왜|극복)/,
    /열등감.*(어떻|극복|없애)/,
    /자책.*(어떻|그만|멈출)/,

    // 심리/마음 상태
    /마음.*(안정|불안|힘들|어떻)/,
    /심리.*(상태|어떻|안정)/,
    /멘탈.*(어떻|관리|회복|흔들)/,
    /정서.*(어떻|안정|불안)/,
    /감정.*(어떻|다스|조절|기복)/,
    /기분.*(어떻|안좋|좋아|나아)/,

    // 인생/존재 관련
    /살기.*(싫|어려|힘들)/,
    /삶.*(의미|무의미|힘들|어떻)/,
    /왜.*(살아야|사는지|힘들)/,
    /의미.*(없|찾을|뭔지)/,
    /목표.*(없|찾을|잃)/,
    /방향.*(잃|못찾|어떻)/,

    // 영어 패턴
    /depress.*(how|feel|better|overcome)/i,
    /anxiety.*(how|manage|overcome|reduce)/i,
    /stress.*(how|manage|reduce|relief)/i,
    /mental.*(health|state|how)/i,
    /emotional.*(state|how|stability)/i,
    /sad.*(feel|why|how|better)/i,
    /lonely.*(feel|how|overcome)/i,
    /angry.*(feel|how|manage)/i,
    /worried.*(about|how|feel)/i,
    /scared.*(of|how|feel)/i,
    /self.?esteem/i,
    /confidence.*(lack|build|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 꿈 해석/해몽 관련 질문 감지
function isDreamInterpretQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 꿈 해몽 기본
    /꿈.*(해몽|의미|뜻|해석)/,
    /꿈에.*(나왔|봤|등장)/,
    /꿈을.*(꿨|꾸었|봤)/,
    /꿈꿨.*(어|는데|을때)/,
    /꿈속.*(에서|의)/,
    /무슨 ?꿈/,
    /어떤 ?꿈/,

    // 특정 꿈 유형
    /태몽.*(의미|뜻|해석|인가)/,
    /길몽.*(인가|일까)/,
    /흉몽.*(인가|일까)/,
    /악몽.*(꿔|왜|의미|해석)/,
    /반복.*(꿈|몽)/,
    /예지몽.*(인가|일까)/,
    /생생한 ?꿈/,

    // 꿈 내용 관련
    /꿈에서.*(죽|물|불|뱀|호랑이|돼지|개|고양이|강아지)/,
    /꿈에.*(떨어|날아|도망|쫓기|잡히)/,
    /죽는.*(꿈|몽)/,
    /떨어지는.*(꿈|몽)/,
    /쫓기는.*(꿈|몽)/,
    /나는.*(꿈|몽)/,
    /물에.*(빠지|잠기)/,
    /불.*(꿈|나는)/,
    /뱀.*(꿈|나오)/,
    /돼지.*(꿈|나오)/,
    /호랑이.*(꿈|나오)/,
    /조상.*(꿈|나오)/,
    /돌아가신.*(분|사람).*(꿈|나오)/,

    // 영어 패턴
    /dream.*(meaning|interpret|about|had|saw)/i,
    /dreamt.*(about|of)/i,
    /nightmare.*(meaning|why|had)/i,
    /vision.*(meaning|saw|had)/i,
    /what.*(dream|dreamt)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 전생/영적/인연 관련 질문 감지
function isSpiritualPastLifeQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 전생 관련
    /전생.*(에서|의|뭐였|어땠|인연|관계)/,
    /전생에.*(뭐|무엇|누구|어떤)/,
    /과거생.*(에서|의|뭐였)/,
    /이전 ?생/,
    /전세.*(에서|의)/,

    // 카르마/업보 관련
    /카르마.*(어떻|뭐|해소|풀)/,
    /업보.*(어떻|뭐|해소|풀)/,
    /업.*(뭐|어떻|받고)/,
    /인과.*(응보|관계|어떻)/,
    /숙명.*(어떻|뭐|인가)/,

    // 영적/영혼 관련
    /영혼.*(어떻|상태|성장|메시지)/,
    /영적.*(성장|메시지|어떻|상태)/,
    /영성.*(어떻|발전|성장)/,
    /소울메이트.*(인가|일까|어떻|누구)/,
    /영적 ?인연/,
    /영혼 ?계약/,
    /가이드.*(영|천사|메시지)/,
    /수호.*(천사|령|신)/,

    // 인연/운명 관련
    /전생.*(인연|연결|관계)/,
    /악연.*(인가|어떻|끊을)/,
    /인연.*(전생|운명|숙명|어떤)/,
    /운명.*(인연|연결|어떻)/,
    /빚.*(전생|인연|갚)/,
    /인연의 ?끈/,

    // 초자연적 경험
    /빙의.*(인가|당한|어떻)/,
    /귀신.*(보|느껴|붙었)/,
    /기.*(느껴|감지|읽)/,
    /오라.*(색|어떻|보)/,
    /차크라.*(어떻|열|막힌)/,

    // 영어 패턴
    /past.?life.*(who|what|how|connection)/i,
    /karma.*(what|how|clear|release)/i,
    /soul.?mate/i,
    /spiritual.*(growth|message|guide|connection)/i,
    /reincarnation/i,
    /destiny.*(connection|fate)/i,
    /aura.*(color|reading)/i,
    /chakra.*(blocked|open|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 결혼/약혼/프로포즈 관련 질문 감지
function isMarriageProposalQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 인연찾기와 구분
  if (isFindingPartnerQuestion(question)) return false;

  const patterns = [
    // 결혼 관련
    /결혼 ?운|결혼운/,
    /결혼.*(언제|시기|어떻|전망|상대)/,
    /혼인.*(운|언제|시기|어떻)/,
    /시집.*(언제|갈까|어떻)/,
    /장가.*(언제|갈까|어떻)/,
    /배우자.*(운|어떤|어떻|만날)/,
    /신랑.*(어떤|어떻|될)/,
    /신부.*(어떤|어떻|될)/,
    /결혼 ?상대/,
    /혼사.*(어떻|잘)/,

    // 프로포즈/약혼 관련
    /프로포즈.*(언제|어떻|할까|받을)/,
    /청혼.*(언제|어떻|할까|받을)/,
    /약혼.*(언제|어떻|할까)/,
    /반지.*(사|줄|받을|언제)/,

    // 결혼 생활 관련
    /결혼생활.*(어떻|전망|잘)/,
    /부부.*(관계|사이|어떻|운)/,
    /신혼.*(생활|어떻)/,
    /시댁.*(관계|어떻|잘)/,
    /처가.*(관계|어떻|잘)/,
    /시어머니.*(관계|어떻)/,
    /장인.*(관계|어떻)/,
    /장모.*(관계|어떻)/,

    // 재혼/이혼 후 관련
    /재혼.*(운|언제|어떻|할까)/,
    /이혼 ?후.*(재혼|인연|언제)/,

    // 결혼 적령기
    /결혼.*(적령|나이|때)/,
    /몇 ?살.*(결혼|시집|장가)/,

    // 영어 패턴
    /marriage.*(when|how|fortune|luck|partner)/i,
    /wedding.*(when|how|plan)/i,
    /proposal.*(when|how|will)/i,
    /engagement.*(when|how)/i,
    /spouse.*(how|what|when)/i,
    /husband.*(future|how|what)/i,
    /wife.*(future|how|what)/i,
    /married.*(life|when|how)/i,
    /remarriage/i,
  ];
  return patterns.some(p => p.test(question));
}

// 부동산/투자/매매 관련 질문 감지
function isRealEstateQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 이사 질문과 구분
  if (isMovingQuestion(question)) return false;

  const patterns = [
    // 부동산 매매 관련
    /부동산.*(운|어떻|투자|매매|사야|팔아)/,
    /집.*(사야|팔아야|매매|거래|어떻)/,
    /아파트.*(사야|팔아야|매매|투자|어떻)/,
    /빌라.*(사야|팔아야|매매)/,
    /오피스텔.*(사야|팔아야|투자)/,
    /상가.*(사야|팔아야|투자|어떻)/,
    /토지.*(사야|팔아야|투자)/,
    /땅.*(사야|팔아야|투자)/,
    /건물.*(사야|팔아야|투자)/,

    // 전세/월세 관련
    /전세.*(올려|내려|어떻|시기)/,
    /월세.*(올려|어떻|수익)/,
    /임대.*(어떻|수익|투자)/,
    /임차.*(어떻|갱신)/,
    /보증금.*(어떻|올려)/,
    /갭투자.*(어떻|괜찮)/,

    // 투자 관련
    /부동산 ?투자/,
    /재개발.*(어떻|투자|될까)/,
    /재건축.*(어떻|투자|될까)/,
    /분양.*(받을까|어떻|시기)/,
    /청약.*(어떻|당첨|넣을)/,
    /경매.*(어떻|참여|낙찰)/,
    /공매.*(어떻|참여)/,

    // 시세/가격 관련
    /집값.*(오를|내릴|어떻)/,
    /부동산.*(시세|가격|전망)/,
    /시세.*(오를|내릴|어떻)/,
    /매도.*(시기|언제|어떻)/,
    /매수.*(시기|언제|어떻)/,

    // 대출 관련 (부동산)
    /주택담보.*(대출|어떻)/,
    /모기지.*(어떻|괜찮)/,
    /대출.*(받을까|가능|어떻).*(집|부동산|아파트)/,

    // 영어 패턴
    /real.?estate.*(invest|buy|sell|how|fortune)/i,
    /property.*(invest|buy|sell|how)/i,
    /house.*(buy|sell|invest|market)/i,
    /apartment.*(buy|sell|invest)/i,
    /mortgage.*(how|should)/i,
    /housing.*(market|price|invest)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 자녀/출산/육아 관련 질문 감지
function isChildrenQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 임신/출산 관련
    /임신.*(될까|가능|언제|운|어떻)/,
    /아이.*(가질|낳을|언제|운|어떻)/,
    /아기.*(가질|낳을|언제|생길)/,
    /출산.*(운|언제|어떻|시기)/,
    /태어날.*(아이|아기|시기)/,
    /시험관.*(어떻|성공|될까)/,
    /인공수정.*(어떻|성공)/,
    /불임.*(어떻|극복|치료)/,
    /난임.*(어떻|극복|치료)/,
    /둘째.*(가질|낳을|언제)/,
    /셋째.*(가질|낳을|언제)/,

    // 자녀 운/관계 관련
    /자녀 ?운|자녀운/,
    /자녀.*(관계|사이|어떻|운)/,
    /아들.*(될까|낳을|어떻|관계)/,
    /딸.*(될까|낳을|어떻|관계)/,
    /자식.*(운|복|어떻|관계)/,

    // 육아/양육 관련
    /육아.*(어떻|힘들|잘)/,
    /양육.*(어떻|방법|잘)/,
    /아이 ?교육/,
    /자녀 ?교육/,
    /훈육.*(어떻|방법)/,
    /사춘기.*(어떻|대처|힘들)/,

    // 학교/진로 관련 (자녀)
    /아이.*(학교|진로|적성|성적)/,
    /자녀.*(학교|진로|적성|성적)/,
    /우리 ?아이.*(어떻|잘|될까)/,

    // 영어 패턴
    /pregnan.*(when|how|possible|fortune)/i,
    /child.*(fortune|luck|have|when)/i,
    /baby.*(have|when|fortune)/i,
    /fertility/i,
    /parenting.*(how|advice)/i,
    /son.*(fortune|how|relationship)/i,
    /daughter.*(fortune|how|relationship)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 운 변화/터닝포인트 질문 감지
function isLuckChangeQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 타이밍 질문과 구분
  if (isTimingQuestion(question)) return false;

  const patterns = [
    // 운 변화 관련
    /운.*(바뀔|변할|좋아질|나아질|풀릴)/,
    /운이.*(바뀌|변하|좋아|나아|풀리)/,
    /운세.*(바뀔|변할|언제|전환)/,
    /팔자.*(바뀔|변할|고칠)/,
    /흐름.*(바뀔|변할|좋아질)/,
    /기운.*(바뀔|변할|좋아질)/,

    // 터닝포인트 관련
    /터닝.?포인트/,
    /전환점.*(언제|올까|있을까)/,
    /변곡점/,
    /기회.*(언제|올까|어떻)/,
    /행운.*(언제|올까|찾아)/,

    // 시기/시점 관련 (운 변화)
    /좋은 ?시기.*(언제|올까)/,
    /나쁜 ?시기.*(언제|지날)/,
    /힘든 ?시기.*(언제|끝날|지날)/,
    /어려운 ?시기.*(언제|끝날|지날)/,
    /암흑기.*(언제|끝날|지날)/,
    /호시절.*(언제|올까)/,
    /전성기.*(언제|올까)/,

    // 운세 흐름 관련
    /앞으로.*(운|운세|어떻)/,
    /내년.*(운|운세|어떻)/,
    /올해.*(운|운세|어떻)/,
    /다음달.*(운|운세|어떻)/,
    /이번달.*(운|운세|어떻)/,

    // 영어 패턴
    /luck.*(change|turn|improve|better)/i,
    /fortune.*(change|turn|improve)/i,
    /turning.?point/i,
    /when.*(luck|fortune).*(change|improve)/i,
    /breakthrough/i,
  ];
  return patterns.some(p => p.test(question));
}

// 도박/복권/횡재 관련 질문 감지
function isGamblingLotteryQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 복권/로또 관련
    /복권.*(당첨|될까|살까|운|어떻)/,
    /로또.*(당첨|될까|살까|번호|운)/,
    /당첨.*(될까|운|가능|확률)/,
    /연금복권.*(어떻|살까)/,
    /스크래치.*(어떻|살까|긁을까)/,

    // 도박/게임 관련
    /도박.*(운|어떻|해도)/,
    /카지노.*(운|어떻|가도)/,
    /슬롯.*(운|어떻)/,
    /포커.*(운|어떻)/,
    /블랙잭.*(운|어떻)/,
    /바카라.*(운|어떻)/,
    /경마.*(운|어떻|베팅)/,
    /경륜.*(운|어떻)/,
    /토토.*(운|어떻|베팅)/,
    /스포츠.?베팅/,

    // 횡재/일확천금 관련
    /횡재.*(운|될까|언제|어떻)/,
    /일확천금/,
    /대박.*(날까|터질까|운)/,
    /벼락.?부자/,
    /떼돈.*(벌|어떻)/,
    /뜻밖의 ?돈/,
    /갑자기 ?돈/,

    // 투기 관련
    /투기.*(운|어떻|해도)/,
    /코인.*(운|어떻|살까|오를까)/,
    /비트코인.*(운|어떻|살까)/,
    /주식.*(대박|급등|어떻)/,
    /선물.*(거래|운|어떻)/,
    /옵션.*(거래|운|어떻)/,

    // 영어 패턴
    /lottery.*(win|fortune|luck|number)/i,
    /gambl.*(luck|fortune|how)/i,
    /casino.*(luck|fortune)/i,
    /jackpot/i,
    /windfall/i,
    /crypto.*(fortune|luck|buy)/i,
    /bitcoin.*(fortune|buy|invest)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 외모/패션/이미지 관련 질문 감지
function isBeautyFashionQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 외모/성형 관련
    /성형.*(할까|어떻|결과|운)/,
    /수술.*(외모|얼굴|코|눈|턱)/,
    /쌍꺼풀.*(할까|어떻)/,
    /코 ?수술.*(할까|어떻)/,
    /필러.*(할까|어떻|맞을까)/,
    /보톡스.*(할까|어떻|맞을까)/,
    /시술.*(할까|어떻|받을까)/,
    /외모.*(어떻|개선|바꿀)/,
    /얼굴.*(어떻|바꿀|개선)/,

    // 헤어/스타일 관련
    /머리.*(자를까|스타일|바꿀까|염색)/,
    /헤어.*(스타일|바꿀|어떻)/,
    /파마.*(할까|어떻)/,
    /염색.*(할까|어떻|색)/,
    /탈모.*(어떻|치료|나아질)/,

    // 다이어트/체형 관련
    /다이어트.*(성공|어떻|방법)/,
    /살.*(빠질|뺄|어떻)/,
    /체중.*(감량|어떻|줄)/,
    /몸매.*(어떻|만들|관리)/,
    /피부.*(어떻|관리|좋아질)/,
    /여드름.*(어떻|나아질|치료)/,

    // 패션/스타일 관련
    /패션.*(어떻|스타일|바꿀)/,
    /스타일.*(어떻|바꿀|찾을)/,
    /옷.*(어떻|스타일|어울리)/,
    /이미지.*(어떻|바꿀|변신)/,
    /코디.*(어떻|방법)/,
    /퍼스널.?컬러/,

    // 매력/인상 관련
    /매력.*(어떻|올릴|높일)/,
    /인상.*(어떻|바꿀|좋게)/,
    /첫인상.*(어떻|좋게)/,
    /관상.*(어떻|바꿀|좋게)/,

    // 영어 패턴
    /plastic.?surgery.*(should|how|result)/i,
    /beauty.*(how|improve|fortune)/i,
    /fashion.*(style|how|change)/i,
    /hair.*(style|cut|color|change)/i,
    /diet.*(success|how|work)/i,
    /appearance.*(change|improve|how)/i,
    /makeover/i,
  ];
  return patterns.some(p => p.test(question));
}

// SNS/온라인/영향력 관련 질문 감지
function isSocialMediaQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // SNS/소셜미디어 관련
    /인스타.*(어떻|운|성공|팔로워)/,
    /유튜브.*(어떻|운|성공|구독자)/,
    /틱톡.*(어떻|운|성공)/,
    /트위터.*(어떻|운)/,
    /페이스북.*(어떻|운)/,
    /SNS.*(어떻|운|성공)/,
    /소셜.?미디어.*(어떻|운)/,

    // 인플루언서/크리에이터 관련
    /인플루언서.*(될|어떻|성공)/,
    /크리에이터.*(될|어떻|성공)/,
    /스트리머.*(될|어떻|성공)/,
    /BJ.*(될|어떻|성공)/,
    /유튜버.*(될|어떻|성공)/,
    /블로거.*(될|어떻|성공)/,

    // 콘텐츠/채널 관련
    /채널.*(어떻|성장|운)/,
    /콘텐츠.*(어떻|성공|운)/,
    /영상.*(어떻|성공|잘)/,
    /팔로워.*(늘|어떻|몇)/,
    /구독자.*(늘|어떻|몇)/,
    /조회수.*(늘|어떻|올)/,
    /바이럴.*(될까|어떻)/,
    /알고리즘.*(어떻|잘)/,

    // 온라인 비즈니스 관련
    /온라인.*(사업|비즈니스|판매)/,
    /스마트.?스토어.*(어떻|운)/,
    /쇼핑몰.*(어떻|운|잘)/,
    /라이브.?커머스.*(어떻)/,
    /부업.*(어떻|성공|운)/,

    // 영어 패턴
    /instagram.*(fortune|success|how|followers)/i,
    /youtube.*(fortune|success|how|subscribers)/i,
    /tiktok.*(fortune|success|how)/i,
    /influencer.*(become|success|how)/i,
    /content.?creator/i,
    /social.?media.*(success|fortune|how)/i,
    /viral/i,
    /followers.*(grow|how|increase)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 군대/입대/전역 관련 질문 감지
function isMilitaryQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 입대/군대 관련
    /입대.*(언제|시기|어떻|운)/,
    /군대.*(언제|가야|어떻|운)/,
    /군 ?입대/,
    /현역.*(판정|어떻|될까)/,
    /공익.*(될까|어떻|판정)/,
    /사회복무.*(어떻|될까)/,
    /병역.*(어떻|운|판정)/,
    /징집.*(어떻|언제)/,

    // 군생활 관련
    /군생활.*(어떻|잘|적응)/,
    /군복무.*(어떻|잘)/,
    /훈련소.*(어떻|잘)/,
    /자대.*(어떻|배치)/,
    /보직.*(어떻|좋을)/,
    /특기.*(어떻|배정)/,
    /휴가.*(나올|언제|어떻)/,

    // 전역/제대 관련
    /전역.*(언제|어떻|후)/,
    /제대.*(언제|어떻|후)/,
    /만기.?전역/,
    /조기.?전역/,
    /군필.*(후|어떻)/,

    // 장교/부사관 관련
    /장교.*(될까|어떻|시험)/,
    /부사관.*(될까|어떻|시험)/,
    /학사장교.*(어떻|될까)/,
    /ROTC.*(어떻|될까)/,
    /학군단.*(어떻|될까)/,
    /간부.*(될까|어떻)/,

    // 대체복무 관련
    /대체복무.*(어떻|될까)/,
    /산업기능요원.*(어떻|될까)/,
    /전문연구요원.*(어떻|될까)/,

    // 영어 패턴
    /military.*(service|when|how)/i,
    /army.*(when|how|fortune)/i,
    /enlist.*(when|how)/i,
    /discharge.*(when|how)/i,
    /conscription/i,
  ];
  return patterns.some(p => p.test(question));
}

// 유산/상속/증여 관련 질문 감지
function isInheritanceQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 상속 관련
    /상속.*(받을|어떻|운|분쟁|문제)/,
    /유산.*(받을|어떻|운|분쟁|나눌)/,
    /물려받.*(을|어떻|운)/,
    /재산.*(상속|물려|나눌|어떻)/,
    /상속세.*(어떻|얼마)/,
    /상속 ?분쟁/,
    /상속 ?포기/,

    // 증여 관련
    /증여.*(받을|할까|어떻|운)/,
    /증여세.*(어떻|얼마)/,
    /사전.?증여/,
    /생전.?증여/,
    /재산.*(증여|나눠)/,

    // 유언/유언장 관련
    /유언.*(어떻|작성|효력)/,
    /유언장.*(어떻|작성)/,
    /법정.?상속/,
    /상속인.*(누구|어떻)/,
    /상속권.*(어떻|있을)/,

    // 가족 재산 분쟁
    /형제.*(상속|재산|분쟁)/,
    /부모님.*(재산|유산|상속)/,
    /집안.*(재산|유산|상속)/,
    /재산.*(분쟁|다툼|싸움)/,

    // 영어 패턴
    /inherit.*(ance|how|when|fortune)/i,
    /estate.*(inherit|will|fortune)/i,
    /will.*(inherit|estate)/i,
    /bequest/i,
    /legacy.*(receive|fortune)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 종교/신앙/수행 관련 질문 감지
function isReligionSpiritualityQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 전생/영적과 구분
  if (isSpiritualPastLifeQuestion(question)) return false;

  const patterns = [
    // 종교 일반
    /종교.*(어떻|맞을|찾을|운)/,
    /신앙.*(어떻|깊어|찾을)/,
    /믿음.*(어떻|찾을|흔들)/,
    /기도.*(어떻|응답|효과)/,

    // 불교 관련
    /절.*(가야|다니|어떻)/,
    /불교.*(어떻|맞을|인연)/,
    /스님.*(만날|상담|어떻)/,
    /참선.*(어떻|효과)/,
    /수행.*(어떻|해야|방법)/,
    /명상.*(어떻|효과|방법)/,
    /해탈.*(어떻|가능)/,
    /업장.*(어떻|소멸|해소)/,

    // 기독교 관련
    /교회.*(가야|다니|어떻)/,
    /기독교.*(어떻|맞을)/,
    /목사님.*(상담|만날)/,
    /성경.*(읽을|공부)/,
    /찬양.*(어떻|은사)/,
    /성령.*(충만|받을|은사)/,
    /세례.*(받을|어떻)/,

    // 천주교 관련
    /성당.*(가야|다니|어떻)/,
    /천주교.*(어떻|맞을)/,
    /신부님.*(상담|만날)/,
    /미사.*(어떻|참례)/,
    /영성.*(어떻|성장)/,

    // 기타 종교/수행
    /무속.*(어떻|신내림)/,
    /굿.*(해야|어떻|받을)/,
    /신내림.*(받을|어떻)/,
    /무당.*(될까|어떻)/,
    /사주.*(풀이|해석)/,
    /점.*(봐야|맞을)/,

    // 영어 패턴
    /religion.*(find|right|fortune|how)/i,
    /faith.*(find|grow|how)/i,
    /spiritual.*(practice|path|growth)/i,
    /meditation.*(how|effect|practice)/i,
    /prayer.*(answer|how|work)/i,
    /church.*(go|attend|how)/i,
    /buddhism.*(practice|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 중독/습관/극복 관련 질문 감지
function isAddictionHabitQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 중독 관련
    /중독.*(어떻|극복|끊을|치료)/,
    /의존.*(어떻|극복|벗어나)/,
    /게임.?중독.*(어떻|극복)/,
    /도박.?중독.*(어떻|극복)/,
    /알코올.?중독.*(어떻|극복)/,
    /술.?중독.*(어떻|극복)/,
    /쇼핑.?중독.*(어떻|극복)/,
    /폰.?중독.*(어떻|극복)/,
    /SNS.?중독.*(어떻|극복)/,
    /유튜브.?중독.*(어떻|극복)/,

    // 나쁜 습관 극복
    /습관.*(고칠|바꿀|끊을|어떻)/,
    /버릇.*(고칠|어떻|없앨)/,
    /끊을.*(수|어떻|방법)/,
    /그만.?둘.*(수|어떻)/,
    /참을.*(수|어떻)/,

    // 특정 습관
    /담배.*(끊을|줄일|어떻)/,
    /술.*(끊을|줄일|어떻)/,
    /야식.*(끊을|줄일|어떻)/,
    /과식.*(어떻|극복|줄일)/,
    /폭식.*(어떻|극복|치료)/,
    /미루.*(는|기|습관)/,
    /게으름.*(어떻|극복)/,
    /늦잠.*(어떻|고칠)/,

    // 좋은 습관 만들기
    /운동.*(습관|꾸준히|어떻)/,
    /일찍.*(일어나|자는).*(어떻|습관)/,
    /독서.*(습관|어떻)/,
    /명상.*(습관|어떻)/,
    /루틴.*(만들|어떻)/,

    // 영어 패턴
    /addict.*(overcome|quit|how|break)/i,
    /habit.*(break|change|how|bad|good)/i,
    /quit.*(smoking|drinking|gaming)/i,
    /overcome.*(addiction|habit)/i,
    /self.?control/i,
  ];
  return patterns.some(p => p.test(question));
}

// 비밀연애/불륜/외도 관련 질문 감지
function isSecretAffairQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 불륜/외도 관련
    /불륜.*(어떻|들킬|끝날|결말)/,
    /외도.*(어떻|들킬|했는지|할까)/,
    /바람.*(피우|맞을|어떻|들킬)/,
    /양다리.*(어떻|들킬)/,
    /내연.*(어떻|관계|끝날)/,
    /불륜남.*(어떻|진심)/,
    /불륜녀.*(어떻|진심)/,

    // 비밀연애 관련
    /비밀.?연애.*(어떻|들킬|끝날)/,
    /숨기.*(연애|사랑|관계)/,
    /몰래.*(만나|사귀|연애)/,
    /사내.?연애.*(어떻|들킬)/,
    /직장.?내.?연애.*(어떻)/,

    // 유부남/유부녀 관련
    /유부남.*(마음|진심|어떻|만나)/,
    /유부녀.*(마음|진심|어떻|만나)/,
    /기혼자.*(어떻|만나)/,
    /결혼한.?사람.*(어떻|좋아)/,

    // 의심/배신 관련
    /배신.*(당할|어떻|할까)/,
    /속이.*(는지|어떻|고 있)/,
    /거짓말.*(하는지|어떻)/,
    /의심.*(해야|어떻|되는)/,
    /다른.?사람.*(있는지|만나는지)/,

    // 삼각관계
    /삼각관계.*(어떻|끝날|선택)/,
    /두.?사람.*(사이|고민|선택)/,
    /양쪽.*(어떻|선택)/,

    // 영어 패턴
    /affair.*(how|end|caught|result)/i,
    /cheat.*(ing|on|how|caught)/i,
    /secret.?relationship/i,
    /infidelity/i,
    /two.?timing/i,
    /love.?triangle/i,
    /married.*(man|woman).*(love|affair)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 41. 이민/비자/해외정착 관련 질문 감지
function isImmigrationVisaQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 해외여행은 제외
  if (isTravelQuestion(question)) return false;

  const patterns = [
    // 이민 관련
    /이민.*(가야|갈까|어떻|운|성공|준비)/,
    /이민 ?운|이민운/,
    /영주권.*(받을|어떻|가능|취득)/,
    /시민권.*(받을|어떻|가능|취득)/,
    /해외.?이주.*(어떻|갈까|성공)/,
    /외국.*(살면|살까|정착)/,

    // 비자 관련
    /비자.*(받을|어떻|가능|나올|승인)/,
    /워킹.?홀리데이.*(어떻|갈까|가야)/,
    /취업.?비자.*(어떻|받을|가능)/,
    /학생.?비자.*(어떻|받을|가능)/,
    /배우자.?비자.*(어떻|받을)/,
    /영주.?비자.*(어떻|받을)/,

    // 해외정착 관련
    /해외.?정착.*(어떻|성공|갈까)/,
    /외국.?생활.*(어떻|적응|맞을)/,
    /이민.?생활.*(어떻|적응)/,
    /타국.*(생활|정착|어떻)/,
    /해외.?취업.*(어떻|될까|성공)/,
    /외국.?취업.*(어떻|될까)/,

    // 국가별 이민
    /미국.*(이민|정착|갈까|살면)/,
    /캐나다.*(이민|정착|갈까|살면)/,
    /호주.*(이민|정착|갈까|살면)/,
    /유럽.*(이민|정착|갈까|살면)/,
    /일본.*(정착|갈까|살면|취업)/,

    // 귀국 관련
    /귀국.*(해야|할까|어떻|언제)/,
    /한국.*(돌아|복귀|귀국)/,

    // 영어 패턴
    /immigra.*(tion|te|ting).*(how|when|success|fortune)/i,
    /visa.*(get|approve|how|when|possible)/i,
    /green.?card.*(get|how|when)/i,
    /citizenship.*(get|how|when)/i,
    /settle.*(abroad|overseas|foreign)/i,
    /move.*(abroad|overseas|another country)/i,
    /living.*(abroad|overseas|foreign)/i,
    /permanent.?residen.*(ce|t|cy)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 42. 창작/예술/재능 관련 질문 감지
function isCreativeArtQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 창작/예술 활동
    /창작.*(활동|어떻|운|재능|성공)/,
    /예술.*(재능|어떻|운|활동|성공)/,
    /작품.*(어떻|만들|완성|발표)/,
    /창의력.*(어떻|높일|발휘)/,
    /예술가.*(될|어떻|운)/,

    // 글쓰기/작가
    /글.?쓰기.*(어떻|재능|운|시작)/,
    /작가.*(될|어떻|운|재능)/,
    /소설.*(쓰면|어떻|출판)/,
    /시.*(쓰면|어떻|재능)/,
    /작문.*(재능|어떻)/,

    // 그림/미술
    /그림.*(재능|어떻|그리면|배우면)/,
    /미술.*(재능|어떻|배우면)/,
    /화가.*(될|어떻|운)/,
    /일러스트.*(어떻|재능|배우면)/,
    /디자인.*(재능|어떻|적성)/,

    // 음악
    /음악.*(재능|어떻|적성|해도)/,
    /노래.*(재능|어떻|잘|부르면)/,
    /악기.*(배우면|어떻|재능)/,
    /작곡.*(어떻|재능|해도)/,
    /가수.*(될|어떻|운)/,

    // 연기/공연
    /연기.*(재능|어떻|배우면)/,
    /배우.*(될|어떻|운|재능)/,
    /연극.*(어떻|해도|시작)/,
    /뮤지컬.*(어떻|해도)/,
    /무용.*(재능|어떻|배우면)/,

    // 공예/핸드메이드
    /공예.*(재능|어떻|배우면)/,
    /핸드메이드.*(어떻|팔면|만들면)/,
    /수공예.*(어떻|재능)/,
    /도자기.*(배우면|어떻)/,

    // 사진/영상
    /사진.*(찍으면|재능|어떻)/,
    /영상.*(만들면|재능|어떻)/,
    /촬영.*(재능|어떻)/,
    /유튜브.?콘텐츠.*(만들|어떻)/,

    // 영어 패턴
    /creative.*(talent|how|fortune|ability)/i,
    /art.*(talent|how|fortune|career)/i,
    /artist.*(become|how|fortune)/i,
    /writ.*(ing|er).*(talent|how|career)/i,
    /music.*(talent|how|career)/i,
    /paint.*(ing|er).*(talent|how)/i,
    /design.*(talent|how|career)/i,
    /perform.*(ing|er|ance).*(talent|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 43. 노후/은퇴/연금 관련 질문 감지
function isRetirementPensionQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 노후 관련
    /노후.*(준비|어떻|생활|운|대비)/,
    /노년.*(어떻|생활|건강)/,
    /늙어서.*(어떻|살|생활)/,
    /나이.?들어서.*(어떻|살)/,
    /말년.*(어떻|운|생활)/,

    // 은퇴 관련
    /은퇴.*(언제|어떻|후|준비|생활)/,
    /퇴직.*(후|언제|어떻|준비)/,
    /정년.*(후|퇴직|어떻)/,
    /조기.?은퇴.*(어떻|할까|가능)/,
    /은퇴.?생활.*(어떻|준비)/,

    // 연금 관련
    /연금.*(어떻|받을|충분|준비)/,
    /국민연금.*(어떻|받을|충분)/,
    /퇴직연금.*(어떻|받을)/,
    /개인연금.*(어떻|들어|가입)/,
    /연금.?저축.*(어떻|시작)/,

    // 노후 자금
    /노후.?자금.*(어떻|충분|모아)/,
    /은퇴.?자금.*(어떻|충분|모아)/,
    /생활비.*(노후|은퇴|나중)/,
    /저축.*(노후|은퇴|나중)/,

    // 제2의 인생
    /제2의.?인생.*(어떻|시작)/,
    /인생.?2막.*(어떻|시작)/,
    /새.?출발.*(은퇴|나이)/,
    /재취업.*(은퇴|퇴직|어떻)/,

    // 요양/간병
    /요양.*(원|시설|어떻)/,
    /간병.*(어떻|필요|받을)/,
    /건강.*(노후|말년|나이)/,

    // 영어 패턴
    /retire.*(ment|when|how|fortune|life)/i,
    /pension.*(how|enough|plan)/i,
    /old.?age.*(how|life|fortune)/i,
    /senior.*(life|years|how)/i,
    /after.?retire/i,
    /golden.?years/i,
    /second.?career/i,
  ];
  return patterns.some(p => p.test(question));
}

// 44. 이웃/동네/커뮤니티 관련 질문 감지
function isNeighborCommunityQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 이사 질문은 제외
  if (isMovingQuestion(question)) return false;

  const patterns = [
    // 이웃 관련
    /이웃.*(관계|사이|어떻|문제|갈등)/,
    /옆집.*(사람|이웃|어떻|문제)/,
    /윗집.*(사람|어떻|문제|소음)/,
    /아랫집.*(사람|어떻|문제)/,
    /층간.?소음.*(어떻|해결|문제)/,

    // 동네/지역 관련
    /동네.*(사람|어떻|분위기|살기)/,
    /마을.*(사람|어떻|분위기)/,
    /주민.*(관계|어떻|모임)/,
    /지역.?사회.*(어떻|활동)/,

    // 아파트/주거 커뮤니티
    /아파트.*(주민|이웃|사람들)/,
    /입주민.*(관계|어떻|문제)/,
    /관리.?사무소.*(어떻|문제)/,
    /주민.?회의.*(어떻|참여)/,

    // 커뮤니티 활동
    /동호회.*(가입|활동|어떻)/,
    /모임.*(동네|지역|어떻)/,
    /봉사.?활동.*(어떻|시작)/,
    /지역.?모임.*(어떻|참여)/,

    // 갈등/분쟁
    /이웃.?분쟁.*(어떻|해결)/,
    /이웃.?갈등.*(어떻|해결)/,
    /민원.*(넣을|어떻|제기)/,
    /신고.*(해야|어떻|할까)/,

    // 영어 패턴
    /neighbor.*(s|hood).*(how|relation|problem|issue)/i,
    /communit.*(y|ies).*(how|join|involve)/i,
    /local.*(people|community|area)/i,
    /residential.*(area|community)/i,
    /noise.?complaint/i,
  ];
  return patterns.some(p => p.test(question));
}

// 45. 분실/잃어버린 물건 관련 질문 감지
function isLostItemQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 분실/잃어버림
    /잃어버린.*(물건|찾을|어디|나올)/,
    /분실.*(물건|찾을|어디|신고)/,
    /잃어버렸.*(어디|찾을|나올)/,
    /없어진.*(물건|어디|찾을)/,
    /어디.*(뒀|놨|있을|갔을)/,
    /못.?찾.*(겠|고|는)/,

    // 구체적 물건
    /지갑.*(잃|없|찾을|어디)/,
    /핸드폰.*(잃|없|찾을|어디)/,
    /휴대폰.*(잃|없|찾을|어디)/,
    /열쇠.*(잃|없|찾을|어디)/,
    /가방.*(잃|없|찾을|어디)/,
    /카드.*(잃|없|찾을|어디)/,
    /반지.*(잃|없|찾을|어디)/,
    /시계.*(잃|없|찾을|어디)/,
    /안경.*(잃|없|찾을|어디)/,
    /서류.*(잃|없|찾을|어디)/,

    // 찾기 관련
    /찾을.?수.*(있을|없을|있나|없나)/,
    /나올까|나오려나|나올지/,
    /돌아올까|돌려받을/,
    /발견.*(될|할|어디)/,

    // 도난
    /도난.*(당한|신고|어떻)/,
    /훔쳐.*(갔|간|가)/,
    /털렸.*(어|다)/,

    // 영어 패턴
    /lost.*(item|thing|find|where)/i,
    /missing.*(item|thing|find)/i,
    /can.*(find|get back)/i,
    /where.*(did|is|are).*(put|leave|go)/i,
    /stolen.*(item|thing)/i,
    /misplace.*(d|ing)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 46. 반려동물/펫 관련 질문 감지
function isPetAnimalQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 반려동물 일반
    /반려.*(동물|견|묘|어떻|운|건강)/,
    /펫.*(어떻|건강|운)/,
    /애완.*(동물|어떻)/,

    // 강아지/고양이
    /강아지.*(어떻|건강|운|키우면|분양)/,
    /고양이.*(어떻|건강|운|키우면|분양)/,
    /댕댕이.*(어떻|건강)/,
    /냥이.*(어떻|건강)/,
    /개.*(키우면|분양|어떻)/,
    /고냥이.*(어떻|건강)/,

    // 반려동물 건강/케어
    /동물.?병원.*(가야|어떻)/,
    /수의사.*(어떻|가야)/,
    /예방.?접종.*(해야|어떻)/,
    /중성화.*(해야|어떻)/,

    // 분양/입양
    /분양.*(받을|할까|어떻)/,
    /입양.*(할까|어떻|동물)/,
    /새.?식구.*(들일|맞을)/,

    // 반려동물 문제
    /짖음.*(어떻|해결)/,
    /물어.*(뜯|어떻)/,
    /배변.*(훈련|어떻)/,
    /산책.*(해야|어떻)/,

    // 무지개다리
    /무지개.?다리.*(건넜|어떻|보내)/,
    /반려.*(잃|떠나)/,
    /펫.?로스.*(어떻)/,

    // 영어 패턴
    /pet.*(how|fortune|health|adopt)/i,
    /dog.*(how|health|adopt|train)/i,
    /cat.*(how|health|adopt)/i,
    /puppy.*(how|adopt|train)/i,
    /kitten.*(how|adopt)/i,
    /animal.*(adopt|rescue|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 47. 법률/소송/분쟁 관련 질문 감지
function isLegalDisputeQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 법률/소송
    /소송.*(어떻|이길|질까|결과)/,
    /재판.*(어떻|결과|승소)/,
    /법적.*(조치|분쟁|어떻)/,
    /고소.*(할까|당할|어떻)/,
    /고발.*(할까|당할|어떻)/,
    /변호사.*(선임|만나|어떻)/,

    // 분쟁/갈등
    /분쟁.*(어떻|해결|승소)/,
    /합의.*(할까|어떻|가능)/,
    /조정.*(어떻|신청)/,
    /중재.*(어떻|신청)/,

    // 계약 분쟁
    /계약.?위반.*(어떻|소송)/,
    /손해.?배상.*(받을|어떻)/,
    /위약금.*(받을|어떻)/,

    // 이혼/양육권
    /이혼.?소송.*(어떻|결과)/,
    /양육권.*(어떻|받을|싸움)/,
    /위자료.*(받을|어떻)/,

    // 형사/민사
    /형사.*(고소|어떻)/,
    /민사.*(소송|어떻)/,
    /벌금.*(어떻|나올)/,
    /처벌.*(받을|어떻)/,

    // 법원/검찰
    /법원.*(가야|어떻)/,
    /검찰.*(조사|어떻)/,
    /경찰.*(신고|조사|어떻)/,

    // 영어 패턴
    /lawsuit.*(how|win|result)/i,
    /legal.*(dispute|action|how)/i,
    /court.*(case|how|result)/i,
    /sue.*(should|how|win)/i,
    /lawyer.*(hire|consult|how)/i,
    /settlement.*(how|accept)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 48. 경조사/행사/기념일 관련 질문 감지
function isCelebrationEventQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 결혼/약혼
    /결혼식.*(날짜|장소|어떻)/,
    /웨딩.*(어떻|준비)/,
    /약혼식.*(어떻|언제)/,
    /청첩장.*(어떻|보내)/,

    // 돌잔치/생일
    /돌잔치.*(어떻|언제|장소)/,
    /백일.?잔치.*(어떻|언제)/,
    /생일.?파티.*(어떻|준비)/,

    // 기념일
    /기념일.*(어떻|보내|선물)/,
    /결혼.?기념일.*(어떻|보내)/,
    /100일.*(어떻|기념)/,
    /1주년.*(어떻|기념)/,

    // 장례/추모
    /장례.*(어떻|치르|준비)/,
    /49재.*(어떻|지내)/,
    /제사.*(어떻|지내)/,
    /추모.*(어떻|행사)/,

    // 개업/이전
    /개업식.*(어떻|언제|날짜)/,
    /이전.?식.*(어떻|언제)/,
    /오픈.*(어떻|날짜)/,

    // 졸업/입학
    /졸업식.*(어떻|언제)/,
    /입학식.*(어떻|언제)/,
    /수료식.*(어떻|언제)/,

    // 파티/모임
    /파티.*(어떻|준비|열면)/,
    /송년회.*(어떻|언제)/,
    /신년회.*(어떻|언제)/,
    /회식.*(어떻|언제)/,

    // 영어 패턴
    /wedding.*(date|venue|how)/i,
    /anniversary.*(how|celebrate)/i,
    /birthday.?party.*(how|plan)/i,
    /funeral.*(how|arrange)/i,
    /ceremony.*(how|when)/i,
    /celebration.*(how|plan)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 49. 부모/어른/효도 관련 질문 감지
function isParentElderQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 부모님 관계
    /부모님.*(관계|사이|어떻|건강|마음)/,
    /어머니.*(관계|건강|어떻|마음)/,
    /아버지.*(관계|건강|어떻|마음)/,
    /엄마.*(관계|건강|어떻|마음)/,
    /아빠.*(관계|건강|어떻|마음)/,

    // 효도/봉양
    /효도.*(어떻|방법|해야)/,
    /봉양.*(어떻|방법)/,
    /모시.*(고 살|어떻)/,
    /용돈.*(드려|어떻)/,

    // 시부모/장인장모
    /시부모.*(관계|어떻|모시)/,
    /시어머니.*(관계|어떻)/,
    /시아버지.*(관계|어떻)/,
    /장인.*(관계|어떻)/,
    /장모.*(관계|어떻)/,

    // 노부모/요양
    /노부모.*(어떻|모시|봉양)/,
    /요양.*(보내|원|어떻)/,
    /간병.*(어떻|해야)/,

    // 세대 갈등
    /세대.?차이.*(어떻|해결)/,
    /갈등.*(부모|어른)/,
    /잔소리.*(어떻|대처)/,

    // 유산/상속 (부모 관련)
    /부모님.*(재산|유산)/,
    /물려받.*(을|어떻)/,

    // 영어 패턴
    /parent.*(s|relationship|how|health)/i,
    /mother.*(relationship|health|how)/i,
    /father.*(relationship|health|how)/i,
    /elderly.*(care|parent|how)/i,
    /in.?law.*(s|relationship|how)/i,
    /filial.*(piety|duty|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 50. 수면/불면/휴식 관련 질문 감지
function isSleepRestQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 꿈 해석은 제외
  if (isDreamInterpretQuestion(question)) return false;

  const patterns = [
    // 수면 문제
    /잠.*(못|안 |어떻|푹|잘)/,
    /수면.*(부족|장애|어떻|패턴)/,
    /불면.*(증|어떻|해결)/,
    /숙면.*(어떻|방법|못)/,
    /밤.*(새|못 자|잠)/,

    // 피로/휴식
    /피곤.*(해|한|풀|어떻)/,
    /피로.*(풀|회복|어떻)/,
    /휴식.*(어떻|취해|필요)/,
    /쉬어.*(야|어떻)/,
    /지쳐.*(어떻|있)/,

    // 수면 습관
    /수면.?시간.*(어떻|부족|늘려)/,
    /잠.?버릇.*(어떻|고칠)/,
    /야행성.*(어떻|고칠)/,
    /아침.*(못 일어|힘들)/,
    /기상.*(어떻|힘들)/,

    // 낮잠/졸음
    /낮잠.*(자야|어떻)/,
    /졸음.*(어떻|깨|해결)/,
    /졸려.*(어떻|왜)/,

    // 수면 환경
    /침대.*(어떻|바꿔)/,
    /베개.*(어떻|바꿔)/,
    /수면.?환경.*(어떻)/,

    // 영어 패턴
    /sleep.*(problem|how|can't|well)/i,
    /insomnia.*(how|cure|deal)/i,
    /tired.*(how|always|why)/i,
    /rest.*(need|how|enough)/i,
    /fatigue.*(how|deal|chronic)/i,
    /nap.*(should|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 51. 온라인쇼핑/중고거래 관련 질문 감지
function isOnlineShoppingQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 온라인쇼핑
    /온라인.?쇼핑.*(어떻|할까|운)/,
    /인터넷.?쇼핑.*(어떻|할까)/,
    /해외.?직구.*(어떻|할까|운)/,
    /배송.*(언제|어떻|받을)/,

    // 중고거래
    /중고.?거래.*(어떻|할까|사기)/,
    /당근.*(마켓|거래|어떻)/,
    /번개.?장터.*(어떻|거래)/,
    /중고나라.*(어떻|거래)/,
    /중고.*(사면|팔면|어떻)/,

    // 구매 결정
    /이거.*(사도|살까|어떻)/,
    /구매.*(해도|할까|어떻)/,
    /물건.*(사야|어떻|좋을)/,
    /쇼핑.*(해도|할까|어떻)/,

    // 가격/할인
    /가격.*(적당|비싼|어떻)/,
    /할인.*(받을|언제|어떻)/,
    /세일.*(언제|어떻|기다릴)/,
    /최저가.*(어떻|찾을)/,

    // 반품/환불
    /반품.*(해야|어떻|가능)/,
    /환불.*(받을|어떻|가능)/,
    /교환.*(해야|어떻|가능)/,

    // 영어 패턴
    /online.?shopping.*(how|should|fortune)/i,
    /buy.*(this|online|how)/i,
    /purchase.*(should|how|online)/i,
    /secondhand.*(buy|sell|how)/i,
    /used.*(item|buy|sell)/i,
    /refund.*(get|how|possible)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 52. 임대/월세/전세 관련 질문 감지
function isRentalLeaseQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 이사 질문은 제외
  if (isMovingQuestion(question)) return false;

  const patterns = [
    // 월세/전세
    /월세.*(어떻|구할|올릴|내릴)/,
    /전세.*(어떻|구할|올릴|사기)/,
    /보증금.*(어떻|돌려|올릴)/,
    /임대료.*(어떻|올릴|내릴)/,

    // 임대차
    /임대.*(계약|어떻|갱신)/,
    /계약.?갱신.*(어떻|해야)/,
    /재계약.*(어떻|해야)/,
    /임차인.*(어떻|권리)/,
    /임대인.*(어떻|요구)/,

    // 집 구하기
    /집.*(구할|찾을|어떻|언제)/,
    /방.*(구할|찾을|어떻)/,
    /원룸.*(구할|어떻)/,
    /오피스텔.*(구할|어떻)/,

    // 부동산 중개
    /부동산.*(중개|가야|어떻)/,
    /공인중개사.*(어떻|찾을)/,
    /중개.?수수료.*(어떻|얼마)/,

    // 입주/퇴거
    /입주.*(언제|어떻|할까)/,
    /퇴거.*(언제|어떻|해야)/,
    /이사.?날짜.*(어떻|언제)/,

    // 영어 패턴
    /rent.*(apartment|house|how|find)/i,
    /lease.*(sign|how|renew)/i,
    /deposit.*(get back|how|pay)/i,
    /landlord.*(how|issue|deal)/i,
    /tenant.*(rights|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 53. 핸드폰/전자기기 관련 질문 감지
function isPhoneDeviceQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 핸드폰
    /핸드폰.*(바꿀|살까|어떻|언제)/,
    /휴대폰.*(바꿀|살까|어떻)/,
    /스마트폰.*(바꿀|살까|어떻)/,
    /아이폰.*(살까|어떻|바꿀)/,
    /갤럭시.*(살까|어떻|바꿀)/,

    // 컴퓨터/노트북
    /컴퓨터.*(살까|바꿀|어떻)/,
    /노트북.*(살까|바꿀|어떻)/,
    /맥북.*(살까|어떻|바꿀)/,
    /PC.*(살까|바꿀|어떻)/i,

    // 태블릿/패드
    /태블릿.*(살까|어떻)/,
    /아이패드.*(살까|어떻)/,
    /갤럭시.?탭.*(살까|어떻)/,

    // 가전제품
    /가전.*(살까|바꿀|어떻)/,
    /TV.*(살까|바꿀|어떻)/i,
    /에어컨.*(살까|어떻)/,
    /냉장고.*(살까|어떻)/,
    /세탁기.*(살까|어떻)/,

    // 기기 교체/구매 시기
    /기기.*(바꿀|살까|어떻)/,
    /전자.?기기.*(살까|어떻)/,
    /교체.?시기.*(어떻|언제)/,
    /새.?제품.*(살까|어떻)/,

    // 영어 패턴
    /phone.*(buy|change|how|when)/i,
    /smartphone.*(buy|upgrade|how)/i,
    /laptop.*(buy|how|when)/i,
    /computer.*(buy|upgrade|how)/i,
    /device.*(buy|upgrade|how)/i,
    /iphone.*(buy|how|when)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 54. 헤어/외모변화 관련 질문 감지
function isHairAppearanceQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 외모/패션 질문과 구분
  if (isBeautyFashionQuestion(question)) return false;

  const patterns = [
    // 헤어스타일
    /머리.*(자를|바꿀|어떻|스타일)/,
    /헤어.*(스타일|바꿀|어떻|컬러)/,
    /파마.*(할까|어떻|풀릴)/,
    /염색.*(할까|어떻|색깔)/,
    /커트.*(할까|어떻|스타일)/,

    // 탈모/모발
    /탈모.*(어떻|막을|치료)/,
    /머리카락.*(빠져|어떻|관리)/,
    /모발.*(관리|어떻|건강)/,
    /가발.*(쓸까|어떻)/,

    // 미용실
    /미용실.*(가야|어떻|언제)/,
    /헤어샵.*(가야|어떻)/,
    /미용사.*(어떻|추천)/,

    // 외모 변화
    /이미지.*(바꿀|체인지|어떻)/,
    /외모.*(바꿀|어떻|변화)/,
    /분위기.*(바꿀|어떻|전환)/,
    /변신.*(할까|어떻)/,

    // 영어 패턴
    /hair.*(cut|style|change|color|dye)/i,
    /hairstyle.*(change|how|new)/i,
    /perm.*(get|how|should)/i,
    /salon.*(go|how|when)/i,
    /makeover.*(how|should|get)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 55. 선물/기프트 관련 질문 감지
function isGiftPresentQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 선물 관련
    /선물.*(뭘|어떤|추천|고르|살|줄)/,
    /기프트.*(어떤|추천|살)/,
    /뭘.?줄까|뭐.?줄까/,
    /뭐.?사줄까|뭘.?사줄까/,

    // 대상별 선물
    /남친.*(선물|뭘)/,
    /여친.*(선물|뭘)/,
    /부모님.*(선물|뭘)/,
    /친구.*(선물|뭘)/,
    /생일.?선물.*(뭘|어떤)/,

    // 기념일 선물
    /결혼.?선물.*(뭘|어떤)/,
    /기념일.*(선물|뭘)/,
    /졸업.?선물.*(뭘|어떤)/,
    /입학.?선물.*(뭘|어떤)/,

    // 선물 고민
    /좋아할까.*(선물|줄)/,
    /마음에.?들까.*(선물)/,
    /선물.*(고민|모르|뭘)/,
    /어떤.*(선물|거.?줄까)/,

    // 화환/축하
    /화환.*(보낼|어떻)/,
    /축하.*(선물|어떻|뭘)/,
    /축의금.*(얼마|어떻)/,
    /부조.*(얼마|어떻)/,

    // 영어 패턴
    /gift.*(what|recommend|buy|give)/i,
    /present.*(what|buy|give|for)/i,
    /what.*(give|buy|gift)/i,
    /birthday.?gift/i,
    /anniversary.?gift/i,
  ];
  return patterns.some(p => p.test(question));
}

// 56. 다이어트/체중관리 관련 질문 감지
function isDietWeightQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 다이어트
    /다이어트.*(어떻|성공|시작|방법|언제)/,
    /살.*(빼|뺄|빠질|어떻)/,
    /체중.*(줄|감량|어떻|관리)/,
    /몸무게.*(줄|빼|어떻)/,
    /감량.*(성공|어떻|방법)/,

    // 운동/헬스
    /운동.*(시작|어떻|해야|효과)/,
    /헬스.*(등록|시작|어떻)/,
    /PT.*(받을|어떻|시작)/i,
    /근력.*(운동|어떻|키울)/,
    /유산소.*(운동|어떻|해야)/,

    // 식단/식이
    /식단.*(관리|어떻|조절)/,
    /먹어도.*(될까|괜찮)/,
    /간헐적.?단식.*(어떻|해도)/,
    /저탄고지.*(어떻|해도)/,
    /칼로리.*(어떻|줄여)/,

    // 요요/유지
    /요요.*(올까|어떻|막을)/,
    /체중.?유지.*(어떻|방법)/,
    /목표.?체중.*(어떻|도달)/,

    // 바디프로필/몸매
    /바디.?프로필.*(어떻|찍을)/,
    /몸매.*(만들|가꿀|어떻)/,
    /복근.*(만들|어떻)/,

    // 영어 패턴
    /diet.*(how|start|success|work)/i,
    /lose.?weight.*(how|when|can)/i,
    /weight.?loss.*(how|success)/i,
    /exercise.*(start|how|should)/i,
    /workout.*(how|start|routine)/i,
    /fitness.*(how|start|goal)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 57. 외국어/언어학습 관련 질문 감지
function isLanguageLearningQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;
  // 시험 질문은 제외 (토익 등)
  if (isExamInterviewQuestion(question)) return false;

  const patterns = [
    // 외국어 학습
    /영어.*(공부|배우|실력|늘리|어떻)/,
    /일본어.*(공부|배우|실력|어떻)/,
    /중국어.*(공부|배우|실력|어떻)/,
    /한국어.*(공부|배우|실력|어떻)/,
    /스페인어.*(공부|배우|어떻)/,
    /프랑스어.*(공부|배우|어떻)/,
    /독일어.*(공부|배우|어떻)/,

    // 어학 일반
    /외국어.*(공부|배우|어떻|늘)/,
    /언어.*(배우|공부|어떻)/,
    /회화.*(공부|배우|어떻|늘)/,
    /어학.*(공부|시작|어떻)/,

    // 학습 방법
    /원어민.*(수업|레슨|어떻)/,
    /어학원.*(다녀|등록|어떻)/,
    /인강.*(들을|어떻)/,
    /유학.*(가면|어떻|준비)/,
    /어학.?연수.*(어떻|갈까)/,

    // 실력 향상
    /발음.*(어떻|고칠|좋아)/,
    /리스닝.*(어떻|늘릴)/,
    /스피킹.*(어떻|늘릴)/,
    /문법.*(어떻|공부)/,

    // 영어 패턴
    /learn.*(english|japanese|chinese|language)/i,
    /study.*(language|english|abroad)/i,
    /language.*(learn|study|improve)/i,
    /speaking.*(improve|how|practice)/i,
    /fluent.*(become|how)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 58. 운전면허/차량 관련 질문 감지
function isDriverLicenseQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 운전면허
    /운전.?면허.*(딸|따|취득|어떻|시험)/,
    /면허.*(딸|따|시험|어떻)/,
    /운전.*(배울|배우면|어떻)/,
    /학원.*(운전|다녀|등록)/,
    /도로.?주행.*(어떻|시험)/,

    // 차량 구매
    /차.*(살까|사면|구매|어떻|바꿀)/,
    /자동차.*(살까|구매|어떻)/,
    /중고차.*(살까|사면|어떻)/,
    /신차.*(살까|사면|어떻)/,
    /전기차.*(살까|어떻)/,

    // 차종 선택
    /어떤.?차.*(살까|좋을)/,
    /차종.*(어떻|추천|고민)/,
    /SUV.*(살까|어떻)/i,
    /세단.*(살까|어떻)/,

    // 차량 관리
    /차량.*(관리|수리|어떻)/,
    /수리.*(해야|맡길|어떻)/,
    /정비.*(받을|해야|어떻)/,
    /보험.*(들어|갱신|어떻)/,

    // 사고/문제
    /접촉.?사고.*(어떻|났)/,
    /사고.*(났|어떻|처리)/,
    /범칙금.*(어떻|냈)/,
    /과태료.*(어떻|냈)/,

    // 영어 패턴
    /driver.?license.*(get|how|test)/i,
    /driving.*(test|learn|how)/i,
    /car.*(buy|purchase|how|which)/i,
    /vehicle.*(buy|how|choose)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 59. 봉사/기부/자선 관련 질문 감지
function isVolunteerCharityQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 봉사활동
    /봉사.*(활동|하면|어떻|시작)/,
    /자원.?봉사.*(어떻|하면|시작)/,
    /봉사자.*(되면|어떻)/,
    /사회.?봉사.*(어떻|하면)/,

    // 기부/후원
    /기부.*(하면|할까|어떻|얼마)/,
    /후원.*(하면|할까|어떻)/,
    /정기.?후원.*(어떻|할까)/,
    /일시.?후원.*(어떻|할까)/,
    /기부금.*(어떻|얼마)/,

    // 자선/나눔
    /나눔.*(어떻|시작|활동)/,
    /자선.*(활동|어떻|시작)/,
    /도움.*(주면|어떻|방법)/,
    /사회.?공헌.*(어떻|하면)/,

    // 단체/활동
    /NGO.*(어떻|참여)/i,
    /비영리.*(단체|어떻)/,
    /재능.?기부.*(어떻|하면)/,
    /헌혈.*(하면|어떻|해도)/,

    // 영어 패턴
    /volunteer.*(how|start|should)/i,
    /donat.*(e|ion|ing).*(how|should|where)/i,
    /charit.*(y|able).*(how|give|donate)/i,
    /help.*(others|community|how)/i,
    /give.?back.*(how|community)/i,
  ];
  return patterns.some(p => p.test(question));
}

// 60. 커플싸움/화해 관련 질문 감지
function isCoupleFightQuestion(question: string): boolean {
  // Yes/No 질문이면 제외
  if (isYesNoQuestion(question)) return false;

  const patterns = [
    // 싸움/다툼
    /싸웠.*(어떻|화해|연락)/,
    /다퉜.*(어떻|화해|먼저)/,
    /말다툼.*(어떻|했|후)/,
    /크게.?싸우.*(어떻|고)/,

    // 화해
    /화해.*(어떻|할까|방법|먼저)/,
    /사과.*(해야|할까|어떻|먼저)/,
    /용서.*(해야|받을|어떻)/,
    /먼저.*(연락|사과|다가)/,

    // 감정 상태
    /삐졌.*(어떻|연락)/,
    /토라졌.*(어떻|달래)/,
    /화났.*(어떻|풀)/,
    /서운.*(해서|어떻)/,

    // 연락/관계
    /연락.*(안 |없|해야|기다)/,
    /잠수.*(탔|당했|어떻)/,
    /무시.*(당하|어떻)/,
    /차단.*(당했|어떻|했)/,

    // 해결 방법
    /풀어.*(야|어떻)/,
    /관계.*(회복|어떻|나아)/,
    /다시.*(만나|사귈|어떻)/,
    /되돌리.*(려면|어떻)/,

    // 영어 패턴
    /fight.*(with|how|resolve|after)/i,
    /argue.*(d|ment).*(how|resolve)/i,
    /make.?up.*(how|should)/i,
    /apologize.*(how|should|first)/i,
    /reconcile.*(how|should)/i,
    /not.?talking.*(how|what)/i,
  ];
  return patterns.some(p => p.test(question));
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { question, language = "ko" } = body;

    if (!question || typeof question !== "string" || question.trim().length === 0) {
      return NextResponse.json(
        { error: "Question is required" },
        { status: 400 }
      );
    }

    const trimmedQuestion = question.trim().slice(0, 500);

    // 위험한 질문 체크
    if (checkDangerous(trimmedQuestion)) {
      return NextResponse.json({
        isDangerous: true,
        message: language === "ko"
          ? "힘든 시간을 보내고 계신 것 같아요. 전문가의 도움을 받으시길 권해드려요. 자살예방상담전화: 1393 (24시간)"
          : "I sense you might be going through a difficult time. Please reach out to a professional who can help. Crisis helpline: 1393 (Korea) or your local emergency services.",
      });
    }

    // 스프레드 옵션 목록
    const spreadOptions = getSpreadOptions();
    const spreadListForPrompt = spreadOptions.map(s =>
      `- ${s.themeId}/${s.id}: ${s.titleKo} (${s.cardCount}장) - ${s.description}`
    ).join("\n");

    // GPT-4o-mini로 분석
    const systemPrompt = `당신은 타로 전문가입니다. 사용자의 질문을 분석하고 가장 적합한 타로 스프레드를 추천해야 합니다.

## ⭐⭐⭐ 핵심 규칙: Yes/No 결정 질문 감지 ⭐⭐⭐

다음 패턴이 포함된 질문은 **무조건** decisions-crossroads/yes-no-why 선택:
- "~할까?", "~갈까?", "~볼까?", "~살까?", "~먹을까?", "~마실까?"
- "~해야 할까?", "~하면 될까?", "~해도 될까?", "~해볼까?"
- "~할지", "~갈지", "~할까요", "~갈까요"
- "~하는 게 좋을까?", "~해야 하나?", "~할까 말까"
- "Should I~?", "Is it good to~?"

### Yes/No 질문 예시 (모두 decisions-crossroads/yes-no-why):
- "오늘 운동 갈까?" → yes-no-why ✓
- "이 옷 살까?" → yes-no-why ✓
- "술 마실까?" → yes-no-why ✓
- "그 사람한테 연락할까?" → yes-no-why ✓
- "오늘 외출할까?" → yes-no-why ✓
- "야식 먹을까?" → yes-no-why ✓
- "공부할까?" → yes-no-why ✓
- "게임할까?" → yes-no-why ✓
- "영화 볼까?" → yes-no-why ✓
- "데이트 신청할까?" → yes-no-why ✓
- "고백할까?" → yes-no-why ✓
- "여행 갈까?" → yes-no-why ✓
- "이사할까?" → yes-no-why ✓
- "차 살까?" → yes-no-why ✓
- "머리 자를까?" → yes-no-why ✓

## 다른 스프레드 선택 기준

### 1. 두 가지 선택 비교 (decisions-crossroads/two-paths)
- "A vs B", "A냐 B냐", "A 아니면 B"
- 예: "삼성 vs LG", "서울 vs 부산", "이직 vs 잔류"

### 2. 타이밍 질문 (decisions-crossroads/timing-window)
- "언제~?", "몇 월에~?", "시기가~?"
- 예: "언제 고백하면 좋을까?", "언제 시작해야 할까?"

### 3. 상대방 마음/감정 (love-relationships/crush-feelings)
- "그 사람 마음", "날 어떻게 생각해?", "좋아해?"
- 예: "걔가 날 좋아해?", "그 사람 속마음은?"

### 4. 재회/이별 (love-relationships/reconciliation)
- "다시 만날 수 있을까?", "재회", "돌아올까?"

### 5. 인연 찾기 (love-relationships/finding-a-partner)
- "인연 언제?", "좋은 사람 만날까?", "소개팅"

### 6. 이직/퇴사 (career-work/job-change)
- "이직해도 될까?", "회사 옮길까?", "퇴사"
- ⚠️ 단순히 "이직할까?"면 yes-no-why도 가능

### 7. 면접/시험 (career-work/interview-result, career-work/exam-pass)
- "면접 결과", "시험 붙을까?", "합격할까?"

### 8. 오늘 운세 (daily-reading/day-card)
- "오늘 운세", "오늘 어때?", "오늘 하루"
- ⚠️ "오늘 ~할까?"는 yes-no-why!

### 9. 일반 흐름 (general-insight/past-present-future)
- 구체적인 결정이 없는 상황 파악
- "요즘 어때?", "앞으로 어떻게 될까?"

## 스프레드 목록
${spreadListForPrompt}

## 응답 형식 (JSON만)
{
  "themeId": "테마 ID",
  "spreadId": "스프레드 ID",
  "reason": "선택 이유",
  "userFriendlyExplanation": "사용자에게 보여줄 설명"
}

## ⚠️ 최종 체크
질문에 "~할까?", "~갈까?", "~볼까?", "~살까?", "~먹을까?" 패턴이 있으면
→ 무조건 decisions-crossroads/yes-no-why 선택!`;

    let responseText = "";
    try {
      responseText = await callOpenAI([
      { role: "system", content: systemPrompt },
      { role: "user", content: `사용자 질문: "${trimmedQuestion}"` }
      ]);
    } catch (error) {
      console.warn("[analyze-question] OpenAI unavailable, using fallback routing", error);
    }

    const fallbackParsed = {
      themeId: "general-insight",
      spreadId: "past-present-future",
      reason: "일반적인 운세 확인",
      userFriendlyExplanation: language === "ko"
        ? "전반적인 흐름을 볼 수 있는 스프레드를 준비했어요"
        : "I've prepared a spread to see the overall flow"
    };

    let parsed;
    try {
      parsed = responseText ? JSON.parse(responseText) : fallbackParsed;
    } catch {
      // 파싱 실패시 기본값
      parsed = fallbackParsed;
    }

    // ⭐ GPT 결과를 패턴 매칭으로 보정 (GPT가 잘못 선택한 경우 대비)
    // 우선순위: Yes/No > A vs B > 타이밍 > 재회 > 상대방마음 > 인연찾기 > 면접시험 > 이직 > 오늘운세 > 주간월간

    // 1. Yes/No 질문 (최우선)
    if (isYesNoQuestion(trimmedQuestion) && parsed.spreadId !== "yes-no-why") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → yes-no-why (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "decisions-crossroads",
        spreadId: "yes-no-why",
        reason: "결정이 필요한 질문",
        userFriendlyExplanation: language === "ko"
          ? "해야 할지 말아야 할지, 카드가 답해드릴게요! 🎴"
          : "Should you or shouldn't you? Let the cards answer! 🎴"
      };
    }
    // 2. A vs B 비교 질문
    else if (isComparisonQuestion(trimmedQuestion) && parsed.spreadId !== "two-paths") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → two-paths (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "decisions-crossroads",
        spreadId: "two-paths",
        reason: "두 가지 선택 비교",
        userFriendlyExplanation: language === "ko"
          ? "두 선택지를 비교해서 카드가 방향을 알려드릴게요! ⚖️"
          : "Let's compare both options with the cards! ⚖️"
      };
    }
    // 3. 타이밍/시기 질문
    else if (isTimingQuestion(trimmedQuestion) && parsed.spreadId !== "timing-window") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → timing-window (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "decisions-crossroads",
        spreadId: "timing-window",
        reason: "타이밍/시기 확인",
        userFriendlyExplanation: language === "ko"
          ? "언제가 좋을지 카드로 알아볼게요! ⏰"
          : "Let's find the right timing! ⏰"
      };
    }
    // 4. 재회/이별 질문
    else if (isReconciliationQuestion(trimmedQuestion) && parsed.spreadId !== "reconciliation") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → reconciliation (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "reconciliation",
        reason: "재회 가능성 확인",
        userFriendlyExplanation: language === "ko"
          ? "다시 만날 수 있을지 카드로 살펴볼게요! 💔➡️💕"
          : "Let's see the possibility of reconciliation! 💔➡️💕"
      };
    }
    // 5. 상대방 마음 질문
    else if (isCrushQuestion(trimmedQuestion) && parsed.spreadId !== "crush-feelings") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → crush-feelings (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "crush-feelings",
        reason: "상대방 마음 확인",
        userFriendlyExplanation: language === "ko"
          ? "그 사람의 마음을 카드로 살펴볼게요! 💕"
          : "Let's see what they really feel! 💕"
      };
    }
    // 6. 인연/소개팅 질문
    else if (isFindingPartnerQuestion(trimmedQuestion) && parsed.spreadId !== "finding-a-partner") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → finding-a-partner (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "finding-a-partner",
        reason: "인연 찾기",
        userFriendlyExplanation: language === "ko"
          ? "좋은 인연이 언제 올지 카드로 살펴볼게요! 💘"
          : "Let's see when love will come! 💘"
      };
    }
    // 7. 면접/시험 질문
    else if (isExamInterviewQuestion(trimmedQuestion)) {
      const isInterview = /면접/.test(trimmedQuestion);
      const targetSpread = isInterview ? "interview-result" : "exam-pass";
      if (parsed.spreadId !== targetSpread) {
        console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → ${targetSpread} (was: ${parsed.spreadId})`);
        parsed = {
          themeId: "career-work",
          spreadId: targetSpread,
          reason: isInterview ? "면접 결과 확인" : "시험 합격 확인",
          userFriendlyExplanation: language === "ko"
            ? (isInterview ? "면접 결과를 카드로 살펴볼게요! 💼" : "시험 결과를 카드로 살펴볼게요! 📝")
            : (isInterview ? "Let's see your interview result! 💼" : "Let's see your exam result! 📝")
        };
      }
    }
    // 8. 이직/퇴사 질문 (구체적 상담)
    else if (isJobChangeQuestion(trimmedQuestion) && parsed.spreadId !== "job-change") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → job-change (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "career-work",
        spreadId: "job-change",
        reason: "이직/퇴사 상담",
        userFriendlyExplanation: language === "ko"
          ? "이직에 대해 카드로 살펴볼게요! 🏢"
          : "Let's see about your career change! 🏢"
      };
    }
    // 9. 오늘 운세 질문
    else if (isTodayFortuneQuestion(trimmedQuestion) && parsed.spreadId !== "day-card") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → day-card (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "daily-reading",
        spreadId: "day-card",
        reason: "오늘의 운세",
        userFriendlyExplanation: language === "ko"
          ? "오늘 하루의 메시지를 전해드릴게요! ✨"
          : "Here's your message for today! ✨"
      };
    }
    // 10. 주간/월간 운세 질문
    else if (isWeeklyMonthlyQuestion(trimmedQuestion) && parsed.spreadId !== "weekly-forecast") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → weekly-forecast (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "daily-reading",
        spreadId: "weekly-forecast",
        reason: "이번 주 운세",
        userFriendlyExplanation: language === "ko"
          ? "이번 주 흐름을 카드로 살펴볼게요! 📅"
          : "Let's see this week's energy! 📅"
      };
    }
    // 11. 금전/재물 운세 질문
    else if (isMoneyFortuneQuestion(trimmedQuestion) && parsed.spreadId !== "money-fortune") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → money-fortune (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",  // 금전 전용 스프레드 없으면 일반 스프레드 사용
        reason: "금전/재물 운세",
        userFriendlyExplanation: language === "ko"
          ? "금전운의 흐름을 카드로 살펴볼게요! 💰"
          : "Let's see your financial fortune! 💰"
      };
    }
    // 12. 건강 운세 질문
    else if (isHealthFortuneQuestion(trimmedQuestion) && parsed.spreadId !== "health-fortune") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → health reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",  // 건강 전용 스프레드 없으면 일반 스프레드 사용
        reason: "건강 운세",
        userFriendlyExplanation: language === "ko"
          ? "건강 흐름을 카드로 살펴볼게요! 🏥"
          : "Let's see your health fortune! 🏥"
      };
    }
    // 13. 가족 관계 질문
    else if (isFamilyRelationQuestion(trimmedQuestion) && parsed.spreadId !== "family-relation") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → family reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",  // 가족 전용 스프레드 없으면 일반 스프레드 사용
        reason: "가족 관계",
        userFriendlyExplanation: language === "ko"
          ? "가족 관계의 흐름을 카드로 살펴볼게요! 👨‍👩‍👧‍👦"
          : "Let's see about your family relationships! 👨‍👩‍👧‍👦"
      };
    }
    // 14. 사업/창업 질문
    else if (isBusinessQuestion(trimmedQuestion) && parsed.spreadId !== "business-fortune") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → business reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "career-work",
        spreadId: "job-change",  // 사업 전용 스프레드 없으면 job-change 사용 (커리어 관련)
        reason: "사업/창업 운세",
        userFriendlyExplanation: language === "ko"
          ? "사업 운세를 카드로 살펴볼게요! 🏢"
          : "Let's see your business fortune! 🏢"
      };
    }
    // 15. 일반 운세/인생 질문
    else if (isGeneralFortuneQuestion(trimmedQuestion) && parsed.spreadId !== "past-present-future") {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → past-present-future (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "전반적인 운세",
        userFriendlyExplanation: language === "ko"
          ? "전반적인 흐름을 카드로 살펴볼게요! 🔮"
          : "Let's see the overall flow! 🔮"
      };
    }
    // 16. 학업/공부 운세 질문
    else if (isStudyFortuneQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → study reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "학업/공부 운세",
        userFriendlyExplanation: language === "ko"
          ? "학업 운세를 카드로 살펴볼게요! 📚"
          : "Let's see your study fortune! 📚"
      };
    }
    // 17. 이사/주거 운세 질문
    else if (isMovingQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → moving reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "이사/주거 운세",
        userFriendlyExplanation: language === "ko"
          ? "이사/주거 운세를 카드로 살펴볼게요! 🏠"
          : "Let's see your moving fortune! 🏠"
      };
    }
    // 18. 여행 운세 질문
    else if (isTravelQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → travel reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "여행 운세",
        userFriendlyExplanation: language === "ko"
          ? "여행 운세를 카드로 살펴볼게요! ✈️"
          : "Let's see your travel fortune! ✈️"
      };
    }
    // 19. 직장 내 관계 질문
    else if (isWorkRelationQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → work relation reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "career-work",
        spreadId: "job-change",
        reason: "직장 내 관계",
        userFriendlyExplanation: language === "ko"
          ? "직장 내 관계를 카드로 살펴볼게요! 👔"
          : "Let's see your workplace relationships! 👔"
      };
    }
    // 20. 법적/계약 문제 질문
    else if (isLegalQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → legal reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "법적/계약 문제",
        userFriendlyExplanation: language === "ko"
          ? "법적 문제의 흐름을 카드로 살펴볼게요! ⚖️"
          : "Let's see about your legal matter! ⚖️"
      };
    }
    // 21. 운전/교통 질문
    else if (isDrivingQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → driving reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "운전/교통 운세",
        userFriendlyExplanation: language === "ko"
          ? "운전/교통 운세를 카드로 살펴볼게요! 🚗"
          : "Let's see your driving fortune! 🚗"
      };
    }
    // 22. 반려동물 질문
    else if (isPetQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → pet reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "반려동물 운세",
        userFriendlyExplanation: language === "ko"
          ? "반려동물에 대해 카드로 살펴볼게요! 🐾"
          : "Let's see about your pet! 🐾"
      };
    }
    // 23. 취미/자기계발 질문
    else if (isHobbyQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → hobby reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "취미/자기계발 운세",
        userFriendlyExplanation: language === "ko"
          ? "취미와 성장에 대해 카드로 살펴볼게요! 🎨"
          : "Let's see about your hobbies and growth! 🎨"
      };
    }
    // 24. 우정/인간관계 질문
    else if (isFriendshipQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → friendship reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "우정/인간관계 운세",
        userFriendlyExplanation: language === "ko"
          ? "인간관계의 흐름을 카드로 살펴볼게요! 🤝"
          : "Let's see about your relationships! 🤝"
      };
    }
    // 25. 경쟁/시합/대회 질문
    else if (isCompetitionQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → competition reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "경쟁/대회 운세",
        userFriendlyExplanation: language === "ko"
          ? "경쟁과 승부의 흐름을 카드로 살펴볼게요! 🏆"
          : "Let's see about your competition! 🏆"
      };
    }
    // 26. 감정/멘탈 질문
    else if (isEmotionalMentalQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → emotional/mental reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "well-being-healing",
        spreadId: "inner-peace",
        reason: "감정/멘탈 케어 운세",
        userFriendlyExplanation: language === "ko"
          ? "마음의 상태와 치유의 방향을 카드로 살펴볼게요 💚"
          : "Let's explore your emotional state and path to healing 💚"
      };
    }
    // 27. 꿈 해석/해몽 질문
    else if (isDreamInterpretQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → dream interpretation (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "꿈 해몽/해석",
        userFriendlyExplanation: language === "ko"
          ? "꿈이 전하는 메시지를 카드로 해석해볼게요 🌙"
          : "Let's interpret the message in your dream 🌙"
      };
    }
    // 28. 전생/영적/인연 질문
    else if (isSpiritualPastLifeQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → spiritual reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "spiritual-guidance",
        spreadId: "soul-message",
        reason: "전생/영적 메시지",
        userFriendlyExplanation: language === "ko"
          ? "영혼의 메시지와 영적 인연을 카드로 읽어볼게요 ✨"
          : "Let's explore spiritual messages and soul connections ✨"
      };
    }
    // 29. 결혼/프로포즈 질문
    else if (isMarriageProposalQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → marriage reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "relationship-potential",
        reason: "결혼/혼인 운세",
        userFriendlyExplanation: language === "ko"
          ? "결혼과 인연의 흐름을 카드로 살펴볼게요 💍"
          : "Let's explore your marriage and relationship fortune 💍"
      };
    }
    // 30. 부동산/투자 질문
    else if (isRealEstateQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → real estate reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "money-finance",
        spreadId: "financial-crossroads",
        reason: "부동산/투자 운세",
        userFriendlyExplanation: language === "ko"
          ? "부동산과 투자의 흐름을 카드로 살펴볼게요 🏠"
          : "Let's explore your real estate and investment fortune 🏠"
      };
    }
    // 31. 자녀/출산/육아 질문
    else if (isChildrenQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → children reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "relationship-potential",
        reason: "자녀/출산 운세",
        userFriendlyExplanation: language === "ko"
          ? "자녀와 가족의 운세를 카드로 살펴볼게요 👶"
          : "Let's explore your children and family fortune 👶"
      };
    }
    // 32. 운 변화/터닝포인트 질문
    else if (isLuckChangeQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → luck change reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "운세 변화/흐름",
        userFriendlyExplanation: language === "ko"
          ? "운의 흐름과 변화의 시점을 카드로 살펴볼게요 🔄"
          : "Let's explore when your luck will change 🔄"
      };
    }
    // 33. 도박/복권/횡재 질문
    else if (isGamblingLotteryQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → gambling/lottery reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "money-finance",
        spreadId: "financial-crossroads",
        reason: "횡재/행운 운세",
        userFriendlyExplanation: language === "ko"
          ? "횡재와 행운의 기운을 카드로 살펴볼게요 🎰"
          : "Let's explore your luck with fortune and windfalls 🎰"
      };
    }
    // 34. 외모/패션/이미지 질문
    else if (isBeautyFashionQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → beauty/fashion reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "well-being-healing",
        spreadId: "inner-peace",
        reason: "외모/이미지 변화 운세",
        userFriendlyExplanation: language === "ko"
          ? "이미지 변화와 자기관리의 흐름을 살펴볼게요 💄"
          : "Let's explore your beauty and image transformation 💄"
      };
    }
    // 35. SNS/온라인/영향력 질문
    else if (isSocialMediaQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → social media reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "career-work",
        spreadId: "career-path",
        reason: "온라인/SNS 성공 운세",
        userFriendlyExplanation: language === "ko"
          ? "SNS와 온라인 활동의 성공 가능성을 살펴볼게요 📱"
          : "Let's explore your social media success potential 📱"
      };
    }
    // 36. 군대/입대/전역 질문
    else if (isMilitaryQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → military reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "군대/병역 운세",
        userFriendlyExplanation: language === "ko"
          ? "군 생활과 병역의 흐름을 카드로 살펴볼게요 🎖️"
          : "Let's explore your military service fortune 🎖️"
      };
    }
    // 37. 유산/상속/증여 질문
    else if (isInheritanceQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → inheritance reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "money-finance",
        spreadId: "financial-crossroads",
        reason: "상속/유산 운세",
        userFriendlyExplanation: language === "ko"
          ? "상속과 유산의 흐름을 카드로 살펴볼게요 📜"
          : "Let's explore your inheritance fortune 📜"
      };
    }
    // 38. 종교/신앙 질문
    else if (isReligionSpiritualityQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → religion reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "spiritual-guidance",
        spreadId: "soul-message",
        reason: "종교/신앙 운세",
        userFriendlyExplanation: language === "ko"
          ? "신앙과 영적 성장의 길을 카드로 살펴볼게요 🙏"
          : "Let's explore your spiritual path 🙏"
      };
    }
    // 39. 중독/습관 질문
    else if (isAddictionHabitQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → addiction/habit reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "well-being-healing",
        spreadId: "inner-peace",
        reason: "습관/극복 운세",
        userFriendlyExplanation: language === "ko"
          ? "습관 극복과 변화의 가능성을 살펴볼게요 💪"
          : "Let's explore your path to overcoming habits 💪"
      };
    }
    // 40. 비밀연애/불륜 질문
    else if (isSecretAffairQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → secret affair reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "relationship-potential",
        reason: "비밀 관계 운세",
        userFriendlyExplanation: language === "ko"
          ? "숨겨진 관계의 흐름과 결말을 카드로 살펴볼게요 🔒"
          : "Let's explore the hidden relationship dynamics 🔒"
      };
    }
    // 41. 이민/비자/해외정착 질문
    else if (isImmigrationVisaQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → immigration/visa reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "이민/비자/해외정착 운세",
        userFriendlyExplanation: language === "ko"
          ? "해외에서의 새로운 시작과 정착 운을 카드로 살펴볼게요 ✈️"
          : "Let's explore your fortune for settling abroad ✈️"
      };
    }
    // 42. 창작/예술/재능 질문
    else if (isCreativeArtQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → creative art reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "창작/예술/재능 운세",
        userFriendlyExplanation: language === "ko"
          ? "당신의 창작 활동과 예술적 재능을 카드로 살펴볼게요 🎨"
          : "Let's explore your creative talents and artistic journey 🎨"
      };
    }
    // 43. 노후/은퇴/연금 질문
    else if (isRetirementPensionQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → retirement reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "노후/은퇴 운세",
        userFriendlyExplanation: language === "ko"
          ? "편안한 노후와 은퇴 생활을 카드로 살펴볼게요 🌅"
          : "Let's explore your retirement and golden years 🌅"
      };
    }
    // 44. 이웃/동네/커뮤니티 질문
    else if (isNeighborCommunityQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → neighbor/community reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "이웃/커뮤니티 운세",
        userFriendlyExplanation: language === "ko"
          ? "이웃과의 관계와 지역 생활을 카드로 살펴볼게요 🏘️"
          : "Let's explore your neighborhood relationships 🏘️"
      };
    }
    // 45. 분실/잃어버린 물건 질문
    else if (isLostItemQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → lost item reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "분실물 운세",
        userFriendlyExplanation: language === "ko"
          ? "잃어버린 물건의 행방을 카드로 살펴볼게요 🔍"
          : "Let's explore where your lost item might be 🔍"
      };
    }
    // 46. 반려동물/펫 질문
    else if (isPetAnimalQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → pet reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "반려동물 운세",
        userFriendlyExplanation: language === "ko"
          ? "소중한 반려동물과의 인연을 카드로 살펴볼게요 🐾"
          : "Let's explore your bond with your pet 🐾"
      };
    }
    // 47. 법률/소송/분쟁 질문
    else if (isLegalDisputeQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → legal reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "법률/분쟁 운세",
        userFriendlyExplanation: language === "ko"
          ? "법적 상황의 흐름과 결과를 카드로 살펴볼게요 ⚖️"
          : "Let's explore the legal situation and outcome ⚖️"
      };
    }
    // 48. 경조사/행사/기념일 질문
    else if (isCelebrationEventQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → celebration reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "경조사/행사 운세",
        userFriendlyExplanation: language === "ko"
          ? "특별한 행사의 흐름을 카드로 살펴볼게요 🎉"
          : "Let's explore how your special event will go 🎉"
      };
    }
    // 49. 부모/어른/효도 질문
    else if (isParentElderQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → parent reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "relationship-potential",
        reason: "부모님 관계 운세",
        userFriendlyExplanation: language === "ko"
          ? "부모님과의 관계와 효도의 방향을 카드로 살펴볼게요 👨‍👩‍👧"
          : "Let's explore your relationship with your parents 👨‍👩‍👧"
      };
    }
    // 50. 수면/불면/휴식 질문
    else if (isSleepRestQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → sleep reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "well-being-healing",
        spreadId: "inner-peace",
        reason: "수면/휴식 운세",
        userFriendlyExplanation: language === "ko"
          ? "편안한 휴식과 수면의 방향을 카드로 살펴볼게요 😴"
          : "Let's explore your path to restful sleep 😴"
      };
    }
    // 51. 온라인쇼핑/중고거래 질문
    else if (isOnlineShoppingQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → shopping reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "money-finance",
        spreadId: "financial-outlook",
        reason: "쇼핑/구매 운세",
        userFriendlyExplanation: language === "ko"
          ? "쇼핑과 구매 결정의 흐름을 카드로 살펴볼게요 🛒"
          : "Let's explore your shopping and purchase decisions 🛒"
      };
    }
    // 52. 임대/월세/전세 질문
    else if (isRentalLeaseQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → rental reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "임대/주거 운세",
        userFriendlyExplanation: language === "ko"
          ? "주거와 임대 관련 흐름을 카드로 살펴볼게요 🏠"
          : "Let's explore your housing and rental situation 🏠"
      };
    }
    // 53. 핸드폰/전자기기 질문
    else if (isPhoneDeviceQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → device reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "money-finance",
        spreadId: "financial-outlook",
        reason: "기기 구매 운세",
        userFriendlyExplanation: language === "ko"
          ? "전자기기 구매와 교체 시기를 카드로 살펴볼게요 📱"
          : "Let's explore the timing for your device purchase 📱"
      };
    }
    // 54. 헤어/외모변화 질문
    else if (isHairAppearanceQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → appearance reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "외모 변화 운세",
        userFriendlyExplanation: language === "ko"
          ? "외모 변화와 이미지 전환을 카드로 살펴볼게요 💇"
          : "Let's explore your appearance transformation 💇"
      };
    }
    // 55. 선물/기프트 질문
    else if (isGiftPresentQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → gift reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "선물 운세",
        userFriendlyExplanation: language === "ko"
          ? "선물 선택과 마음 전달을 카드로 살펴볼게요 🎁"
          : "Let's explore the perfect gift choice 🎁"
      };
    }
    // 56. 다이어트/체중관리 질문
    else if (isDietWeightQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → diet reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "well-being-healing",
        spreadId: "inner-peace",
        reason: "다이어트/체중관리 운세",
        userFriendlyExplanation: language === "ko"
          ? "건강한 체중 관리와 다이어트 흐름을 카드로 살펴볼게요 💪"
          : "Let's explore your weight management journey 💪"
      };
    }
    // 57. 외국어/언어학습 질문
    else if (isLanguageLearningQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → language learning reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "언어학습 운세",
        userFriendlyExplanation: language === "ko"
          ? "외국어 학습과 실력 향상을 카드로 살펴볼게요 📚"
          : "Let's explore your language learning path 📚"
      };
    }
    // 58. 운전면허/차량 질문
    else if (isDriverLicenseQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → driving reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "운전/차량 운세",
        userFriendlyExplanation: language === "ko"
          ? "운전과 차량 관련 흐름을 카드로 살펴볼게요 🚗"
          : "Let's explore your driving and vehicle decisions 🚗"
      };
    }
    // 59. 봉사/기부/자선 질문
    else if (isVolunteerCharityQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → volunteer reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "general-insight",
        spreadId: "past-present-future",
        reason: "봉사/기부 운세",
        userFriendlyExplanation: language === "ko"
          ? "나눔과 봉사 활동의 방향을 카드로 살펴볼게요 🤝"
          : "Let's explore your path to giving back 🤝"
      };
    }
    // 60. 커플싸움/화해 질문
    else if (isCoupleFightQuestion(trimmedQuestion)) {
      console.log(`[analyze-question] Correcting: "${trimmedQuestion}" → couple fight reading (was: ${parsed.spreadId})`);
      parsed = {
        themeId: "love-relationships",
        spreadId: "relationship-potential",
        reason: "커플 화해 운세",
        userFriendlyExplanation: language === "ko"
          ? "갈등 해결과 화해의 방향을 카드로 살펴볼게요 💕"
          : "Let's explore how to reconcile and heal 💕"
      };
    }

    // 선택된 스프레드 정보 찾기
    const selectedSpread = spreadOptions.find(
      s => s.themeId === parsed.themeId && s.id === parsed.spreadId
    );

    if (!selectedSpread) {
      // 못 찾으면 기본값
      return NextResponse.json({
        isDangerous: false,
        themeId: "general-insight",
        spreadId: "past-present-future",
        spreadTitle: "과거, 현재, 미래",
        cardCount: 3,
        reason: "일반적인 운세 확인",
        userFriendlyExplanation: language === "ko"
          ? "전반적인 흐름을 볼 수 있는 스프레드를 준비했어요"
          : "I've prepared a spread to see the overall flow",
        path: `/tarot/general-insight/past-present-future?question=${encodeURIComponent(trimmedQuestion)}`,
      });
    }

    return NextResponse.json({
      isDangerous: false,
      themeId: parsed.themeId,
      spreadId: parsed.spreadId,
      spreadTitle: selectedSpread.titleKo,
      cardCount: selectedSpread.cardCount,
      reason: parsed.reason,
      userFriendlyExplanation: parsed.userFriendlyExplanation,
      path: `/tarot/${parsed.themeId}/${parsed.spreadId}?question=${encodeURIComponent(trimmedQuestion)}`,
    });

  } catch (error) {
    console.error("Error analyzing question:", error);
    return NextResponse.json(
      { error: "Failed to analyze question" },
      { status: 500 }
    );
  }
}
