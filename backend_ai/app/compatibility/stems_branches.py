# backend_ai/app/compatibility/stems_branches.py
"""
Heavenly Stems & Earthly Branches Relationships
================================================
천간(天干)과 지지(地支) 관계 상수
합/충/형/해/원진 등
"""

# ===============================================================
# 천간 (Heavenly Stems)
# ===============================================================
HEAVENLY_STEMS = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]

# 천간합 (Heavenly Stem Combinations) - 합이 되면 궁합이 좋음
STEM_COMBINATIONS = {
    ("甲", "己"): {"result": "土", "score": 90, "meaning": "갑기합토(甲己合土) - 서로를 안정시키는 관계"},
    ("乙", "庚"): {"result": "金", "score": 85, "meaning": "을경합금(乙庚合金) - 정의롭고 신뢰로운 관계"},
    ("丙", "辛"): {"result": "水", "score": 88, "meaning": "병신합수(丙辛合水) - 열정과 섬세함의 조화"},
    ("丁", "壬"): {"result": "木", "score": 87, "meaning": "정임합목(丁壬合木) - 성장을 돕는 관계"},
    ("戊", "癸"): {"result": "火", "score": 86, "meaning": "무계합화(戊癸合火) - 따뜻하고 열정적인 관계"},
}

# 천간충 (Heavenly Stem Clashes) - 충이 되면 갈등 가능
STEM_CLASHES = {
    ("甲", "庚"): {"score": -20, "meaning": "갑경충 - 리더십 충돌, 경쟁 관계"},
    ("乙", "辛"): {"score": -15, "meaning": "을신충 - 섬세함과 날카로움의 충돌"},
    ("丙", "壬"): {"score": -18, "meaning": "병임충 - 불과 물의 대립, 감정적 갈등"},
    ("丁", "癸"): {"score": -12, "meaning": "정계충 - 작은 불씨와 큰 물, 주도권 다툼"},
}

# ===============================================================
# 지지 (Earthly Branches)
# ===============================================================
EARTHLY_BRANCHES = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]

# 지지 삼합 (Three Harmonies) - 가장 좋은 조합
BRANCH_SAMHAP = {
    frozenset(["寅", "午", "戌"]): {"element": "火", "score": 95, "meaning": "인오술 화국(火局) - 열정과 리더십의 강력한 시너지"},
    frozenset(["申", "子", "辰"]): {"element": "水", "score": 95, "meaning": "신자진 수국(水局) - 지혜와 소통의 완벽한 조화"},
    frozenset(["亥", "卯", "未"]): {"element": "木", "score": 95, "meaning": "해묘미 목국(木局) - 성장과 창의력의 융합"},
    frozenset(["巳", "酉", "丑"]): {"element": "金", "score": 95, "meaning": "사유축 금국(金局) - 결단력과 실행력의 결합"},
}

# 지지 반합 (Half Harmonies) - 삼합 중 2개만 있을 때
BRANCH_BANHAP = {
    # 화국 반합
    frozenset(["寅", "午"]): {"element": "火", "score": 75, "meaning": "인오 반합 - 화국(火局)의 절반, 열정의 시작"},
    frozenset(["午", "戌"]): {"element": "火", "score": 75, "meaning": "오술 반합 - 화국(火局)의 절반, 리더십 공유"},
    frozenset(["寅", "戌"]): {"element": "火", "score": 70, "meaning": "인술 반합 - 화국(火局) 잠재력"},
    # 수국 반합
    frozenset(["申", "子"]): {"element": "水", "score": 75, "meaning": "신자 반합 - 수국(水局)의 절반, 지혜 교류"},
    frozenset(["子", "辰"]): {"element": "水", "score": 75, "meaning": "자진 반합 - 수국(水局)의 절반, 소통 원활"},
    frozenset(["申", "辰"]): {"element": "水", "score": 70, "meaning": "신진 반합 - 수국(水局) 잠재력"},
    # 목국 반합
    frozenset(["亥", "卯"]): {"element": "木", "score": 75, "meaning": "해묘 반합 - 목국(木局)의 절반, 성장 에너지"},
    frozenset(["卯", "未"]): {"element": "木", "score": 75, "meaning": "묘미 반합 - 목국(木局)의 절반, 창의적 협력"},
    frozenset(["亥", "未"]): {"element": "木", "score": 70, "meaning": "해미 반합 - 목국(木局) 잠재력"},
    # 금국 반합
    frozenset(["巳", "酉"]): {"element": "金", "score": 75, "meaning": "사유 반합 - 금국(金局)의 절반, 결단력"},
    frozenset(["酉", "丑"]): {"element": "金", "score": 75, "meaning": "유축 반합 - 금국(金局)의 절반, 실행력"},
    frozenset(["巳", "丑"]): {"element": "金", "score": 70, "meaning": "사축 반합 - 금국(金局) 잠재력"},
}

# 지지 방합 (Directional Harmonies) - 같은 방위의 3지지
BRANCH_BANGHAP = {
    frozenset(["寅", "卯", "辰"]): {"element": "木", "direction": "東", "score": 88, "meaning": "인묘진 동방합(東方合) - 봄의 에너지, 새로운 시작과 성장"},
    frozenset(["巳", "午", "未"]): {"element": "火", "direction": "南", "score": 88, "meaning": "사오미 남방합(南方合) - 여름의 에너지, 열정과 번영"},
    frozenset(["申", "酉", "戌"]): {"element": "金", "direction": "西", "score": 88, "meaning": "신유술 서방합(西方合) - 가을의 에너지, 결실과 성취"},
    frozenset(["亥", "子", "丑"]): {"element": "水", "direction": "北", "score": 88, "meaning": "해자축 북방합(北方合) - 겨울의 에너지, 지혜와 내면 성찰"},
}

# 방합 반합 (방합 중 2개만 있을 때)
BRANCH_BANGHAP_HALF = {
    # 동방 (木)
    frozenset(["寅", "卯"]): {"element": "木", "score": 65, "meaning": "인묘 - 동방목 잠재력"},
    frozenset(["卯", "辰"]): {"element": "木", "score": 65, "meaning": "묘진 - 동방목 잠재력"},
    # 남방 (火)
    frozenset(["巳", "午"]): {"element": "火", "score": 65, "meaning": "사오 - 남방화 잠재력"},
    frozenset(["午", "未"]): {"element": "火", "score": 65, "meaning": "오미 - 남방화 잠재력"},
    # 서방 (金)
    frozenset(["申", "酉"]): {"element": "金", "score": 65, "meaning": "신유 - 서방금 잠재력"},
    frozenset(["酉", "戌"]): {"element": "金", "score": 65, "meaning": "유술 - 서방금 잠재력"},
    # 북방 (水)
    frozenset(["亥", "子"]): {"element": "水", "score": 65, "meaning": "해자 - 북방수 잠재력"},
    frozenset(["子", "丑"]): {"element": "水", "score": 65, "meaning": "자축 - 북방수 잠재력"},
}

# 지지 육합 (Six Harmonies) - 좋은 조합
BRANCH_YUKHAP = {
    ("子", "丑"): {"result": "土", "score": 88, "meaning": "자축합토 - 깊은 신뢰와 안정"},
    ("寅", "亥"): {"result": "木", "score": 86, "meaning": "인해합목 - 성장을 돕는 파트너"},
    ("卯", "戌"): {"result": "火", "score": 85, "meaning": "묘술합화 - 따뜻한 교감"},
    ("辰", "酉"): {"result": "金", "score": 87, "meaning": "진유합금 - 실용적 협력"},
    ("巳", "申"): {"result": "水", "score": 84, "meaning": "사신합수 - 지적 교류"},
    ("午", "未"): {"result": "土", "score": 88, "meaning": "오미합토 - 열정과 온정의 조화"},
}

# 지지충 (Branch Clashes) - 충돌
BRANCH_CHUNG = {
    ("子", "午"): {"score": -25, "meaning": "자오충 - 감정 vs 이성의 대립"},
    ("丑", "未"): {"score": -20, "meaning": "축미충 - 고집과 고집의 충돌"},
    ("寅", "申"): {"score": -22, "meaning": "인신충 - 행동 방식의 차이"},
    ("卯", "酉"): {"score": -23, "meaning": "묘유충 - 가치관 충돌"},
    ("辰", "戌"): {"score": -18, "meaning": "진술충 - 목표 충돌"},
    ("巳", "亥"): {"score": -20, "meaning": "사해충 - 열정 vs 냉정"},
}

# 지지형 (Branch Punishments) - 해로운 관계
BRANCH_HYUNG = {
    frozenset(["寅", "巳", "申"]): {"score": -15, "meaning": "인사신 삼형 - 은혜를 원수로 갚는 관계 주의"},
    frozenset(["丑", "戌", "未"]): {"score": -12, "meaning": "축술미 삼형 - 고집 충돌, 지지 않으려 함"},
    frozenset(["子", "卯"]): {"score": -10, "meaning": "자묘형 - 무례한 형벌, 예의 없는 관계"},
}

# 지지원진 (Branch Resentment) - 숨은 갈등
BRANCH_WONGJIN = {
    ("子", "未"): {"score": -8, "meaning": "자미 원진 - 숨겨진 불만"},
    ("丑", "午"): {"score": -8, "meaning": "축오 원진 - 표면적 평화, 내면적 갈등"},
    ("寅", "酉"): {"score": -8, "meaning": "인유 원진 - 서로 다른 템포"},
    ("卯", "申"): {"score": -8, "meaning": "묘신 원진 - 의사소통 문제"},
    ("辰", "亥"): {"score": -8, "meaning": "진해 원진 - 기대치 불일치"},
    ("巳", "戌"): {"score": -8, "meaning": "사술 원진 - 열정 vs 안정"},
}

# 지지해 (Branch Harm/害) - 미묘한 불편함, Quincunx(150°)에 해당
BRANCH_HAE = {
    ("子", "未"): {"score": -6, "meaning": "자미해 - 감정과 현실의 괴리", "synastry": "Quincunx aspect"},
    ("丑", "午"): {"score": -6, "meaning": "축오해 - 안정 vs 열정의 부조화", "synastry": "Quincunx aspect"},
    ("寅", "巳"): {"score": -6, "meaning": "인사해 - 행동 방식의 미묘한 차이", "synastry": "Quincunx aspect"},
    ("卯", "辰"): {"score": -6, "meaning": "묘진해 - 유연함 vs 고집", "synastry": "Quincunx aspect"},
    ("申", "亥"): {"score": -6, "meaning": "신해해 - 논리 vs 직관의 불일치", "synastry": "Quincunx aspect"},
    ("酉", "戌"): {"score": -6, "meaning": "유술해 - 섬세함 vs 강직함", "synastry": "Quincunx aspect"},
}

# 12운성(十二運星) 정의
TWELVE_STAGES = ["장생", "목욕", "관대", "건록", "제왕", "쇠", "병", "사", "묘", "절", "태", "양"]

# 12운성 궁합 점수
TWELVE_STAGES_COMPATIBILITY = {
    # 왕성한 운 조합 (장생, 관대, 건록, 제왕)
    ("장생", "장생"): {"score": 10, "meaning": "함께 새롭게 시작하는 관계"},
    ("장생", "제왕"): {"score": 8, "meaning": "성장과 성취의 조화"},
    ("관대", "관대"): {"score": 9, "meaning": "함께 성장하는 관계"},
    ("관대", "건록"): {"score": 10, "meaning": "최고의 에너지 조합"},
    ("건록", "건록"): {"score": 8, "meaning": "안정적이고 든든한 관계"},
    ("건록", "제왕"): {"score": 9, "meaning": "강력한 파트너십"},
    ("제왕", "제왕"): {"score": 7, "meaning": "두 리더의 만남, 경쟁 가능"},

    # 쇠퇴 운 조합 (쇠, 병, 사, 묘)
    ("쇠", "장생"): {"score": 6, "meaning": "한쪽이 다른쪽을 일으킴"},
    ("쇠", "쇠"): {"score": 4, "meaning": "함께 쉬어가는 관계"},
    ("병", "장생"): {"score": 5, "meaning": "치유와 새 시작"},
    ("병", "병"): {"score": 3, "meaning": "서로 돌봐야 함"},
    ("사", "장생"): {"score": 4, "meaning": "종말과 시작의 만남"},
    ("묘", "태"): {"score": 5, "meaning": "끝과 새 시작의 연결"},

    # 잠재운 조합 (절, 태, 양)
    ("절", "장생"): {"score": 6, "meaning": "무에서 유로"},
    ("태", "태"): {"score": 7, "meaning": "함께 잉태하는 관계"},
    ("태", "양"): {"score": 8, "meaning": "성장의 잠재력"},
    ("양", "양"): {"score": 7, "meaning": "함께 성장 준비"},
    ("양", "장생"): {"score": 9, "meaning": "양육과 탄생"},

    # 목욕 관련 (도화)
    ("목욕", "목욕"): {"score": 8, "meaning": "강한 끌림, 바람기 주의"},
    ("목욕", "관대"): {"score": 7, "meaning": "매력과 성장"},
    ("목욕", "제왕"): {"score": 6, "meaning": "매력과 권력"}
}

# 공망(空亡) 정의 - 순 기준
GONGMANG_BY_CYCLE = {
    # 갑자순 (甲子旬): 戌, 亥가 공망
    "甲子": ["戌", "亥"], "乙丑": ["戌", "亥"], "丙寅": ["戌", "亥"], "丁卯": ["戌", "亥"], "戊辰": ["戌", "亥"],
    "己巳": ["戌", "亥"], "庚午": ["戌", "亥"], "辛未": ["戌", "亥"], "壬申": ["戌", "亥"], "癸酉": ["戌", "亥"],
    # 갑술순 (甲戌旬): 申, 酉가 공망
    "甲戌": ["申", "酉"], "乙亥": ["申", "酉"], "丙子": ["申", "酉"], "丁丑": ["申", "酉"], "戊寅": ["申", "酉"],
    "己卯": ["申", "酉"], "庚辰": ["申", "酉"], "辛巳": ["申", "酉"], "壬午": ["申", "酉"], "癸未": ["申", "酉"],
    # 갑신순 (甲申旬): 午, 未가 공망
    "甲申": ["午", "未"], "乙酉": ["午", "未"], "丙戌": ["午", "未"], "丁亥": ["午", "未"], "戊子": ["午", "未"],
    "己丑": ["午", "未"], "庚寅": ["午", "未"], "辛卯": ["午", "未"], "壬辰": ["午", "未"], "癸巳": ["午", "未"],
    # 갑오순 (甲午旬): 辰, 巳가 공망
    "甲午": ["辰", "巳"], "乙未": ["辰", "巳"], "丙申": ["辰", "巳"], "丁酉": ["辰", "巳"], "戊戌": ["辰", "巳"],
    "己亥": ["辰", "巳"], "庚子": ["辰", "巳"], "辛丑": ["辰", "巳"], "壬寅": ["辰", "巳"], "癸卯": ["辰", "巳"],
    # 갑진순 (甲辰旬): 寅, 卯가 공망
    "甲辰": ["寅", "卯"], "乙巳": ["寅", "卯"], "丙午": ["寅", "卯"], "丁未": ["寅", "卯"], "戊申": ["寅", "卯"],
    "己酉": ["寅", "卯"], "庚戌": ["寅", "卯"], "辛亥": ["寅", "卯"], "壬子": ["寅", "卯"], "癸丑": ["寅", "卯"],
    # 갑인순 (甲寅旬): 子, 丑가 공망
    "甲寅": ["子", "丑"], "乙卯": ["子", "丑"], "丙辰": ["子", "丑"], "丁巳": ["子", "丑"], "戊午": ["子", "丑"],
    "己未": ["子", "丑"], "庚申": ["子", "丑"], "辛酉": ["子", "丑"], "壬戌": ["子", "丑"], "癸亥": ["子", "丑"],
}
