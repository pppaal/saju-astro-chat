name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: |
            backend_ai/requirements.txt
            backend_ai/requirements-dev.txt

      - name: Install deps
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder:placeholder@localhost:5432/placeholder' }}

      - name: Verify token encryption
        run: node scripts/verify-token-encryption.js
        env:
          TOKEN_ENCRYPTION_KEY: ${{ secrets.TOKEN_ENCRYPTION_KEY || 'k8Xm9Rv3Pn7Q2wL5sT0uY4bC6dF8gHjWe1' }}

      - name: Env check
        run: npm run check:env
        env:
          # Provide dummy placeholders so check:env only flags missing/placeholder values in CI
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'ci-placeholder-32-characters-long-secret' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}
          NEXTAUTH_COOKIE_DOMAIN: ${{ secrets.NEXTAUTH_COOKIE_DOMAIN || '.example.com' }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }}
          ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN || 'ci-placeholder' }}
          CRON_SECRET: ${{ secrets.CRON_SECRET || 'ci-placeholder' }}
          PUBLIC_METRICS_TOKEN: ${{ secrets.PUBLIC_METRICS_TOKEN || 'ci-metrics-token' }}
          NEXT_PUBLIC_PUBLIC_METRICS_TOKEN: ${{ secrets.NEXT_PUBLIC_PUBLIC_METRICS_TOKEN || 'ci-metrics-token' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgres://user:pass@host/db' }}
          TOKEN_ENCRYPTION_KEY: ${{ secrets.TOKEN_ENCRYPTION_KEY || 'k8Xm9Rv3Pn7Q2wL5sT0uY4bC6dF8gHjWe1' }}
          PUBLIC_API_TOKEN: ${{ secrets.PUBLIC_API_TOKEN || 'ci-placeholder' }}
          NEXT_PUBLIC_API_TOKEN: ${{ secrets.NEXT_PUBLIC_API_TOKEN || 'ci-placeholder' }}
          NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY || 'ci-placeholder' }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY || 'ci-placeholder' }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'resend' }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 'ci-placeholder' }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY || 'ci-placeholder' }}
          SMTP_HOST: ${{ secrets.SMTP_HOST || 'ci-placeholder' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER || 'ci-placeholder' }}
          SMTP_PASS: ${{ secrets.SMTP_PASS || 'ci-placeholder' }}

      - name: Lint
        run: npm run lint

      - name: Mojibake lint
        run: npm run lint:mojibake

      - name: Typecheck
        run: npm run typecheck

      - name: Unit/Integration tests
        run: npm test

      - name: Accessibility axe regression
        run: npm run test:a11y

      - name: Upload coverage to Codecov
        if: hashFiles('coverage/lcov.info') != ''
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false
          verbose: true

      - name: Coverage threshold check
        if: hashFiles('coverage/coverage-summary.json') != ''
        run: |
          # Extract coverage from json-summary and validate against vitest.config.ts thresholds.
          # Thresholds are read from vitest.config.ts (single source of truth) so they never drift.
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
            BRANCHES=$(node -e "console.log(require('./coverage/coverage-summary.json').total.branches.pct)")
            FUNCTIONS=$(node -e "console.log(require('./coverage/coverage-summary.json').total.functions.pct)")
            STATEMENTS=$(node -e "console.log(require('./coverage/coverage-summary.json').total.statements.pct)")

            echo "üìä Coverage Summary:"
            echo "  Lines: ${LINES}%"
            echo "  Branches: ${BRANCHES}%"
            echo "  Functions: ${FUNCTIONS}%"
            echo "  Statements: ${STATEMENTS}%"

            # Read thresholds from vitest.config.ts (single source of truth)
            read MIN_LINES MIN_BRANCHES MIN_FUNCTIONS MIN_STATEMENTS <<< $(npx tsx -e "
              import config from './vitest.config.ts';
              const t = config.test.coverage.thresholds;
              console.log([t.lines, t.branches, t.functions, t.statements].join(' '));
            " 2>/dev/null)

            echo "  Thresholds (from vitest.config.ts): lines=${MIN_LINES}% branches=${MIN_BRANCHES}% functions=${MIN_FUNCTIONS}% statements=${MIN_STATEMENTS}%"

            FAILED=0

            if (( $(echo "$LINES < $MIN_LINES" | bc -l) )); then
              echo "‚ùå Lines coverage ${LINES}% is below threshold ${MIN_LINES}%"
              FAILED=1
            fi

            if (( $(echo "$BRANCHES < $MIN_BRANCHES" | bc -l) )); then
              echo "‚ùå Branches coverage ${BRANCHES}% is below threshold ${MIN_BRANCHES}%"
              FAILED=1
            fi

            if (( $(echo "$FUNCTIONS < $MIN_FUNCTIONS" | bc -l) )); then
              echo "‚ùå Functions coverage ${FUNCTIONS}% is below threshold ${MIN_FUNCTIONS}%"
              FAILED=1
            fi

            if (( $(echo "$STATEMENTS < $MIN_STATEMENTS" | bc -l) )); then
              echo "‚ùå Statements coverage ${STATEMENTS}% is below threshold ${MIN_STATEMENTS}%"
              FAILED=1
            fi

            if [ $FAILED -eq 1 ]; then
              echo ""
              echo "üí° Coverage thresholds not met. Please add more tests."
              exit 1
            else
              echo "‚úÖ All coverage thresholds met!"
            fi
          else
            echo "‚ö†Ô∏è Coverage summary not found"
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Coverage PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('coverage/coverage-summary.json')) {
              console.log('No coverage summary found');
              return;
            }

            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;

            const getIcon = (pct, threshold) => pct >= threshold ? '‚úÖ' : '‚ùå';

            // Read thresholds from vitest.config.ts (single source of truth)
            const { execSync } = require('child_process');
            const raw = execSync(
              `npx tsx -e "import c from './vitest.config.ts'; const t = c.test.coverage.thresholds; console.log(JSON.stringify({lines:t.lines,branches:t.branches,functions:t.functions,statements:t.statements}))"`,
              { encoding: 'utf8', stdio: ['pipe', 'pipe', 'ignore'] }
            ).trim();
            const thresholds = JSON.parse(raw);

            // Check for backend coverage
            let backendSection = '';
            if (fs.existsSync('backend_ai/coverage/coverage.json')) {
              const backendCov = JSON.parse(fs.readFileSync('backend_ai/coverage/coverage.json', 'utf8'));
              const backendPct = backendCov.totals.percent_covered;
              backendSection = `
            ### Backend (Python)
            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | Total | ${backendPct.toFixed(2)}% | 80% | ${getIcon(backendPct, 80)} |
            `;
            }

            const body = `## üìä Coverage Report

            ### Frontend (TypeScript)
            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | Lines | ${total.lines.pct.toFixed(2)}% | ${thresholds.lines}% | ${getIcon(total.lines.pct, thresholds.lines)} |
            | Branches | ${total.branches.pct.toFixed(2)}% | ${thresholds.branches}% | ${getIcon(total.branches.pct, thresholds.branches)} |
            | Functions | ${total.functions.pct.toFixed(2)}% | ${thresholds.functions}% | ${getIcon(total.functions.pct, thresholds.functions)} |
            | Statements | ${total.statements.pct.toFixed(2)}% | ${thresholds.statements}% | ${getIcon(total.statements.pct, thresholds.statements)} |
            ${backendSection}
            <details>
            <summary>Frontend Coverage Details</summary>

            - **Lines**: ${total.lines.covered}/${total.lines.total} covered
            - **Branches**: ${total.branches.covered}/${total.branches.total} covered
            - **Functions**: ${total.functions.covered}/${total.functions.total} covered
            - **Statements**: ${total.statements.covered}/${total.statements.total} covered

            </details>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('üìä Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend_ai/requirements.txt -r backend_ai/requirements-dev.txt

      - name: Backend AI tests (best-effort)
        id: backend_tests
        continue-on-error: true
        run: |
          cd backend_ai
          python -m pytest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-ci-placeholder' }}
          ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN || 'ci-placeholder' }}
          PUBLIC_API_TOKEN: ${{ secrets.PUBLIC_API_TOKEN || 'ci-placeholder' }}
          PUBLIC_METRICS_TOKEN: ${{ secrets.PUBLIC_METRICS_TOKEN || 'ci-metrics-token' }}

      - name: Upload backend coverage to Codecov
        if: hashFiles('backend_ai/coverage/coverage.json') != ''
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./backend_ai/coverage/coverage.json
          flags: backend
          fail_ci_if_error: false

      - name: Upload backend coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: backend_ai/coverage/
          retention-days: 30

      - name: Backend coverage threshold check
        if: steps.backend_tests.outcome == 'success' && hashFiles('backend_ai/coverage/coverage.json') != ''
        run: |
          if [ -f backend_ai/coverage/coverage.json ]; then
            TOTAL=$(python3 -c "import json; d=json.load(open('backend_ai/coverage/coverage.json')); print(d['totals']['percent_covered'])")
            echo "üìä Backend Coverage: ${TOTAL}%"

            MIN_COVERAGE=80
            if (( $(echo "$TOTAL < $MIN_COVERAGE" | bc -l) )); then
              echo "‚ùå Backend coverage ${TOTAL}% is below threshold ${MIN_COVERAGE}%"
              exit 1
            else
              echo "‚úÖ Backend coverage threshold met!"
            fi
          else
            echo "‚ö†Ô∏è Backend coverage report not found"
          fi

      - name: Build
        run: npm run build
        env:
          TOKEN_ENCRYPTION_KEY: ${{ secrets.TOKEN_ENCRYPTION_KEY || 'k8Xm9Rv3Pn7Q2wL5sT0uY4bC6dF8gHjWe1' }}

      - name: SSR placeholder regression gate
        run: |
          nohup npm run start -- -p 3000 > .next-start.log 2>&1 &
          SERVER_PID=$!

          for i in {1..60}; do
            if curl -fsS http://localhost:3000 >/dev/null; then
              break
            fi
            sleep 2
          done

          if ! curl -fsS http://localhost:3000 >/dev/null; then
            echo "Server did not become ready in time"
            tail -n 200 .next-start.log || true
            kill $SERVER_PID || true
            exit 1
          fi

          if ! npm run -s test:ssr-placeholders; then
            tail -n 200 .next-start.log || true
            kill $SERVER_PID || true
            exit 1
          fi

          if ! npm run -s test:mojibake:smoke; then
            tail -n 200 .next-start.log || true
            kill $SERVER_PID || true
            exit 1
          fi

          kill $SERVER_PID || true

      - name: Bundle size check
        run: |
          echo "üì¶ Checking bundle sizes..."

          # Find main bundle (pages or app directory)
          MAIN_BUNDLE=$(find .next/static/chunks -name 'main-*.js' -o -name 'app-pages-*.js' | head -1)

          if [ -n "$MAIN_BUNDLE" ]; then
            MAIN_SIZE=$(stat -c%s "$MAIN_BUNDLE" 2>/dev/null || stat -f%z "$MAIN_BUNDLE" 2>/dev/null || echo "0")
            MAIN_SIZE_KB=$((MAIN_SIZE / 1024))
            echo "  Main bundle: ${MAIN_SIZE_KB}KB"

            # Main bundle threshold: 1500KB
            if [ "$MAIN_SIZE" -gt 1536000 ]; then
              echo "‚ùå Main bundle too large: ${MAIN_SIZE_KB}KB (max: 1500KB)"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Main bundle not found (might be app directory structure)"
          fi

          # Check total page JS size
          TOTAL_JS_SIZE=$(find .next/static/chunks -name '*.js' -exec stat -c%s {} + 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          TOTAL_JS_SIZE_KB=$((TOTAL_JS_SIZE / 1024))
          echo "  Total JS: ${TOTAL_JS_SIZE_KB}KB"

          # Total threshold: 12MB
          if [ "$TOTAL_JS_SIZE" -gt 12582912 ]; then
            echo "‚ùå Total JS bundle too large: ${TOTAL_JS_SIZE_KB}KB (max: 12288KB)"
            exit 1
          fi

          echo "‚úÖ Bundle size check passed"

      - name: Start dev server
        run: |
          npm run dev -- --hostname 127.0.0.1 --port 3000 > /tmp/next-dev.log 2>&1 &
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_BASE_URL: http://localhost:3000
          CRON_SECRET: ci-cron-secret
          PUBLIC_METRICS_TOKEN: ci-metrics-token

      - name: E2E API tests
        run: npm run test:e2e:api
        env:
          API_BASE_URL: http://localhost:3000
          CRON_SECRET: ci-cron-secret
          PUBLIC_METRICS_TOKEN: ci-metrics-token
