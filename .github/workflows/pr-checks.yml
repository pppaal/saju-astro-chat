name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Prevent multiple runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Quick validation checks that run first
  quick-checks:
    name: Quick Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder:placeholder@localhost:5432/placeholder' }}

      - name: Verify API audit report
        run: |
          npm run audit:api
          git diff --exit-code docs/API_AUDIT_REPORT.md

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: ]]; then
            echo "::error::PR title must follow conventional commit format"
            echo "Examples: feat: add new feature, fix: resolve bug, docs: update readme"
            exit 1
          fi

      - name: Check for large files
        run: |
          # Check for files larger than 1MB in the PR
          git diff --name-only origin/${{ github.base_ref }}...HEAD | while read file; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file")
              if [ $SIZE -gt 1048576 ]; then
                echo "::warning::Large file detected: $file ($(($SIZE / 1024))KB)"
              fi
            fi
          done

      - name: Check for console logs
        run: |
          # Check for console.log statements in changed files (ERROR, not warning)
          FOUND=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Skip logger implementation and scripts
              if [[ "$file" =~ src/lib/logger/ ]] || [[ "$file" =~ ^scripts/ ]]; then
                continue
              fi

              # Check for console statements (exclude comments)
              if grep -n "console\.log\|console\.debug" "$file" | grep -v "// @ts-expect-error console" | grep -v "/\* .* console"; then
                echo "::error file=$file::Console statements found. Use logger instead."
                FOUND=1
              fi
            fi
          done < <(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx)$')

          if [ $FOUND -eq 1 ]; then
            echo "‚ùå Remove console statements or use logger instead:"
            echo "   import { logger } from '@/lib/logger';"
            echo "   logger.info('message', { data });"
            exit 1
          fi
          echo "‚úÖ No console statements found"

      - name: Lint changed files
        run: |
          # Only lint files changed in this PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ')
          if [ -n "$CHANGED_FILES" ]; then
            npx eslint $CHANGED_FILES
          else
            echo "No JavaScript/TypeScript files changed"
          fi

  # Test matrix for comprehensive coverage
  test-matrix:
    name: Tests (${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    needs: quick-checks
    if: github.event.pull_request.draft == false

    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - unit
          - integration

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python
        if: matrix.test-suite == 'integration'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip
          cache-dependency-path: |
            backend_ai/requirements.txt
            backend_ai/requirements-dev.txt

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder:placeholder@localhost:5432/placeholder' }}

      - name: Run unit tests
        if: matrix.test-suite == 'unit'
        run: npm test

      - name: Run integration tests
        if: matrix.test-suite == 'integration'
        run: |
          python -m pip install --upgrade pip
          pip install -r backend_ai/requirements.txt -r backend_ai/requirements-dev.txt
          python backend_ai/tools/validate_graph_data.py
          npm run test:integration
          npm run test:backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgres://user:pass@host/db' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-ci-placeholder' }}

  # Build verification
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: quick-checks
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder:placeholder@localhost:5432/placeholder' }}

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          TOKEN_ENCRYPTION_KEY: ${{ secrets.TOKEN_ENCRYPTION_KEY || 'k8Xm9Rv3Pn7Q2wL5sT0uY4bC6dF8gHjWe1' }}

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "Build size: $BUILD_SIZE"
          echo "::notice::Production build size: $BUILD_SIZE"

      - name: Bundle size budget check
        run: |
          # Budget: max JS size per page (First Load JS) = 500KB
          PAGE_BUDGET_KB=500
          # Budget: total static JS = 20MB
          TOTAL_BUDGET_KB=20480
          # Budget: individual chunk size
          CHUNK_FAIL_KB=200    # Fail if any chunk exceeds this
          CHUNK_WARN_KB=150    # Warn if any chunk exceeds this
          FAILED=0

          # Check total static JS size
          STATIC_DIR=".next/static"
          if [ -d "$STATIC_DIR" ]; then
            TOTAL_JS_KB=$(find "$STATIC_DIR" -name "*.js" -exec du -k {} + | awk '{sum+=$1} END {print sum}')
            echo "Total static JS: ${TOTAL_JS_KB}KB (budget: ${TOTAL_BUDGET_KB}KB)"
            if [ "$TOTAL_JS_KB" -gt "$TOTAL_BUDGET_KB" ]; then
              echo "::error::Total static JS (${TOTAL_JS_KB}KB) exceeds budget (${TOTAL_BUDGET_KB}KB)"
              FAILED=1
            fi
          fi

          # Check individual chunk sizes
          if [ -d "$STATIC_DIR/chunks" ]; then
            echo ""
            echo "=== Chunk size check ==="

            # Fail on chunks > 200KB
            while IFS= read -r line; do
              size=$(echo "$line" | awk '{print $1}')
              file=$(echo "$line" | awk '{print $2}')
              if [ -n "$size" ] && [ "$size" -gt "$CHUNK_FAIL_KB" ]; then
                echo "::error::Chunk exceeds ${CHUNK_FAIL_KB}KB limit: $(basename $file) (${size}KB)"
                FAILED=1
              fi
            done < <(find "$STATIC_DIR/chunks" -name "*.js" -exec du -k {} + | sort -rn)

            # Warn on chunks > 150KB (but < 200KB)
            while IFS= read -r line; do
              size=$(echo "$line" | awk '{print $1}')
              file=$(echo "$line" | awk '{print $2}')
              if [ -n "$size" ] && [ "$size" -gt "$CHUNK_WARN_KB" ] && [ "$size" -le "$CHUNK_FAIL_KB" ]; then
                echo "::warning::Large chunk approaching limit: $(basename $file) (${size}KB)"
              fi
            done < <(find "$STATIC_DIR/chunks" -name "*.js" -exec du -k {} + | sort -rn)
          fi

          # Parse Next.js build output for page sizes if available
          if [ -f ".next/trace" ]; then
            echo ""
            echo "=== Build trace available ==="
          fi

          if [ $FAILED -eq 1 ]; then
            echo "::error::Bundle size budget exceeded. Run 'npm run build:analyze' locally to investigate."
            exit 1
          fi

          echo "::notice::Bundle size check passed"

  # Security checks
  security-check:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quick-checks
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder:placeholder@localhost:5432/placeholder' }}

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        run: |
          # Check changed files for potential secrets
          FOUND=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              if grep -rE "(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|-----BEGIN.*PRIVATE KEY-----)" "$file"; then
                echo "::error::Potential secret found in $file"
                FOUND=1
              fi
            fi
          done < <(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          if [ $FOUND -eq 1 ]; then
            exit 1
          fi

  # Coverage report
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test-matrix
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder:placeholder@localhost:5432/placeholder' }}

      - name: Generate coverage
        run: npm run test:coverage

      - name: Comment PR with coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('./coverage/coverage-summary.json')) {
              console.log('No coverage report found');
              return;
            }

            const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;

            const formatPct = (pct) => {
              if (pct >= 80) return `üü¢ ${pct}%`;
              if (pct >= 60) return `üü° ${pct}%`;
              return `üî¥ ${pct}%`;
            };

            const comment = `## üìä Test Coverage Report

            | Metric | Coverage | Covered | Total |
            |--------|----------|---------|-------|
            | Lines | ${formatPct(total.lines.pct)} | ${total.lines.covered} | ${total.lines.total} |
            | Statements | ${formatPct(total.statements.pct)} | ${total.statements.covered} | ${total.statements.total} |
            | Functions | ${formatPct(total.functions.pct)} | ${total.functions.covered} | ${total.functions.total} |
            | Branches | ${formatPct(total.branches.pct)} | ${total.branches.covered} | ${total.branches.total} |

            **Overall Coverage:** ${total.lines.pct >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} ${total.lines.pct}% (Target: 80%)

            ${total.lines.pct < 80 ? '> ‚ö†Ô∏è Coverage is below the 80% threshold. Please add more tests.' : ''}

            ---
            <sub>Updated for commit ${context.sha.substring(0, 7)}</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üìä Test Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  # PR summary status
  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [quick-checks, test-matrix, build-check, security-check, coverage]
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: Check all job statuses
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'Quick Checks': '${{ needs.quick-checks.result }}',
              'Tests': '${{ needs.test-matrix.result }}',
              'Build': '${{ needs.build-check.result }}',
              'Security': '${{ needs.security-check.result }}',
              'Coverage': '${{ needs.coverage.result }}'
            };

            const failed = Object.entries(jobs).filter(([_, status]) => status === 'failure');
            const passed = Object.entries(jobs).filter(([_, status]) => status === 'success');

            let summary = '## üîç PR Check Summary\n\n';

            if (failed.length === 0) {
              summary += '### ‚úÖ All checks passed!\n\n';
              summary += 'This PR is ready for review.\n\n';
            } else {
              summary += '### ‚ùå Some checks failed\n\n';
              summary += 'Please fix the following before merging:\n\n';
              failed.forEach(([name, _]) => {
                summary += `- ‚ùå ${name}\n`;
              });
              summary += '\n';
            }

            summary += '#### Status Details:\n\n';
            Object.entries(jobs).forEach(([name, status]) => {
              const emoji = status === 'success' ? '‚úÖ' : status === 'failure' ? '‚ùå' : '‚è≠Ô∏è';
              summary += `- ${emoji} ${name}: ${status}\n`;
            });

            console.log(summary);

            if (failed.length > 0) {
              core.setFailed(`${failed.length} check(s) failed`);
            }
