<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar Caching Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    .test-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.3rem;
    }

    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .log {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
    }

    .log-hit {
      background: rgba(34, 197, 94, 0.2);
      border-left: 4px solid #22c55e;
      color: #166534;
    }

    .log-miss {
      background: rgba(239, 68, 68, 0.2);
      border-left: 4px solid #ef4444;
      color: #991b1b;
    }

    .log-info {
      background: rgba(59, 130, 246, 0.2);
      border-left: 4px solid #3b82f6;
      color: #1e40af;
    }

    .log-success {
      background: rgba(34, 197, 94, 0.2);
      border-left: 4px solid #22c55e;
      color: #166534;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cache-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 6px;
      color: #22c55e;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 10px;
    }

    .storage-info {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .storage-info h3 {
      color: #374151;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .storage-item {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 5px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš¡ Destiny Calendar Caching Test</h1>

    <div class="test-section">
      <h2>ìºì‹± ì‹œë®¬ë ˆì´ì…˜</h2>
      <p style="color: #666; margin-bottom: 20px;">
        ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìºì‹œ ë™ì‘ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”. ê°™ì€ í‚¤ë¥¼ ë‘ ë²ˆ í˜¸ì¶œí•˜ë©´ ìºì‹œ íˆíŠ¸!
      </p>

      <button onclick="testCache('2025', 'career')">2025ë…„ Career</button>
      <button onclick="testCache('2025', 'health')">2025ë…„ Health</button>
      <button onclick="testCache('2026', 'career')">2026ë…„ Career</button>
      <button onclick="testCache('2025', 'all')">2025ë…„ All</button>
      <button onclick="clearAllCache()" style="background: #ef4444;">ìºì‹œ ì „ì²´ ì‚­ì œ</button>
      <button onclick="clearOldCache()" style="background: #f59e0b;">ë§Œë£Œ ìºì‹œ ì‚­ì œ</button>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="hitCount">0</div>
          <div class="stat-label">Cache Hits</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="missCount">0</div>
          <div class="stat-label">Cache Misses</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="hitRate">0%</div>
          <div class="stat-label">Hit Rate</div>
        </div>
      </div>

      <div class="log" id="log"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ“¦ localStorage ìƒíƒœ</h2>
      <button onclick="showStorage()">ìºì‹œ í•­ëª© ë³´ê¸°</button>
      <button onclick="simulateExpiry()" style="background: #f59e0b;">ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜</button>
      <div class="storage-info" id="storageInfo"></div>
    </div>
  </div>

  <script>
    // ìºì‹± ì„¤ì •
    const CACHE_VERSION = 'v1';
    const CACHE_EXPIRY_DAYS = 30;

    // í†µê³„
    let hitCount = 0;
    let missCount = 0;

    // ìºì‹œ í‚¤ ìƒì„±
    function getCacheKey(year, category) {
      const birthInfo = '1990-01-01_14:30_Seoul'; // í…ŒìŠ¤íŠ¸ìš© ê³ ì •ê°’
      return `calendar_${birthInfo}_${year}_${category}`;
    }

    // ìºì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function getCachedData(cacheKey) {
      try {
        const cached = localStorage.getItem(cacheKey);
        if (!cached) return null;

        const parsed = JSON.parse(cached);

        // ë²„ì „ ì²´í¬
        if (parsed.version !== CACHE_VERSION) {
          localStorage.removeItem(cacheKey);
          return null;
        }

        // ë§Œë£Œ ì²´í¬
        const now = Date.now();
        const expiryMs = CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
        if (now - parsed.timestamp > expiryMs) {
          localStorage.removeItem(cacheKey);
          return null;
        }

        return parsed.data;
      } catch (err) {
        console.error('Failed to get cached data:', err);
        return null;
      }
    }

    // ìºì‹œ ë°ì´í„° ì €ì¥
    function setCachedData(cacheKey, year, category, data) {
      try {
        const cacheData = {
          version: CACHE_VERSION,
          timestamp: Date.now(),
          year,
          category,
          data,
        };

        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
      } catch (err) {
        console.error('Failed to set cached data:', err);
        // Quota exceeded - ì˜¤ë˜ëœ ìºì‹œ ì‚­ì œ
        clearOldCache();
        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
      }
    }

    // ì˜¤ë˜ëœ ìºì‹œ ì‚­ì œ
    function clearOldCache() {
      try {
        const now = Date.now();
        const keys = Object.keys(localStorage);
        const calendarKeys = keys.filter(k => k.startsWith('calendar_'));

        let deletedCount = 0;
        calendarKeys.forEach(key => {
          try {
            const cached = localStorage.getItem(key);
            if (!cached) return;

            const parsed = JSON.parse(cached);
            const expiryMs = CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            if (now - parsed.timestamp > expiryMs) {
              localStorage.removeItem(key);
              deletedCount++;
            }
          } catch {
            localStorage.removeItem(key);
            deletedCount++;
          }
        });

        addLog(`âœ… ${deletedCount}ê°œì˜ ë§Œë£Œëœ ìºì‹œ ì‚­ì œë¨`, 'success');
      } catch (err) {
        console.error('Failed to clear old cache:', err);
      }
    }

    // ìºì‹œ í…ŒìŠ¤íŠ¸
    function testCache(year, category) {
      const cacheKey = getCacheKey(year, category);
      const cachedData = getCachedData(cacheKey);

      if (cachedData) {
        // Cache HIT
        hitCount++;
        addLog(`âš¡ Cache HIT! ğŸ¯ | ${year}ë…„ ${category} (${Math.floor(Math.random() * 5)}ms)`, 'hit');
      } else {
        // Cache MISS - ê°€ì§œ API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
        missCount++;
        addLog(`âŒ Cache MISS | ${year}ë…„ ${category} - API í˜¸ì¶œ ì¤‘...`, 'miss');

        setTimeout(() => {
          const fakeData = {
            year,
            category,
            days: Array.from({ length: 365 }, (_, i) => ({
              date: `${year}-01-${String(i + 1).padStart(2, '0')}`,
              score: Math.floor(Math.random() * 100),
            }))
          };

          setCachedData(cacheKey, year, category, fakeData);
          addLog(`âœ… ë°ì´í„° ìºì‹œë¨ | ${year}ë…„ ${category} (${1500 + Math.floor(Math.random() * 500)}ms)`, 'success');
        }, 500);
      }

      updateStats();
    }

    // ì „ì²´ ìºì‹œ ì‚­ì œ
    function clearAllCache() {
      const keys = Object.keys(localStorage);
      const calendarKeys = keys.filter(k => k.startsWith('calendar_'));

      calendarKeys.forEach(key => localStorage.removeItem(key));

      addLog(`ğŸ—‘ï¸ ${calendarKeys.length}ê°œì˜ ìºì‹œ í•­ëª© ì‚­ì œë¨`, 'info');

      // í†µê³„ ì´ˆê¸°í™”
      hitCount = 0;
      missCount = 0;
      updateStats();
    }

    // ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜
    function simulateExpiry() {
      const keys = Object.keys(localStorage);
      const calendarKeys = keys.filter(k => k.startsWith('calendar_'));

      if (calendarKeys.length === 0) {
        addLog('âš ï¸ ìºì‹œëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
      }

      // ì²« ë²ˆì§¸ ìºì‹œ í•­ëª©ì„ 31ì¼ ì „ìœ¼ë¡œ ë³€ê²½
      const key = calendarKeys[0];
      const cached = JSON.parse(localStorage.getItem(key));
      cached.timestamp = Date.now() - (31 * 24 * 60 * 60 * 1000);
      localStorage.setItem(key, JSON.stringify(cached));

      addLog(`â° "${key}" í•­ëª©ì„ 31ì¼ ì „ìœ¼ë¡œ ë³€ê²½ (ë§Œë£Œë¨)`, 'info');
    }

    // localStorage ìƒíƒœ ë³´ê¸°
    function showStorage() {
      const keys = Object.keys(localStorage);
      const calendarKeys = keys.filter(k => k.startsWith('calendar_'));

      const storageInfo = document.getElementById('storageInfo');

      if (calendarKeys.length === 0) {
        storageInfo.innerHTML = '<div class="storage-item">ìºì‹œëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = `<h3>ğŸ“¦ ìºì‹œ í•­ëª© (${calendarKeys.length}ê°œ)</h3>`;

      calendarKeys.forEach((key, index) => {
        try {
          const cached = JSON.parse(localStorage.getItem(key));
          const age = Math.floor((Date.now() - cached.timestamp) / (1000 * 60 * 60 * 24));
          const isExpired = age > CACHE_EXPIRY_DAYS;

          html += `
            <div class="storage-item" style="${isExpired ? 'color: #ef4444;' : ''}">
              ${index + 1}. ${cached.year}ë…„ ${cached.category}
              (${age}ì¼ ì „${isExpired ? ' - ë§Œë£Œë¨' : ''})
            </div>
          `;
        } catch (err) {
          html += `<div class="storage-item" style="color: #ef4444;">${index + 1}. ${key} (íŒŒì‹± ì˜¤ë¥˜)</div>`;
        }
      });

      storageInfo.innerHTML = html;
    }

    // ë¡œê·¸ ì¶”ê°€
    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.insertBefore(entry, log.firstChild);

      // ìµœëŒ€ 50ê°œ í•­ëª©ë§Œ ìœ ì§€
      while (log.children.length > 50) {
        log.removeChild(log.lastChild);
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
      const total = hitCount + missCount;
      const hitRate = total > 0 ? Math.round((hitCount / total) * 100) : 0;

      document.getElementById('hitCount').textContent = hitCount;
      document.getElementById('missCount').textContent = missCount;
      document.getElementById('totalCount').textContent = total;
      document.getElementById('hitRate').textContent = hitRate + '%';
    }

    // ì´ˆê¸° ë¡œê·¸
    addLog('âš¡ ìºì‹± ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ', 'info');
  </script>
</body>
</html>
